apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-keyless-images
  annotations:
    policies.kyverno.io/title: Enforce Cosign keyless provenance
    policies.kyverno.io/description: >
      Deny workloads unless container images are signed with keyless Cosign certificates
      issued by GitHub Actions OIDC and recorded in Rekor. Applies to Deployments, StatefulSets,
      DaemonSets, Jobs, and CronJobs that reference ghcr.io images.
spec:
  validationFailureAction: Enforce
  background: false
  failurePolicy: Fail
  rules:
    - name: require-keyless-cosign
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
      verifyImages:
        - imageReferences:
            - ghcr.io/jguida941/ci-cd-bst-demo-github-actions*
          attestors:
            - entries:
                - keyless:
                    issuer: https://token.actions.githubusercontent.com
                    subject: https://github.com/jguida941/ci-cd-bst-demo-github-actions/.github/workflows/*
                    rekor:
                      url: https://rekor.sigstore.dev
          mutateDigest: true
