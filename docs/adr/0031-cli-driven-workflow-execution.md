# ADR-0031: CLI-Driven Workflow Execution (Thin Workflows)

**Status**: Accepted  
**Date:** 2025-12-26  
**Developer:** Justin Guida  
**Last Reviewed:** 2025-12-30  

## Context

Reusable workflows have grown large due to inline scripting for parsing,
threshold enforcement, report generation, and summary rendering. This created:

- 1,000+ line workflows with duplicated logic across Python, Java, and hub-run-all
- Fragile inline bash parsing that is hard to test or reuse
- Complexity driven by workflow input limits and multi-layer config resolution
- Poor fit for the planned PyQt6 GUI, which must call a stable CLI API

We already have a CLI (`cihub`) and a JSON output contract. The CLI is the
natural place to own execution logic, validation, and report generation.

## Decision

Make **`cihub` the workflow execution engine**. Workflows become thin wrappers
that install `cihub` and run a single command that:

- Reads `.ci-hub.yml` (source of truth)
- Runs only enabled tools
- Applies thresholds
- Generates `report.json` and the unified summary

### Rationale

- Workflows must be small and consistent across Java, Python, and hub-run-all.
- Logic belongs in testable, reusable code (CLI), not inline bash blocks.
- The GUI needs a stable automation API; the CLI is that API.

### Standard Pattern

Reusable workflows (`python-ci.yml`, `java-ci.yml`) should follow this shape:

```yaml
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-python@v5
  - run: pip install cihub
  - run: cihub ci --correlation-id "${{ inputs.hub_correlation_id }}"
  - uses: actions/upload-artifact@v4
    with:
      name: ci-report
      path: .cihub/report.json
```

The orchestrator dispatches only a minimal correlation ID; per-repo behavior is
driven by `.ci-hub.yml`.

### Scope Notes

- GitHub-specific actions (CodeQL, Trivy) may remain as actions, but parsing and
  report aggregation move into `cihub`.
- The workflow summary format is unified and generated by the CLI.

### CLI Command Surface (Minimum for CI Execution)

These commands are required for the thin workflow model:

- `cihub ci` - Run all enabled tools, apply thresholds, write report + summary.
- `cihub run <tool>` - Run a single tool and emit JSON output for aggregation.
- `cihub report build` - Build `report.json` from tool outputs.
- `cihub report summary` - Render the unified summary (Markdown).

### Dependency Strategy

- Base install remains small: `pyyaml`, `jsonschema`, `defusedxml`.
- Provide an optional extra for CI tooling: `cihub[ci]`.
- Workflows should install `cihub[ci]` (or allow `cihub ci --install-tools`).
- Java relies on Maven/Gradle wrappers; Python tools installed via extras
  (e.g., pytest/pytest-cov, ruff, black, isort, mypy, bandit, pip-audit,
  mutmut, hypothesis).

## Consequences

**Positive:**
- Dramatically smaller workflows with consistent behavior
- Single, testable implementation of parsing and report logic
- Enables the PyQt6 GUI to reuse CLI logic (no log scraping)
- Removes drift between Python/Java/hub-run-all reporting

**Negative:**
- Requires distributing and versioning the CLI for workflows
- Adds dependency install time in workflows
- Requires clear CLI version pinning strategy

## Alternatives Considered

1. **Keep inline scripts in workflows**
   - Rejected: too large, brittle, and hard to test.

2. **Composite actions for parsing**
   - Rejected: reduces duplication but still keeps logic in GitHub-specific YAML.

3. **Marketplace actions**
   - Rejected: loss of control and inconsistent output formats.

4. **Central-only execution (hub-run-all)**
   - Rejected: does not satisfy distributed mode or per-repo autonomy.

## References

- ADR-0014: Reusable Workflow Migration
- ADR-0024: Workflow Dispatch Input Limit
- ADR-0029: CLI Exit Code Registry
- `docs/development/archive/ARCHITECTURE_PLAN.md` (Phase 9 GUI)

## Update (2025-12-30)

- Repo callers now target the `hub-ci.yml` wrapper workflow as the single entrypoint.
- `python-ci.yml`/`java-ci.yml` remain internal to the hub and are invoked by the wrapper.
