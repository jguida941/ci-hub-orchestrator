name: sign-existing-digest

on:
  workflow_dispatch:
    inputs:
      digest:
        description: "Image digest to sign (sha256:....)"
        required: true
      image:
        description: "Image reference without digest (default: ghcr.io/<owner>/ci-intel-app)"
        required: false
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  sign:
    runs-on: ubuntu-22.04
    env:
      DEFAULT_IMAGE: ghcr.io/${{ github.repository_owner }}/ci-intel-app
      COSIGN_EXPERIMENTAL: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Resolve image reference
        id: resolve
        run: |
          set -euo pipefail
          image_input="${{ github.event.inputs.image }}"
          if [[ -z "$image_input" ]]; then
            image_input="$DEFAULT_IMAGE"
          fi
          digest="${{ github.event.inputs.digest }}"
          if [[ "$digest" != sha256:* ]]; then
            echo "Digest must include sha256: prefix (got '$digest')" >&2
            exit 1
          fi
          echo "IMAGE_BASE=$image_input" >> "$GITHUB_ENV"
          echo "IMAGE_DIGEST=$digest" >> "$GITHUB_ENV"

      - name: Install registry tooling
        run: |
          set -euo pipefail
          ./scripts/install_tools.sh

      - name: Login to registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign digest with cosign
        run: |
          set -euo pipefail
          image_ref="${IMAGE_BASE%@*}@${IMAGE_DIGEST}"
          echo "[sign-existing-digest] Signing ${image_ref}"
          cosign sign --yes "${image_ref}"

      - name: Run Rekor monitor
        run: |
          set -euo pipefail
          mkdir -p artifacts/evidence
          ./tools/rekor_monitor.sh "${IMAGE_DIGEST}" "${IMAGE_BASE}" artifacts/evidence

      - name: Upload evidence bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: manual-signing-evidence
          path: artifacts/evidence
