name: sign-existing-digest

on:
  workflow_dispatch:
    inputs:
      digest:
        description: "Image digest to sign (sha256:....)"
        required: true
      image:
        description: "Image reference without digest (default: ghcr.io/<owner>/ci-intel-app)"
        required: false
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  sign:
    runs-on: ubuntu-22.04
    env:
      DEFAULT_IMAGE: ghcr.io/${{ github.repository_owner }}/ci-intel-app
      COSIGN_EXPERIMENTAL: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Resolve image reference
        id: resolve
        run: |
          set -euo pipefail

          # Validate and sanitize image input to prevent command injection
          image_input="${{ github.event.inputs.image }}"
          if [[ -z "$image_input" ]]; then
            image_input="$DEFAULT_IMAGE"
          fi

          # Validate image reference format (allow only safe characters)
          if ! [[ "$image_input" =~ ^[a-zA-Z0-9._/:@-]+$ ]]; then
            echo "ERROR: Invalid image reference format" >&2
            echo "Must contain only: alphanumeric, '.', '_', '/', ':', '@', '-'" >&2
            exit 1
          fi

          # Prevent command injection patterns
          if [[ "$image_input" =~ [\$\`\;\|\&\>\<\(\)\{\}\[\]\'\"\\\n\r] ]]; then
            echo "ERROR: Image reference contains forbidden characters" >&2
            exit 1
          fi

          # Validate digest input
          digest="${{ github.event.inputs.digest }}"

          # Strict validation: must be exactly sha256: followed by 64 hex chars
          if ! [[ "$digest" =~ ^sha256:[a-f0-9]{64}$ ]]; then
            echo "ERROR: Invalid digest format" >&2
            echo "Must be: sha256: followed by exactly 64 lowercase hex characters" >&2
            echo "Got: '$digest'" >&2
            exit 1
          fi

          # Export validated values
          echo "IMAGE_BASE=$image_input" >> "$GITHUB_ENV"
          echo "IMAGE_DIGEST=$digest" >> "$GITHUB_ENV"

      - name: Install registry tooling
        run: |
          set -euo pipefail
          ./scripts/install_tools.sh

      - name: Login to registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign digest with cosign
        run: |
          set -euo pipefail
          # Use validated environment variables with proper quoting
          image_ref="${IMAGE_BASE%@*}@${IMAGE_DIGEST}"
          echo "[sign-existing-digest] Signing ${image_ref}"

          # Ensure proper quoting to prevent injection
          cosign sign --yes -- "${image_ref}"

      - name: Run Rekor monitor
        run: |
          set -euo pipefail
          mkdir -p artifacts/evidence

          # Pass validated variables with proper quoting
          ./tools/rekor_monitor.sh "${IMAGE_DIGEST}" "${IMAGE_BASE}" artifacts/evidence

      - name: Upload evidence bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: manual-signing-evidence
          path: artifacts/evidence
