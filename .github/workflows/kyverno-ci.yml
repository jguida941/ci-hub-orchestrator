# ============================================================================
# CI/CD Hub - Kyverno Policy CI (Reusable Workflow)
# ============================================================================
# Validates Kyverno policies for syntax and optionally tests them against
# fixture resources. Use this in your repo to ensure policy quality.
#
# Usage in caller workflow:
#   jobs:
#     kyverno:
#       uses: jguida941/ci-cd-hub/.github/workflows/kyverno-ci.yml@v1
#       with:
#         policies_dir: 'policies/kyverno'
#         run_tests: true
#
# See also: docs/adr/0012-kyverno-policies.md
# ============================================================================

name: Kyverno CI

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      policies_dir:
        description: 'Directory containing Kyverno policy YAML files'
        type: string
        default: 'policies/kyverno'
      templates_dir:
        description: 'Directory containing Kyverno policy templates'
        type: string
        default: 'templates/kyverno'
      fixtures_dir:
        description: 'Directory containing test fixture resources'
        type: string
        default: 'fixtures/kyverno'
      run_tests:
        description: 'Run policy tests against fixtures'
        type: boolean
        default: false
      kyverno_version:
        description: 'Kyverno CLI version'
        type: string
        default: 'v1.16.1'
      fail_on_warn:
        description: 'Fail if policies produce warnings'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (for monorepos)'
        type: string
        default: '.'

jobs:
  validate:
    name: Validate Kyverno Policies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Kyverno CLI
        env:
          KYVERNO_VERSION: ${{ inputs.kyverno_version }}
        run: |
          set -euo pipefail
          VERSION="$KYVERNO_VERSION"

          echo "Installing Kyverno CLI ${VERSION}..."
          # Filename keeps the v prefix: kyverno-cli_v1.16.1_linux_x86_64.tar.gz
          curl -sLO "https://github.com/kyverno/kyverno/releases/download/${VERSION}/kyverno-cli_${VERSION}_linux_x86_64.tar.gz"
          tar -xzf "kyverno-cli_${VERSION}_linux_x86_64.tar.gz"
          sudo mv kyverno /usr/local/bin/
          rm "kyverno-cli_${VERSION}_linux_x86_64.tar.gz"
          kyverno version

      - name: Validate policy syntax
        id: validate
        env:
          POLICIES_DIR: ${{ inputs.policies_dir }}
          TEMPLATES_DIR: ${{ inputs.templates_dir }}
        run: |
          set -euo pipefail
          echo "Validating Kyverno policies in $POLICIES_DIR..."

          FAILED=0
          VALIDATED=0

          # Check if policies directory exists
          if [ ! -d "$POLICIES_DIR" ]; then
            echo "::warning::Policies directory '$POLICIES_DIR' not found"
            {
              echo "validated=0"
              echo "failed=0"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Validate all policy files using apply --dry-run with a minimal resource
          for policy in "$POLICIES_DIR"/*.yaml "$POLICIES_DIR"/*.yml; do
            if [ -f "$policy" ]; then
              echo "Validating: $policy"
              # Use apply with /dev/null as resource to validate policy syntax
              if kyverno apply "$policy" --resource /dev/null 2>&1 | grep -v "no resource found"; then
                echo "  OK"
                VALIDATED=$((VALIDATED + 1))
              else
                # Check if it's a real error or just "no resource" message
                OUTPUT=$(kyverno apply "$policy" --resource /dev/null 2>&1)
                if echo "$OUTPUT" | grep -qi "error\|invalid\|failed"; then
                  echo "  FAILED"
                  echo "$OUTPUT"
                  FAILED=$((FAILED + 1))
                else
                  echo "  OK (syntax valid)"
                  VALIDATED=$((VALIDATED + 1))
                fi
              fi
            fi
          done

          # Validate templates if directory exists
          if [ -d "$TEMPLATES_DIR" ]; then
            for template in "$TEMPLATES_DIR"/*.yaml "$TEMPLATES_DIR"/*.yml; do
              if [ -f "$template" ]; then
                echo "Validating template: $template"
                OUTPUT=$(kyverno apply "$template" --resource /dev/null 2>&1 || true)
                if echo "$OUTPUT" | grep -qi "error\|invalid\|failed"; then
                  echo "  FAILED"
                  echo "$OUTPUT"
                  FAILED=$((FAILED + 1))
                else
                  echo "  OK (syntax valid)"
                  VALIDATED=$((VALIDATED + 1))
                fi
              fi
            done
          fi

          echo "validated=$VALIDATED" >> "$GITHUB_OUTPUT"
          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED policy validation(s) failed"
            exit 1
          fi

          echo "All $VALIDATED policies validated successfully"

      - name: Test policies against fixtures
        if: inputs.run_tests && inputs.fixtures_dir != ''
        env:
          FIXTURES_DIR: ${{ inputs.fixtures_dir }}
          POLICIES_DIR: ${{ inputs.policies_dir }}
          FAIL_ON_WARN: ${{ inputs.fail_on_warn }}
        run: |
          set -euo pipefail
          echo "Testing policies against fixtures in $FIXTURES_DIR..."

          if [ ! -d "$FIXTURES_DIR" ]; then
            echo "::warning::Fixtures directory '$FIXTURES_DIR' not found, skipping tests"
            exit 0
          fi

          # Apply each policy to each fixture
          for policy in "$POLICIES_DIR"/*.yaml "$POLICIES_DIR"/*.yml; do
            if [ -f "$policy" ]; then
              POLICY_NAME=$(basename "$policy" .yaml)
              echo ""
              echo "=== Testing policy: $POLICY_NAME ==="

              for fixture in "$FIXTURES_DIR"/*.yaml "$FIXTURES_DIR"/*.yml; do
                if [ -f "$fixture" ]; then
                  FIXTURE_NAME=$(basename "$fixture")
                  echo -n "  vs $FIXTURE_NAME: "

                  RESULT=$(kyverno apply "$policy" --resource "$fixture" 2>&1 || true)

                  if echo "$RESULT" | grep -q "pass: 1"; then
                    echo "PASS"
                  elif echo "$RESULT" | grep -q "fail: 1"; then
                    echo "FAIL (policy enforced)"
                  elif echo "$RESULT" | grep -q "warn: 1"; then
                    echo "WARN"
                    if [ "$FAIL_ON_WARN" = "true" ]; then
                      echo "::warning::Policy $POLICY_NAME warned on $FIXTURE_NAME"
                    fi
                  else
                    echo "SKIP (not applicable)"
                  fi
                fi
              done
            fi
          done

      - name: Generate Summary
        if: always()
        env:
          POLICIES_DIR: ${{ inputs.policies_dir }}
          RUN_TESTS: ${{ inputs.run_tests }}
          VALIDATED_COUNT: ${{ steps.validate.outputs.validated || '0' }}
          FAILED_COUNT: ${{ steps.validate.outputs.failed || '0' }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          exec 3> "$summary_file"
          cat >&3 << EOF
          # Kyverno Policy Validation

          | Metric | Value |
          |--------|-------|
          | Policies Validated | $VALIDATED_COUNT |
          | Validation Failures | $FAILED_COUNT |
          | Tests Run | $RUN_TESTS |

          ## Policies Directory
          \`$POLICIES_DIR\`

          EOF

          if [ -d "$POLICIES_DIR" ]; then
            {
              echo "| Policy | Status |"
              echo "|--------|--------|"
            } >&3
            for policy in "$POLICIES_DIR"/*.yaml "$POLICIES_DIR"/*.yml; do
              if [ -f "$policy" ]; then
                NAME=$(basename "$policy")
                echo "| \`$NAME\` | Validated |" >&3
              fi
            done
          fi

          cat >&3 << 'EOF'

          ---

          See [Kyverno Documentation](https://kyverno.io/docs/) for policy reference.
          EOF
          exec 3>&-
