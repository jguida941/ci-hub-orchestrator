# ============================================================================
# CI/CD Hub - Kyverno Policy CI (Reusable Workflow)
# ============================================================================
# Validates Kyverno policies for syntax and optionally tests them against
# fixture resources. Use this in your repo to ensure policy quality.
#
# Usage in caller workflow:
#   jobs:
#     kyverno:
#       uses: jguida941/ci-cd-hub/.github/workflows/kyverno-ci.yml@v1
#       with:
#         policies_dir: 'policies/kyverno'
#         run_tests: true
#
# See also: docs/adr/0012-kyverno-policies.md
# ============================================================================

name: Kyverno CI

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      policies_dir:
        description: 'Directory containing Kyverno policy YAML files'
        type: string
        default: 'policies/kyverno'
      templates_dir:
        description: 'Directory containing Kyverno policy templates'
        type: string
        default: 'templates/kyverno'
      fixtures_dir:
        description: 'Directory containing test fixture resources'
        type: string
        default: 'fixtures/kyverno'
      run_tests:
        description: 'Run policy tests against fixtures'
        type: boolean
        default: false
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        type: boolean
        default: true
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''
      kyverno_version:
        description: 'Kyverno CLI version'
        type: string
        default: 'v1.16.1'
      fail_on_warn:
        description: 'Fail if policies produce warnings'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (for monorepos)'
        type: string
        default: '.'

jobs:
  validate:
    name: Validate Kyverno Policies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.hub_repo || vars.HUB_REPO }}
          ref: ${{ inputs.hub_ref || vars.HUB_REF }}
          path: hub
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e "hub[ci]"

      - name: Install Kyverno CLI
        id: kyverno-install
        env:
          KYVERNO_VERSION: ${{ inputs.kyverno_version }}
        run: cihub hub-ci kyverno-install --version "${KYVERNO_VERSION}" --dest .cihub/tools --github-output

      - name: Validate policy syntax
        id: validate
        env:
          POLICIES_DIR: ${{ inputs.policies_dir }}
          TEMPLATES_DIR: ${{ inputs.templates_dir }}
        run: cihub hub-ci kyverno-validate --policies-dir "${POLICIES_DIR}" --templates-dir "${TEMPLATES_DIR}" --bin "${{ steps.kyverno-install.outputs.path }}" --github-output

      - name: Test policies against fixtures
        if: inputs.run_tests && inputs.fixtures_dir != ''
        env:
          FIXTURES_DIR: ${{ inputs.fixtures_dir }}
          POLICIES_DIR: ${{ inputs.policies_dir }}
          FAIL_ON_WARN: ${{ inputs.fail_on_warn }}
        run: cihub hub-ci kyverno-test --policies-dir "${POLICIES_DIR}" --fixtures-dir "${FIXTURES_DIR}" --bin "${{ steps.kyverno-install.outputs.path }}" --fail-on-warn "${FAIL_ON_WARN}"

      - name: Generate Summary
        if: always()
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary }}
          POLICIES_DIR: ${{ inputs.policies_dir }}
          VALIDATED: ${{ steps.validate.outputs.validated || '0' }}
          FAILED: ${{ steps.validate.outputs.failed || '0' }}
          RUN_TESTS: ${{ inputs.run_tests }}
        run: cihub report kyverno-summary --policies-dir "${POLICIES_DIR}" --validated "${VALIDATED}" --failed "${FAILED}" --run-tests "${RUN_TESTS}" --title "# Kyverno Policy Validation"
