# ============================================================================
# CI/CD Hub - Smoke Test
# ============================================================================
# Quick validation test using minimal Java and Python repos.
# Runs core tools only (heavy tools like mutation/OWASP disabled for speed).
#
# Purpose:
#   - Verify hub can discover and test repositories
#   - Validate tool execution and metric collection
#   - Ensure artifacts and summaries are generated
#   - Quick feedback before full hub runs
#
# See: docs/development/execution/SMOKE_TEST.md for detailed documentation
# ============================================================================

name: "Smoke Test"

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      skip_mutation:
        description: 'Skip mutation testing (faster - recommended)'
        required: false
        type: boolean
        default: true

  # Allow running smoke test on config changes
  pull_request:
    paths:
      - 'config/repos/smoke-test-*.yaml'
      - '.github/workflows/smoke-test.yml'

env:
  REPORTS_DIR: ${{ github.workspace }}/smoke-test-reports

jobs:
  # ============================================================================
  # Discover Smoke Test Repos
  # ============================================================================
  discover:
    name: Discover Smoke Test Repos
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.repos.outputs.matrix }}
      count: ${{ steps.repos.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Build Smoke Test Matrix
        id: repos
        run: |
          REPOS='{"include":['
          FIRST=true
          COUNT=0

          # Only include smoke-test-*.yaml configs
          for config in config/repos/smoke-test-*.yaml; do
            if [ -f "$config" ]; then
              # Strip inline comments (# ...) and trim whitespace
              NAME=$(grep -E "^\s+name:" "$config" | head -1 | sed 's/.*name:\s*//' | sed 's/#.*//' | tr -d '"' | tr -d "'" | xargs)
              OWNER=$(grep -E "^\s+owner:" "$config" | head -1 | sed 's/.*owner:\s*//' | sed 's/#.*//' | tr -d '"' | tr -d "'" | xargs)
              LANG=$(grep -E "^\s+language:" "$config" | head -1 | sed 's/.*language:\s*//' | sed 's/#.*//' | tr -d '"' | tr -d "'" | xargs)
              BRANCH=$(grep -E "^\s+default_branch:" "$config" | head -1 | sed 's/.*default_branch:\s*//' | sed 's/#.*//' | tr -d '"' | tr -d "'" | xargs || echo "main")

              if [ -n "$NAME" ] && [ -n "$OWNER" ]; then
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  REPOS+=','
                fi
                REPOS+="{\"name\":\"$NAME\",\"owner\":\"$OWNER\",\"language\":\"${LANG:-java}\",\"branch\":\"${BRANCH:-main}\",\"config\":\"$config\"}"
                COUNT=$((COUNT + 1))
              fi
            fi
          done

          REPOS+=']}'
          echo "matrix=$REPOS" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "Found $COUNT smoke test repositories:"
          echo "$REPOS" | jq -r '.include[] | "  - \(.language): \(.owner)/\(.name)"' || echo "$REPOS"

      - name: Validate Smoke Test Setup
        run: |
          COUNT="${{ steps.repos.outputs.count }}"
          if [ "${COUNT:-0}" -lt 2 ]; then
            echo "::error::Expected at least 2 smoke test repos (Java + Python), found ${COUNT:-0}"
            echo "::error::Ensure config/repos/smoke-test-java.yaml and smoke-test-python.yaml exist"
            exit 1
          fi

          echo "Smoke test setup valid: ${COUNT:-0} repositories configured"

  # ============================================================================
  # Run Smoke Tests
  # ============================================================================
  test-repo:
    name: "Smoke Test: ${{ matrix.language }} (${{ matrix.name }})"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout Hub (for scripts)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          path: hub
          persist-credentials: false

      - name: Checkout Target Repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          ref: ${{ matrix.branch }}
          path: repo
          fetch-depth: 0
          persist-credentials: false

      - name: Create Reports Directory
        run: mkdir -p reports

      # ========================================
      # JAVA SETUP & CORE TOOLS
      # ========================================
      - name: Set up JDK 21
        if: matrix.language == 'java'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "[Java] Build & Test"
        if: matrix.language == 'java'
        working-directory: repo
        run: |
          echo "::group::Maven Build & Test"
          if [ -f "mvnw" ]; then
            chmod +x mvnw
            ./mvnw -B -ntp verify -Dmaven.test.failure.ignore=true
          elif [ -f "pom.xml" ]; then
            mvn -B -ntp verify -Dmaven.test.failure.ignore=true
          else
            echo "::warning::No Maven project found"
          fi
          echo "::endgroup::"
        continue-on-error: true

      - name: "[Java] Extract Test Results"
        if: matrix.language == 'java'
        id: java-tests
        working-directory: repo
        run: |
          TOTAL=0; PASSED=0; FAILED=0; SKIPPED=0; RUNTIME=0

          while IFS= read -r -d '' report; do
            T=$(grep -oP 'tests="\K[0-9]+' "$report" 2>/dev/null | head -1 || echo 0)
            F=$(grep -oP 'failures="\K[0-9]+' "$report" 2>/dev/null | head -1 || echo 0)
            E=$(grep -oP 'errors="\K[0-9]+' "$report" 2>/dev/null | head -1 || echo 0)
            S=$(grep -oP 'skipped="\K[0-9]+' "$report" 2>/dev/null | head -1 || echo 0)
            TIME=$(grep -oP 'time="\K[0-9.]+' "$report" 2>/dev/null | head -1 || echo 0)
            TOTAL=$((TOTAL + T))
            FAILED=$((FAILED + F + E))
            SKIPPED=$((SKIPPED + S))
            RUNTIME=$(echo "$RUNTIME + $TIME" | bc 2>/dev/null || echo "$RUNTIME")
          done < <(find . -path "*/surefire-reports/*.xml" -o -path "*/failsafe-reports/*.xml" -print0 2>/dev/null)
          PASSED=$((TOTAL - FAILED - SKIPPED))

          {
            echo "total=$TOTAL"
            echo "passed=$PASSED"
            echo "failed=$FAILED"
            echo "skipped=$SKIPPED"
            echo "runtime=${RUNTIME}s"
          } >> "$GITHUB_OUTPUT"

          echo "Tests: $TOTAL total, $PASSED passed, $FAILED failed, $SKIPPED skipped"

      - name: "[Java] Extract Coverage"
        if: matrix.language == 'java'
        id: java-coverage
        working-directory: repo
        run: |
          COVERED=0; MISSED=0; PERCENT=0

          JACOCO=$(find . -name "jacoco.xml" -path "*/site/*" 2>/dev/null | head -1)
          if [ -n "$JACOCO" ] && [ -f "$JACOCO" ]; then
            COVERED=$(grep -oP 'INSTRUCTION.*?covered="\K[0-9]+' "$JACOCO" 2>/dev/null | awk '{s+=$1} END {print s}' || echo 0)
            MISSED=$(grep -oP 'INSTRUCTION.*?missed="\K[0-9]+' "$JACOCO" 2>/dev/null | awk '{s+=$1} END {print s}' || echo 0)
            TOTAL=$((COVERED + MISSED))
            if [ "$TOTAL" -gt 0 ]; then
              PERCENT=$((COVERED * 100 / TOTAL))
            fi
          fi

          {
            echo "covered=$COVERED"
            echo "missed=$MISSED"
            echo "percent=$PERCENT"
            echo "lines=$COVERED / $((COVERED + MISSED))"
          } >> "$GITHUB_OUTPUT"

          echo "Coverage: $PERCENT% ($COVERED / $((COVERED + MISSED)) instructions)"

      - name: "[Java] Checkstyle"
        if: matrix.language == 'java'
        id: java-checkstyle
        working-directory: repo
        run: |
          VIOLATIONS=0

          # Use checkstyle:checkstyle to generate full XML report (not :check which only counts errors)
          if [ -f "mvnw" ]; then
            ./mvnw -B -ntp -DskipTests checkstyle:checkstyle 2>&1 | tee checkstyle-output.txt || true
          fi

          # Count all issues from XML reports (includes both warnings and errors)
          while IFS= read -r -d '' xml; do
            COUNT=$(grep -c "<error" "$xml" 2>/dev/null || echo 0)
            VIOLATIONS=$((VIOLATIONS + COUNT))
          done < <(find . -name "checkstyle-result.xml" -print0 2>/dev/null)

          echo "violations=$VIOLATIONS" >> "$GITHUB_OUTPUT"
          echo "Checkstyle: $VIOLATIONS issues found"
        continue-on-error: true

      - name: "[Java] SpotBugs"
        if: matrix.language == 'java'
        id: java-spotbugs
        working-directory: repo
        run: |
          BUGS=0

          if [ -f "mvnw" ]; then
            ./mvnw -B -ntp com.github.spotbugs:spotbugs-maven-plugin:check 2>/dev/null || true
          fi

          while IFS= read -r -d '' xml; do
            COUNT=$(grep -c "<BugInstance" "$xml" 2>/dev/null || echo 0)
            BUGS=$((BUGS + COUNT))
          done < <(find . -name "spotbugsXml.xml" -print0 2>/dev/null)

          echo "count=$BUGS" >> "$GITHUB_OUTPUT"
          echo "SpotBugs: $BUGS potential bugs"
        continue-on-error: true

      # ========================================
      # PYTHON SETUP & CORE TOOLS
      # ========================================
      - name: Set up Python 3.12
        if: matrix.language == 'python'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: "[Python] Install Dependencies"
        if: matrix.language == 'python'
        working-directory: repo
        run: |
          echo "::group::Install Python Dependencies"
          pip install --upgrade pip
          # Core testing
          pip install pytest pytest-cov
          # Linting & formatting
          pip install ruff black
          # Install repo dependencies
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "requirements-dev.txt" ]; then pip install -r requirements-dev.txt; fi
          if [ -f "pyproject.toml" ]; then pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true; fi
          echo "::endgroup::"

      - name: "[Python] Run Tests with Coverage"
        if: matrix.language == 'python'
        id: python-tests
        working-directory: repo
        run: |
          echo "::group::pytest with coverage"
          pytest --cov=. --cov-report=xml --cov-report=term -v 2>&1 | tee test-output.txt || true
          echo "::endgroup::"

          TOTAL=$(grep -oP '\d+ passed' test-output.txt | tail -1 | grep -oP '\d+' || echo 0)
          FAILED=$(grep -oP '\d+ failed' test-output.txt | tail -1 | grep -oP '\d+' || echo 0)
          SKIPPED=$(grep -oP '\d+ skipped' test-output.txt | tail -1 | grep -oP '\d+' || echo 0)

          COVERAGE=0
          if [ -f "coverage.xml" ]; then
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1 | awk '{printf "%.0f", $1 * 100}')
          fi

          {
            echo "total=$TOTAL"
            echo "passed=$TOTAL"
            echo "failed=$FAILED"
            echo "skipped=$SKIPPED"
            echo "coverage=$COVERAGE"
          } >> "$GITHUB_OUTPUT"

          echo "Tests: $TOTAL passed, $FAILED failed, $SKIPPED skipped"
          echo "Coverage: $COVERAGE%"
        continue-on-error: true

      - name: "[Python] Ruff Lint"
        if: matrix.language == 'python'
        id: python-ruff
        working-directory: repo
        run: |
          echo "::group::Ruff Linting"
          ruff check . --output-format=json > ruff-report.json 2>/dev/null || true
          echo "::endgroup::"

          ERRORS=$(jq 'length' ruff-report.json 2>/dev/null || echo 0)
          SECURITY=$(jq '[.[] | select(.code | startswith("S"))] | length' ruff-report.json 2>/dev/null || echo 0)

          {
            echo "errors=$ERRORS"
            echo "security=$SECURITY"
          } >> "$GITHUB_OUTPUT"
          echo "Ruff: $ERRORS issues ($SECURITY security-related)"
        continue-on-error: true

      - name: "[Python] Black Format Check"
        if: matrix.language == 'python'
        id: python-black
        working-directory: repo
        run: |
          echo "::group::Black Format Check"
          black --check . 2>&1 | tee black-output.txt || true
          echo "::endgroup::"

          WOULD_REFORMAT=$(grep -c "would reformat" black-output.txt 2>/dev/null || echo 0)
          echo "issues=$WOULD_REFORMAT" >> "$GITHUB_OUTPUT"
          echo "Black: $WOULD_REFORMAT files need reformatting"
        continue-on-error: true

      # ========================================
      # GENERATE SMOKE TEST REPORT
      # ========================================
      - name: Generate Smoke Test Report
        id: report
        env:
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_BRANCH: ${{ matrix.branch }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_CONFIG: ${{ matrix.config }}
          JAVA_TESTS_TOTAL: ${{ steps.java-tests.outputs.total || 0 }}
          JAVA_TESTS_FAILED: ${{ steps.java-tests.outputs.failed || 0 }}
          JAVA_COV_PERCENT: ${{ steps.java-coverage.outputs.percent || 0 }}
          JAVA_COV_LINES: ${{ steps.java-coverage.outputs.lines || '0 / 0' }}
          JAVA_CHECKSTYLE: ${{ steps.java-checkstyle.outputs.violations || 0 }}
          JAVA_SPOTBUGS: ${{ steps.java-spotbugs.outputs.count || 0 }}
          PYTHON_TESTS_TOTAL: ${{ steps.python-tests.outputs.total || 0 }}
          PYTHON_TESTS_FAILED: ${{ steps.python-tests.outputs.failed || 0 }}
          PYTHON_COV: ${{ steps.python-tests.outputs.coverage || 0 }}
          PYTHON_RUFF_ERRORS: ${{ steps.python-ruff.outputs.errors || 0 }}
          PYTHON_RUFF_SECURITY: ${{ steps.python-ruff.outputs.security || 0 }}
          PYTHON_BLACK_ISSUES: ${{ steps.python-black.outputs.issues || 0 }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          exec 3> "$summary_file"

          # Header
          cat >&3 << EOF
          # Smoke Test Results: ${MATRIX_OWNER}/${MATRIX_NAME}

          **Branch:** \`${MATRIX_BRANCH}\` | **Language:** \`${MATRIX_LANGUAGE}\` | **Config:** \`${MATRIX_CONFIG}\`

          ---

          EOF

          if [ "$MATRIX_LANGUAGE" = "java" ]; then
            COV=$JAVA_COV_PERCENT
            COV_BAR=$(printf '█%.0s' $(seq 1 $((COV / 5))) 2>/dev/null; printf '░%.0s' $(seq 1 $((20 - COV / 5))) 2>/dev/null)

            # Determine statuses
            TESTS_STATUS="FAIL"; [ "$JAVA_TESTS_TOTAL" -gt 0 ] 2>/dev/null && TESTS_STATUS="PASS"
            FAILURES_STATUS="PASS"; [ "$JAVA_TESTS_FAILED" -gt 0 ] 2>/dev/null && FAILURES_STATUS="WARN"
            COV_STATUS="WARN"; [ "$COV" -ge 50 ] 2>/dev/null && COV_STATUS="PASS"
            CHECKSTYLE_STATUS="PASS"; [ "$JAVA_CHECKSTYLE" -gt 0 ] 2>/dev/null && CHECKSTYLE_STATUS="WARN"
            SPOTBUGS_STATUS="PASS"; [ "$JAVA_SPOTBUGS" -gt 0 ] 2>/dev/null && SPOTBUGS_STATUS="WARN"

            SMOKE_STATUS="**FAIL** - Missing test execution or coverage data"
            if [ "$JAVA_TESTS_TOTAL" -gt 0 ] 2>/dev/null && [ "$COV" -gt 0 ] 2>/dev/null; then
              SMOKE_STATUS="**PASS** - Core Java tools executed successfully"
            fi

            cat >&3 << EOF
          ## Java Smoke Test Results

          | Metric | Result | Status |
          |--------|--------|--------|
          | **Unit Tests** | ${JAVA_TESTS_TOTAL} executed | ${TESTS_STATUS} |
          | **Test Failures** | ${JAVA_TESTS_FAILED} failed | ${FAILURES_STATUS} |
          | **Coverage (JaCoCo)** | ${COV}% ${COV_BAR} | ${COV_STATUS} |
          | **Checkstyle** | ${JAVA_CHECKSTYLE} violations | ${CHECKSTYLE_STATUS} |
          | **SpotBugs** | ${JAVA_SPOTBUGS} potential bugs | ${SPOTBUGS_STATUS} |

          **Coverage Details:** ${JAVA_COV_LINES} instructions covered

          ### Smoke Test Status
          ${SMOKE_STATUS}

          EOF

          else
            COV=$PYTHON_COV
            COV_BAR=$(printf '█%.0s' $(seq 1 $((COV / 5))) 2>/dev/null; printf '░%.0s' $(seq 1 $((20 - COV / 5))) 2>/dev/null)

            # Determine statuses
            TESTS_STATUS="FAIL"; [ "$PYTHON_TESTS_TOTAL" -gt 0 ] 2>/dev/null && TESTS_STATUS="PASS"
            FAILURES_STATUS="PASS"; [ "$PYTHON_TESTS_FAILED" -gt 0 ] 2>/dev/null && FAILURES_STATUS="WARN"
            COV_STATUS="WARN"; [ "$COV" -ge 50 ] 2>/dev/null && COV_STATUS="PASS"
            RUFF_STATUS="PASS"; [ "$PYTHON_RUFF_ERRORS" -gt 0 ] 2>/dev/null && RUFF_STATUS="WARN"
            BLACK_STATUS="PASS"; [ "$PYTHON_BLACK_ISSUES" -gt 0 ] 2>/dev/null && BLACK_STATUS="WARN"

            SMOKE_STATUS="**FAIL** - Missing test execution or coverage data"
            if [ "$PYTHON_TESTS_TOTAL" -gt 0 ] 2>/dev/null && [ "$COV" -gt 0 ] 2>/dev/null; then
              SMOKE_STATUS="**PASS** - Core Python tools executed successfully"
            fi

            cat >&3 << EOF
          ## Python Smoke Test Results

          | Metric | Result | Status |
          |--------|--------|--------|
          | **Unit Tests** | ${PYTHON_TESTS_TOTAL} passed | ${TESTS_STATUS} |
          | **Test Failures** | ${PYTHON_TESTS_FAILED} failed | ${FAILURES_STATUS} |
          | **Coverage (pytest-cov)** | ${COV}% ${COV_BAR} | ${COV_STATUS} |
          | **Ruff Lint** | ${PYTHON_RUFF_ERRORS} issues | ${RUFF_STATUS} |
          | **Black Format** | ${PYTHON_BLACK_ISSUES} files need reformatting | ${BLACK_STATUS} |

          **Security:** ${PYTHON_RUFF_SECURITY} security-related issues

          ### Smoke Test Status
          ${SMOKE_STATUS}

          EOF
          fi
          exec 3>&-

      # ========================================
      # UPLOAD ARTIFACTS
      # ========================================
      - name: Upload Smoke Test Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: smoke-test-${{ matrix.language }}-${{ matrix.name }}
          path: |
            repo/**/target/surefire-reports/
            repo/**/target/site/jacoco/
            repo/**/target/checkstyle-result.xml
            repo/**/target/spotbugsXml.xml
            repo/coverage.xml
            repo/htmlcov/
            repo/*-report.json
            repo/test-output.txt
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Smoke Test Summary
  # ============================================================================
  summary:
    name: Smoke Test Summary
    runs-on: ubuntu-latest
    needs: [discover, test-repo]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: smoke-test-artifacts

      - name: Generate Summary
        env:
          REPO_COUNT: ${{ needs.discover.outputs.count }}
          RUN_NUMBER: ${{ github.run_number }}
          EVENT_NAME: ${{ github.event_name }}
          TEST_RESULT: ${{ needs.test-repo.result }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          STATUS="FAILED"
          [ "$TEST_RESULT" = "success" ] && STATUS="PASSED"
          exec 3> "$summary_file"
          cat >&3 << EOF
          # Smoke Test Summary

          **Total Test Repositories:** ${REPO_COUNT}
          **Run Number:** #${RUN_NUMBER}
          **Trigger:** ${EVENT_NAME}
          **Status:** ${STATUS}

          ---

          ## What Was Tested

          The smoke test validates core hub functionality:

          - Repository discovery and configuration loading
          - Language detection (Java and Python)
          - Core tool execution (coverage, linting, style checks)
          - Artifact generation and upload
          - Summary report generation

          ## Test Repositories

          EOF
          {
            echo "| Language | Repository | Status |"
            echo "|----------|------------|--------|"
            # This would ideally parse from job results, but for now we show static info
            echo "| Java | Smoke Test Java | See job results above |"
            echo "| Python | Smoke Test Python | See job results above |"
          } >&3

          cat >&3 << EOF

          ---

          ## Next Steps

          If this smoke test **PASSED**:
          1. Mark the smoke test checkbox in \`docs/development/specs/P0.md\`
          2. Proceed with full hub testing on all configured repos
          3. Review individual job summaries for detailed metrics

          If this smoke test **FAILED**:
          1. Check individual job logs for errors
          2. Verify test repositories are accessible
          3. Ensure config files are valid YAML
          4. See [\`docs/development/execution/SMOKE_TEST.md\`](docs/development/execution/SMOKE_TEST.md) for troubleshooting

          ---

          **Documentation:** See [\`docs/development/execution/SMOKE_TEST.md\`](docs/development/execution/SMOKE_TEST.md) for detailed smoke test guide.

          EOF
          exec 3>&-

      - name: Check Smoke Test Result
        env:
          TEST_RESULT: ${{ needs.test-repo.result }}
        run: |
          if [ "$TEST_RESULT" != "success" ]; then
            echo "::error::Smoke test failed - check job results above"
            exit 1
          fi

          echo "Smoke test passed."
