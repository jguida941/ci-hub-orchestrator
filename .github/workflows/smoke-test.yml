# ============================================================================
# CI/CD Hub - Smoke Test
# ============================================================================
# Quick validation test using minimal Java and Python repos.
# Runs core tools only (heavy tools like mutation/OWASP disabled for speed).
#
# Purpose:
#   - Verify hub can discover and test repositories
#   - Validate tool execution and metric collection
#   - Ensure artifacts and summaries are generated
#   - Quick feedback before full hub runs
#
# See: docs/development/execution/SMOKE_TEST.md for detailed documentation
# ============================================================================

name: "Smoke Test"

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      skip_mutation:
        description: 'Skip mutation testing (faster - recommended)'
        required: false
        type: boolean
        default: true
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: boolean
        default: true

  # Allow running smoke test on config changes
  pull_request:
    paths:
      - 'config/repos/smoke-test-*.yaml'
      - '.github/workflows/smoke-test.yml'

env:
  REPORTS_DIR: ${{ github.workspace }}/smoke-test-reports

jobs:
  # ============================================================================
  # Discover Smoke Test Repos
  # ============================================================================
  discover:
    name: Discover Smoke Test Repos
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.repos.outputs.matrix }}
      count: ${{ steps.repos.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Build Smoke Test Matrix
        id: repos
        run: cihub discover --run-group smoke --github-output

      - name: Validate Smoke Test Setup
        run: cihub smoke-validate --count "${{ steps.repos.outputs.count }}" --min-count 2

  # ============================================================================
  # Run Smoke Tests
  # ============================================================================
  test-repo:
    name: "Smoke Test: ${{ matrix.language }} (${{ matrix.name }})"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout Hub (for scripts)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: hub
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e "hub[ci]"

      - name: Checkout Target Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          ref: ${{ matrix.branch }}
          path: repo
          fetch-depth: 0
          persist-credentials: false

      - name: Create Reports Directory
        run: mkdir -p reports

      # ========================================
      # JAVA SETUP & CORE TOOLS
      # ========================================
      - name: Set up JDK 21
        if: matrix.language == 'java'
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "[Java] Build & Test"
        if: matrix.language == 'java'
        working-directory: repo
        run: cihub hub-ci smoke-java-build --path .
        continue-on-error: true

      - name: "[Java] Extract Test Results"
        if: matrix.language == 'java'
        id: java-tests
        working-directory: repo
        run: cihub hub-ci smoke-java-tests --path . --github-output

      - name: "[Java] Extract Coverage"
        if: matrix.language == 'java'
        id: java-coverage
        working-directory: repo
        run: cihub hub-ci smoke-java-coverage --path . --github-output

      - name: "[Java] Checkstyle"
        if: matrix.language == 'java'
        id: java-checkstyle
        working-directory: repo
        run: cihub hub-ci smoke-java-checkstyle --path . --github-output
        continue-on-error: true

      - name: "[Java] SpotBugs"
        if: matrix.language == 'java'
        id: java-spotbugs
        working-directory: repo
        run: cihub hub-ci smoke-java-spotbugs --path . --github-output
        continue-on-error: true

      # ========================================
      # PYTHON SETUP & CORE TOOLS
      # ========================================
      - name: Set up Python 3.12
        if: matrix.language == 'python'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: "[Python] Install Dependencies"
        if: matrix.language == 'python'
        working-directory: repo
        run: cihub hub-ci smoke-python-install --path .

      - name: "[Python] Run Tests with Coverage"
        if: matrix.language == 'python'
        id: python-tests
        working-directory: repo
        run: cihub hub-ci smoke-python-tests --path . --output-file test-output.txt --github-output
        continue-on-error: true

      - name: "[Python] Ruff Lint"
        if: matrix.language == 'python'
        id: python-ruff
        working-directory: repo
        run: cihub hub-ci smoke-python-ruff --path . --report ruff-report.json --github-output
        continue-on-error: true

      - name: "[Python] Black Format Check"
        if: matrix.language == 'python'
        id: python-black
        working-directory: repo
        run: cihub hub-ci smoke-python-black --path . --output-file black-output.txt --github-output
        continue-on-error: true

      # ========================================
      # GENERATE SMOKE TEST REPORT
      # ========================================
      - name: Generate Smoke Test Report
        id: report
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
        run: cihub report smoke-summary --mode repo --owner "${{ matrix.owner }}" --repo "${{ matrix.name }}" --branch "${{ matrix.branch }}" --language "${{ matrix.language }}" --config "${{ matrix.config_basename }}" --tests-total "${{ matrix.language == 'java' && steps.java-tests.outputs.total || steps.python-tests.outputs.total || '0' }}" --tests-failed "${{ matrix.language == 'java' && steps.java-tests.outputs.failed || steps.python-tests.outputs.failed || '0' }}" --coverage "${{ matrix.language == 'java' && steps.java-coverage.outputs.percent || steps.python-tests.outputs.coverage || '0' }}" --coverage-lines "${{ steps.java-coverage.outputs.lines || '0 / 0' }}" --checkstyle-violations "${{ steps.java-checkstyle.outputs.violations || '0' }}" --spotbugs-issues "${{ steps.java-spotbugs.outputs.count || '0' }}" --ruff-errors "${{ steps.python-ruff.outputs.errors || '0' }}" --ruff-security "${{ steps.python-ruff.outputs.security || '0' }}" --black-issues "${{ steps.python-black.outputs.issues || '0' }}"

      # ========================================
      # UPLOAD ARTIFACTS
      # ========================================
      - name: Upload Smoke Test Artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: smoke-test-${{ matrix.language }}-${{ matrix.name }}
          path: |
            repo/**/target/surefire-reports/
            repo/**/target/site/jacoco/
            repo/**/target/checkstyle-result.xml
            repo/**/target/spotbugsXml.xml
            repo/coverage.xml
            repo/htmlcov/
            repo/*-report.json
            repo/test-output.txt
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Smoke Test Summary
  # ============================================================================
  summary:
    name: Smoke Test Summary
    runs-on: ubuntu-latest
    needs: [discover, test-repo]
    if: always()

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download All Artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: smoke-test-artifacts

      - name: Generate Summary
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
        run: cihub report smoke-summary --mode overall --repo-count "${{ needs.discover.outputs.count }}" --run-number "${{ github.run_number }}" --event-name "${{ github.event_name }}" --test-result "${{ needs.test-repo.result }}"

      - name: Check Smoke Test Result
        run: cihub smoke-validate --status "${{ needs.test-repo.result }}"
