name: codeql

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  analyze:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
    steps:
      - name: Determine CodeQL upload mode
        id: codeql_upload
        run: |
          set -euo pipefail
          upload=true
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            fork=$(jq -r '.pull_request.head.repo.fork' "$GITHUB_EVENT_PATH")
            if [ "$fork" = "true" ]; then
              upload=false
            fi
          fi
          echo "upload=${upload}" >> "$GITHUB_OUTPUT"
        shell: bash
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@562257dc84ee23987d348302b161ee561898ec02 # v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@562257dc84ee23987d348302b161ee561898ec02 # v3

      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@562257dc84ee23987d348302b161ee561898ec02 # v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: ${{ steps.codeql_upload.outputs.upload }}
          output: codeql-sarif

      - name: Summarize CodeQL findings
        run: |
          python3 scripts/summarize_codeql.py \
            --sarif-dir codeql-sarif \
            --summary-out codeql-summary.md \
            --fail-on error

      - name: Publish job summary
        if: ${{ always() }}
        run: cat codeql-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Update pull request comment
        if: ${{ always() && github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork }}
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require("fs");
            const marker = "<!-- codeql-summary -->";
            const body = `${marker}\n${fs.readFileSync("codeql-summary.md", "utf8")}`;

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            const previous = comments.find(
              (comment) =>
                comment.user?.type === "Bot" && comment.body?.includes(marker)
            );

            if (previous) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: previous.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

      - name: Upload SARIF artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: codeql-sarif-${{ matrix.language }}
          path: codeql-sarif
          compression-level: 9

      - name: Upload summary artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: codeql-summary-${{ matrix.language }}
          path: codeql-summary.md
