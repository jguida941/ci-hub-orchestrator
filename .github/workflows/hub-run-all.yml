# ============================================================================
# CI/CD Hub - Central Test Runner
# ============================================================================
# This is the TRUE hub workflow - it clones and tests ALL your repos directly.
# Target repos DO NOT need any workflow files - the hub does everything.
#
# How it works:
#   1. cihub discover reads config/repos/*.yaml to get repo list
#   2. cihub ci clones and runs ALL quality tools for each repo
#   3. Artifacts uploaded centrally per repo
#
# This workflow is a THIN WRAPPER - all logic is in the cihub CLI.
# Per AGENTS.md: "Never write inline scripts in YAML workflows"
# ============================================================================

name: "Hub: Run All Repos"

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repos (comma-separated, empty=all)'
        required: false
        type: string
      run_group:
        description: 'Run group filter (full, smoke, fixtures, or comma-separated)'
        required: false
        type: string
      skip_mutation:
        description: 'Skip mutation testing (faster)'
        required: false
        type: boolean
        default: false

  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches: [main, master]
    paths:
      - 'config/repos/*.yaml'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Discover Repos (via cihub discover)
  # ============================================================================
  discover:
    name: Discover Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      count: ${{ steps.discover.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Discover Repos
        id: discover
        env:
          INPUT_REPOS: ${{ inputs.repos }}
          INPUT_RUN_GROUP: ${{ inputs.run_group }}
        run: |
          cihub discover \
            --repos "${INPUT_REPOS:-}" \
            --run-group "${INPUT_RUN_GROUP:-}" \
            --github-output

  # ============================================================================
  # Run CI for Each Repo (via cihub ci)
  # ============================================================================
  test-repo:
    name: "Test: ${{ matrix.config_basename }}"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    permissions:
      contents: read
      security-events: write  # For CodeQL SARIF upload
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: hub
          persist-credentials: false

      - name: Checkout Target Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          ref: ${{ matrix.branch }}
          path: repo
          persist-credentials: false

      # Language-specific setup
      - name: Set up JDK ${{ matrix.java_version }}
        if: matrix.language == 'java'
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v4.7.1
        with:
          java-version: '${{ matrix.java_version }}'
          distribution: 'temurin'
          cache: '${{ matrix.build_tool }}'

      - name: Set up Python ${{ matrix.python_version || '3.12' }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '${{ matrix.python_version || 3.12 }}'

      - name: Install cihub + tools
        run: pip install -e "hub[ci]"

      - name: Run cihub ci
        env:
          CONFIG_BASENAME: ${{ matrix.config_basename }}
          CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.config_basename }}
        run: |
          cihub ci \
            --repo repo \
            --config-from-hub "$CONFIG_BASENAME" \
            --correlation-id "$CORRELATION_ID" \
            --install-deps \
            --output-dir .cihub

      - name: Read report outputs
        id: report
        if: always()
        run: |
          if [ -f .cihub/report.json ]; then
            cihub report outputs --report .cihub/report.json
          fi

      - name: Upload CI Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.config_basename }}${{ matrix.subdir_safe != '' && format('-{0}', matrix.subdir_safe) || '' }}-ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/tool-outputs/*.json
          retention-days: ${{ matrix.retention_days || 30 }}
          if-no-files-found: warn

  # ============================================================================
  # Hub Summary
  # ============================================================================
  summary:
    name: Hub Summary
    runs-on: ubuntu-latest
    needs: [discover, test-repo]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download All Reports
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: reports
          pattern: '*-ci-report'
        continue-on-error: true

      - name: Generate Hub Summary
        env:
          TOTAL_REPOS: ${{ needs.discover.outputs.count }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_EVENT_NAME: ${{ github.event_name }}
        run: |
          cihub report aggregate \
            --reports-dir reports \
            --total-repos "${TOTAL_REPOS}" \
            --output hub-report.json

      - name: Upload Hub Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: hub-report-${{ github.run_id }}
          path: hub-report.json
          retention-days: 30
