# ============================================================================
# CI/CD Hub - Java CI Workflow
# ============================================================================
#
# Reusable workflow with boolean toggles for Java testing, linting, and
# security scanning. Configure tools via .ci-hub.yml, run via `cihub ci`.
#
# HOW IT WORKS:
#   1. Your repo calls this workflow via `uses:`
#   2. This workflow installs and runs `cihub ci`
#   3. cihub reads YOUR .ci-hub.yml config file
#   4. Tools execute based on YOUR enabled: true/false toggles
#   5. Report + summary written to .cihub/ directory
#
# TOGGLE CONFIGURATION (in your repo's .ci-hub.yml):
#   java:
#     tools:
#       jacoco:    { enabled: true }   # Coverage
#       pitest:    { enabled: true }   # Mutation testing
#       checkstyle:{ enabled: true }   # Style checks
#       spotbugs:  { enabled: true }   # Static analysis
#       pmd:       { enabled: true }   # Static analysis
#       owasp:     { enabled: true }   # Dependency scan
#       jqwik:     { enabled: false }  # Property-based testing
#       semgrep:   { enabled: false }  # SAST (expensive, opt-in)
#       trivy:     { enabled: false }  # Container scan (expensive, opt-in)
#       codeql:    { enabled: false }  # CodeQL (expensive, opt-in)
#       docker:    { enabled: false }  # Docker build/test (opt-in)
#
# QUICK START WITH PROFILES (hub-side config):
#   Use a pre-built profile to generate hub configs:
#     cihub new myrepo --profile java-minimal     # Coverage + lint (~5-10 min)
#     cihub new myrepo --profile java-quality     # Core tools (~15-30 min)
#     cihub new myrepo --profile java-security    # + semgrep, trivy, codeql
#
# THRESHOLDS (quality gates in .ci-hub.yml):
#   thresholds:
#     coverage_min: 70        # Fail if coverage < 70%
#     mutation_score_min: 70  # Fail if mutation score < 70%
#     max_high_vulns: 0       # Fail on any high-severity vulnerability
#     max_checkstyle_errors: 0
#
# CALLER EXAMPLE (minimal - config lives in .ci-hub.yml):
#   # .github/workflows/hub-ci.yml
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/java-ci.yml@v1
#       secrets: inherit
#
# INSTALL: Tools are installed from the hub repo via `pip install -e "hub[ci]"`
#          (PyPI distribution is planned; see ADR-0033).
#
# ============================================================================

name: Java CI Pipeline

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # ---- Java Settings ----
      java_version:
        description: 'Java version'
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven or gradle)'
        type: string
        default: 'maven'

      # ---- Tool Toggles ----
      run_jacoco:
        description: 'Run JaCoCo coverage'
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP Dependency Check'
        type: boolean
        default: true
      use_nvd_api_key:
        description: 'Use NVD API key for faster OWASP scans (requires NVD_API_KEY secret)'
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing'
        type: boolean
        default: true
      run_jqwik:
        description: 'Run jqwik property-based testing'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      run_pmd:
        description: 'Run PMD static analysis'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      owasp_cvss_fail:
        description: 'CVSS score to fail on'
        type: number
        default: 7
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_pmd_violations:
        description: 'Maximum allowed PMD violations (default: 0 = fail on any)'
        type: number
        default: 0
      max_checkstyle_errors:
        description: 'Maximum allowed Checkstyle errors (default: 0 = fail on any)'
        type: number
        default: 0
      max_spotbugs_bugs:
        description: 'Maximum allowed SpotBugs bugs (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Docker Settings ----
      docker_compose_file:
        description: 'Docker compose file path'
        type: string
        default: 'docker-compose.yml'
      docker_health_endpoint:
        description: 'Health check endpoint'
        type: string
        default: '/actuator/health'

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''

    secrets:
      NVD_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.ci.outputs.build_status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.ci.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.ci.outputs.mutation_score }}

jobs:
  ci:
    name: Java CI (cihub)
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.report.outputs.build_status }}
      coverage: ${{ steps.report.outputs.coverage }}
      mutation_score: ${{ steps.report.outputs.mutation_score }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Resolve hub ref
        id: hub-ref
        env:
          HUB_REPO_INPUT: ${{ inputs.hub_repo }}
          HUB_REF_INPUT: ${{ inputs.hub_ref }}
          WORKFLOW_REF: ${{ github.workflow_ref }}
        run: |
          if [ -n "$HUB_REPO_INPUT" ] || [ -n "$HUB_REF_INPUT" ]; then
            if [ -z "$HUB_REPO_INPUT" ] || [ -z "$HUB_REF_INPUT" ]; then
              echo "::error::hub_repo and hub_ref must both be set or both be empty"
              exit 1
            fi
            repo="$HUB_REPO_INPUT"
            ref="$HUB_REF_INPUT"
          else
            # Fallback to hub repo defaults (override via inputs for forks)
            repo="jguida941/ci-cd-hub"
            ref="main"
          fi
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout hub repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ steps.hub-ref.outputs.repo }}
          ref: ${{ steps.hub-ref.outputs.ref }}
          path: hub
          persist-credentials: false

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Install cihub + tools
        run: |
          python -m pip install --upgrade pip
          pip install -e "hub[ci]"

      - name: Run cihub ci
        run: |
          cihub ci \
            --workdir "${{ inputs.workdir }}" \
            --correlation-id "${{ inputs.hub_correlation_id }}" \
            --output-dir .cihub

      - name: Read report outputs
        id: report
        run: |
          cihub report outputs --report .cihub/report.json

      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/tool-outputs/*.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: warn
