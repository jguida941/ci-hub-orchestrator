# ============================================================================
# CI/CD Hub - Reusable Java CI Workflow
# ============================================================================
# Call this workflow from any Java repository to run the full CI pipeline.
#
# Usage in your repo's workflow:
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/java-ci.yml@main
#       with:
#         java_version: '21'
#         run_pitest: true
#         run_docker: false
#       secrets: inherit
# ============================================================================

name: Java CI Pipeline

on:
  workflow_call:
    inputs:
      # ---- Java Settings ----
      java_version:
        description: 'Java version'
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven or gradle)'
        type: string
        default: 'maven'

      # ---- Tool Toggles ----
      run_jacoco:
        description: 'Run JaCoCo coverage'
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP Dependency Check'
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing (expensive)'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      run_pmd:
        description: 'Run PMD static analysis'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      owasp_cvss_fail:
        description: 'CVSS score to fail on'
        type: number
        default: 7
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0

      # ---- Docker Settings ----
      docker_compose_file:
        description: 'Docker compose file path'
        type: string
        default: 'docker-compose.yml'
      docker_health_endpoint:
        description: 'Health check endpoint'
        type: string
        default: '/actuator/health'

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'

    secrets:
      NVD_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.build-test.outputs.status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.build-test.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.mutation-test.outputs.score }}

jobs:
  # ============================================================================
  # Build & Test
  # ============================================================================
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}
    outputs:
      status: ${{ steps.build.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build and Test
        id: build
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp verify \
                -Dcheckstyle.skip=${{ !inputs.run_checkstyle }} \
                -Dspotbugs.skip=${{ !inputs.run_spotbugs }} \
                -Ddependency-check.skip=${{ !inputs.run_owasp }}
            else
              mvn -B -ntp verify \
                -Dcheckstyle.skip=${{ !inputs.run_checkstyle }} \
                -Dspotbugs.skip=${{ !inputs.run_spotbugs }} \
                -Ddependency-check.skip=${{ !inputs.run_owasp }}
            fi
          else
            if [ -f "gradlew" ]; then
              chmod +x gradlew
              ./gradlew build
            else
              gradle build
            fi
          fi
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          MAVEN_OPTS: -Xmx1024m

      - name: Extract Coverage
        id: coverage
        if: inputs.run_jacoco
        run: |
          # Find JaCoCo report and extract coverage
          COVERAGE=0
          if [ -f "target/site/jacoco/jacoco.xml" ]; then
            COVERAGE=$(grep -oP 'INSTRUCTION.*?counter.*?covered="\K[0-9]+' target/site/jacoco/jacoco.xml | head -1 || echo "0")
            MISSED=$(grep -oP 'INSTRUCTION.*?counter.*?missed="\K[0-9]+' target/site/jacoco/jacoco.xml | head -1 || echo "0")
            if [ $((COVERAGE + MISSED)) -gt 0 ]; then
              COVERAGE=$((COVERAGE * 100 / (COVERAGE + MISSED)))
            fi
          fi
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Check Coverage Threshold
        if: inputs.run_jacoco
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          MIN=${{ inputs.coverage_min }}
          if [ "$COVERAGE" -lt "$MIN" ]; then
            echo "::error::Coverage $COVERAGE% is below minimum $MIN%"
            exit 1
          fi

      # ---- Generate Summary ----
      - name: Generate Build Summary
        if: always()
        run: |
          echo "## Build Results for ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Java Version | ${{ inputs.java_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Tool | ${{ inputs.build_tool }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.coverage.outputs.percentage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Tools Executed" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| JaCoCo | ${{ inputs.run_jacoco }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkstyle | ${{ inputs.run_checkstyle }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs | ${{ inputs.run_spotbugs }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PMD | ${{ inputs.run_pmd }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP | ${{ inputs.run_owasp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PITest | ${{ inputs.run_pitest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep | ${{ inputs.run_semgrep }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ inputs.run_trivy }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ inputs.run_docker }} |" >> $GITHUB_STEP_SUMMARY

      # ---- Upload Artifacts ----
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload JaCoCo Reports
        if: always() && inputs.run_jacoco
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: '**/target/site/jacoco/'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload Checkstyle Reports
        if: always() && inputs.run_checkstyle
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-reports
          path: '**/target/checkstyle-result.xml'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload SpotBugs Reports
        if: always() && inputs.run_spotbugs
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-reports
          path: |
            **/target/spotbugsXml.xml
            **/target/spotbugs.html
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload OWASP Reports
        if: always() && inputs.run_owasp
        uses: actions/upload-artifact@v4
        with:
          name: owasp-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce OWASP Thresholds
        if: inputs.run_owasp
        run: |
          REPORT=$(find . -name "dependency-check-report.json" -print -quit)
          CRITICAL=0
          HIGH=0
          if [ -n "$REPORT" ] && [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
          else
            echo "::warning::dependency-check-report.json not found; skipping vulnerability threshold enforcement"
          fi

          if [ "$CRITICAL" -gt "${{ inputs.max_critical_vulns }}" ]; then
            echo "::error::Critical vulnerabilities ($CRITICAL) exceed max_critical_vulns ${{ inputs.max_critical_vulns }}"
            exit 1
          fi
          if [ "$HIGH" -gt "${{ inputs.max_high_vulns }}" ]; then
            echo "::error::High vulnerabilities ($HIGH) exceed max_high_vulns ${{ inputs.max_high_vulns }}"
            exit 1
          fi

      - name: Upload to Codecov
        if: inputs.run_jacoco
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: '**/target/site/jacoco/jacoco.xml'
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # PMD Static Analysis
  # ============================================================================
  pmd:
    name: PMD Analysis
    runs-on: ubuntu-latest
    needs: build-test
    if: inputs.run_pmd
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Run PMD
        id: pmd
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp pmd:check || true
            else
              mvn -B -ntp pmd:check || true
            fi
          fi

          # Count violations
          VIOLATIONS=0
          for xml in $(find . -name "pmd.xml" 2>/dev/null); do
            COUNT=$(grep -c "<violation" "$xml" 2>/dev/null || echo 0)
            VIOLATIONS=$((VIOLATIONS + COUNT))
          done

          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "PMD Violations: $VIOLATIONS"
        continue-on-error: true

      - name: Generate PMD Summary
        if: always()
        run: |
          echo "## PMD Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Violations:** ${{ steps.pmd.outputs.violations }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload PMD Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-reports
          path: '**/target/pmd.xml'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce PMD Violations
        run: |
          VIOLATIONS=${{ steps.pmd.outputs.violations || 0 }}
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "::error::PMD reported $VIOLATIONS violations"
            exit 1
          fi

  # ============================================================================
  # Semgrep SAST
  # ============================================================================
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    needs: build-test
    if: inputs.run_semgrep
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        id: semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true

          FINDINGS=0
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)
          fi

          echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
          echo "Semgrep Findings: $FINDINGS"
        continue-on-error: true

      - name: Generate Semgrep Summary
        if: always()
        run: |
          echo "## Semgrep SAST Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Findings:** ${{ steps.semgrep.outputs.findings }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload Semgrep Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Semgrep Threshold
        run: |
          FINDINGS=${{ steps.semgrep.outputs.findings || 0 }}
          if [ "$FINDINGS" -gt 0 ]; then
            echo "::error::Semgrep reported $FINDINGS findings"
            exit 1
          fi

  # ============================================================================
  # Trivy Container Scan
  # ============================================================================
  trivy:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: build-test
    if: inputs.run_trivy
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for Dockerfile
        id: check-dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No Dockerfile found - skipping Trivy container scan"
          fi

      - name: Run Trivy Scan
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-report.json'
        continue-on-error: true

      - name: Parse Trivy Results
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy-parse
        run: |
          CRITICAL=0
          HIGH=0
          if [ -f "trivy-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-report.json 2>/dev/null || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-report.json 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "Trivy: $CRITICAL critical, $HIGH high"

      - name: Generate Trivy Summary
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        run: |
          echo "## Trivy Container Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Critical:** ${{ steps.trivy-parse.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "**High:** ${{ steps.trivy-parse.outputs.high }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload Trivy Report
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Trivy Thresholds
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          CRIT=${{ steps.trivy-parse.outputs.critical || 0 }}
          HIGH=${{ steps.trivy-parse.outputs.high || 0 }}
          if [ "$CRIT" -gt "${{ inputs.max_critical_vulns }}" ]; then
            echo "::error::Trivy critical findings ($CRIT) exceed max_critical_vulns ${{ inputs.max_critical_vulns }}"
            exit 1
          fi
          if [ "$HIGH" -gt "${{ inputs.max_high_vulns }}" ]; then
            echo "::error::Trivy high findings ($HIGH) exceed max_high_vulns ${{ inputs.max_high_vulns }}"
            exit 1
          fi

  # ============================================================================
  # Mutation Testing
  # ============================================================================
  mutation-test:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: build-test
    if: inputs.run_pitest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}
    outputs:
      score: ${{ steps.pitest.outputs.score }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Run PITest
        id: pitest
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp test-compile org.pitest:pitest-maven:mutationCoverage -DskipTests || true
            else
              mvn -B -ntp test-compile org.pitest:pitest-maven:mutationCoverage -DskipTests || true
            fi
          fi

          # Extract mutation score
          SCORE=0
          if [ -f "target/pit-reports/mutations.xml" ]; then
            KILLED=$(grep -c 'status="KILLED"' target/pit-reports/mutations.xml 2>/dev/null || echo "0")
            SURVIVED=$(grep -c 'status="SURVIVED"' target/pit-reports/mutations.xml 2>/dev/null || echo "0")
            TOTAL=$((KILLED + SURVIVED))
            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$((KILLED * 100 / TOTAL))
            fi
          fi
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Mutation Score: $SCORE%"

      - name: Check Mutation Threshold
        run: |
          SCORE=${{ steps.pitest.outputs.score }}
          MIN=${{ inputs.mutation_score_min }}
          if [ "$SCORE" -lt "$MIN" ]; then
            echo "::error::Mutation score $SCORE% is below minimum $MIN%"
            exit 1
          fi

      - name: Generate Mutation Summary
        if: always()
        run: |
          echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mutation Score:** ${{ steps.pitest.outputs.score }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** ${{ inputs.mutation_score_min }}%" >> $GITHUB_STEP_SUMMARY

      - name: Upload PITest Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-reports
          path: '**/target/pit-reports/'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

  # ============================================================================
  # Docker Build & Test
  # ============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build-test
    if: inputs.run_docker
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t ${{ github.repository }}:ci-test .
          fi

      - name: Test with Docker Compose
        if: hashFiles(inputs.docker_compose_file) != ''
        run: |
          docker compose -f ${{ inputs.docker_compose_file }} up -d

          # Wait for health check
          echo "Waiting for services to be healthy..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080${{ inputs.docker_health_endpoint }} > /dev/null 2>&1; then
              echo "Service is healthy!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 10
          done

          # Show logs
          docker compose logs

          # Cleanup
          docker compose down

  # ============================================================================
  # CodeQL Security Analysis
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: inputs.run_codeql
    permissions:
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Build for CodeQL
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp compile -DskipTests
            else
              mvn -B -ntp compile -DskipTests
            fi
          else
            if [ -f "gradlew" ]; then
              chmod +x gradlew
              ./gradlew compileJava
            else
              gradle compileJava
            fi
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # Generate Final Report
  # ============================================================================
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [build-test, mutation-test]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports/

      - name: Generate Combined Report
        run: |
          # Extract vulnerability counts from OWASP report
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MEDIUM_VULNS=0

          OWASP_REPORT=$(find all-reports -name "dependency-check-report.json" 2>/dev/null | head -1)
          if [ -n "$OWASP_REPORT" ] && [ -f "$OWASP_REPORT" ]; then
            CRITICAL_VULNS=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            HIGH_VULNS=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            MEDIUM_VULNS=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
          fi

          # Extract Trivy vulnerability counts if available
          TRIVY_REPORT=$(find all-reports -name "trivy-report.json" 2>/dev/null | head -1)
          if [ -n "$TRIVY_REPORT" ] && [ -f "$TRIVY_REPORT" ]; then
            TRIVY_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            # Add Trivy counts to totals
            CRITICAL_VULNS=$((CRITICAL_VULNS + TRIVY_CRITICAL))
            HIGH_VULNS=$((HIGH_VULNS + TRIVY_HIGH))
            MEDIUM_VULNS=$((MEDIUM_VULNS + TRIVY_MEDIUM))
          fi

          cat > report.json << EOF
          {
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "java_version": "${{ inputs.java_version }}",
            "results": {
              "build": "${{ needs.build-test.outputs.status }}",
              "coverage": ${{ needs.build-test.outputs.coverage || 0 }},
              "mutation_score": ${{ needs.mutation-test.outputs.score || 0 }},
              "critical_vulns": ${CRITICAL_VULNS},
              "high_vulns": ${HIGH_VULNS},
              "medium_vulns": ${MEDIUM_VULNS}
            },
            "tools": {
              "jacoco": ${{ inputs.run_jacoco }},
              "checkstyle": ${{ inputs.run_checkstyle }},
              "spotbugs": ${{ inputs.run_spotbugs }},
              "pmd": ${{ inputs.run_pmd }},
              "owasp": ${{ inputs.run_owasp }},
              "pitest": ${{ inputs.run_pitest }},
              "semgrep": ${{ inputs.run_semgrep }},
              "trivy": ${{ inputs.run_trivy }},
              "codeql": ${{ inputs.run_codeql }},
              "docker": ${{ inputs.run_docker }}
            },
            "thresholds": {
              "coverage_min": ${{ inputs.coverage_min }},
              "mutation_score_min": ${{ inputs.mutation_score_min }},
              "owasp_cvss_fail": ${{ inputs.owasp_cvss_fail }}
            }
          }
          EOF

          cat report.json

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: report.json
          retention-days: ${{ inputs.retention_days }}
