# ============================================================================
# CI/CD Hub - Reusable Java CI Workflow
# ============================================================================
# Call this workflow from any Java repository to run the full CI pipeline.
#
# Usage in your repo's workflow:
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/java-ci.yml@main
#       with:
#         java_version: '21'
#         run_pitest: true
#         run_docker: false
#       secrets: inherit
# ============================================================================

name: Java CI Pipeline

on:
  workflow_call:
    inputs:
      # ---- Java Settings ----
      java_version:
        description: 'Java version'
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven or gradle)'
        type: string
        default: 'maven'

      # ---- Tool Toggles ----
      run_jacoco:
        description: 'Run JaCoCo coverage'
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP Dependency Check'
        type: boolean
        default: true
      use_nvd_api_key:
        description: 'Use NVD API key for faster OWASP scans (requires NVD_API_KEY secret)'
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing'
        type: boolean
        default: true
      run_jqwik:
        description: 'Run jqwik property-based testing'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      run_pmd:
        description: 'Run PMD static analysis'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false

      # ---- Thresholds ----
      # Individual threshold inputs kept for backward compatibility
      # Prefer using threshold_overrides_yaml for new callers (see ADR-0024)
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      owasp_cvss_fail:
        description: 'CVSS score to fail on'
        type: number
        default: 7
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_pmd_violations:
        description: 'Maximum allowed PMD violations (default: 0 = fail on any)'
        type: number
        default: 0
      max_checkstyle_errors:
        description: 'Maximum allowed Checkstyle errors (default: 0 = fail on any)'
        type: number
        default: 0
      max_spotbugs_bugs:
        description: 'Maximum allowed SpotBugs bugs (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Threshold Override (single input, all thresholds) ----
      # YAML string containing thresholds from .ci-hub.yml or orchestrator
      # Takes precedence over individual threshold inputs above
      # Format: "coverage_min: 80\nmax_critical_vulns: 0\n..."
      threshold_overrides_yaml:
        description: 'YAML string with threshold overrides (from .ci-hub.yml)'
        type: string
        default: ''

      # ---- Docker Settings ----
      docker_compose_file:
        description: 'Docker compose file path'
        type: string
        default: 'docker-compose.yml'
      docker_health_endpoint:
        description: 'Health check endpoint'
        type: string
        default: '/actuator/health'

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''

    secrets:
      NVD_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.build-test.outputs.status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.build-test.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.mutation-test.outputs.score }}

jobs:
  # ============================================================================
  # Build & Test
  # ============================================================================
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}
    outputs:
      status: ${{ steps.build.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}
      tests_passed: ${{ steps.test-counts.outputs.passed }}
      tests_failed: ${{ steps.test-counts.outputs.failed }}
      # Effective thresholds (from .ci-hub.yml or inputs)
      eff_coverage_min: ${{ steps.thresholds.outputs.coverage_min }}
      eff_mutation_score_min: ${{ steps.thresholds.outputs.mutation_score_min }}
      eff_owasp_cvss_fail: ${{ steps.thresholds.outputs.owasp_cvss_fail }}
      eff_max_critical_vulns: ${{ steps.thresholds.outputs.max_critical_vulns }}
      eff_max_high_vulns: ${{ steps.thresholds.outputs.max_high_vulns }}
      eff_max_semgrep_findings: ${{ steps.thresholds.outputs.max_semgrep_findings }}
      eff_max_pmd_violations: ${{ steps.thresholds.outputs.max_pmd_violations }}
      eff_max_checkstyle_errors: ${{ steps.thresholds.outputs.max_checkstyle_errors }}
      eff_max_spotbugs_bugs: ${{ steps.thresholds.outputs.max_spotbugs_bugs }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ========================================
      # RESOLVE EFFECTIVE THRESHOLDS
      # Priority: threshold_overrides_yaml > .ci-hub.yml > inputs
      # See ADR-0024 for rationale
      # ========================================
      - name: Resolve Thresholds
        id: thresholds
        run: |
          # Start with input defaults
          COVERAGE_MIN="${{ inputs.coverage_min }}"
          MUTATION_SCORE_MIN="${{ inputs.mutation_score_min }}"
          OWASP_CVSS_FAIL="${{ inputs.owasp_cvss_fail }}"
          MAX_CRITICAL_VULNS="${{ inputs.max_critical_vulns }}"
          MAX_HIGH_VULNS="${{ inputs.max_high_vulns }}"
          MAX_SEMGREP_FINDINGS="${{ inputs.max_semgrep_findings }}"
          MAX_PMD_VIOLATIONS="${{ inputs.max_pmd_violations }}"
          MAX_CHECKSTYLE_ERRORS="${{ inputs.max_checkstyle_errors }}"
          MAX_SPOTBUGS_BUGS="${{ inputs.max_spotbugs_bugs }}"

          # Check for .ci-hub.yml in repo
          if [ -f ".ci-hub.yml" ]; then
            echo "Found .ci-hub.yml, loading thresholds..."
            python3 << 'PYEOF'
          import yaml
          import os

          try:
              with open('.ci-hub.yml') as f:
                  data = yaml.safe_load(f) or {}
              thresholds = data.get('thresholds', {})
              if thresholds:
                  print(f"Loaded thresholds from .ci-hub.yml: {thresholds}")
                  # Write to env file for shell to pick up
                  with open('_thresholds_from_config.env', 'w') as ef:
                      for k, v in thresholds.items():
                          ef.write(f"{k.upper()}={v}\n")
          except Exception as e:
              print(f"Warning: could not read .ci-hub.yml: {e}")
          PYEOF
            if [ -f "_thresholds_from_config.env" ]; then
              source _thresholds_from_config.env
              rm -f _thresholds_from_config.env
            fi
          fi

          # Override with threshold_overrides_yaml if provided (highest precedence)
          OVERRIDES='${{ inputs.threshold_overrides_yaml }}'
          if [ -n "$OVERRIDES" ]; then
            echo "Applying threshold_overrides_yaml..."
            OVERRIDE_YAML="$OVERRIDES" python3 << 'PYEOF'
          import yaml
          import os

          try:
              data = yaml.safe_load(os.environ.get('OVERRIDE_YAML', '')) or {}
              with open('_thresholds_override.env', 'w') as ef:
                  for k, v in data.items():
                      ef.write(f"{k.upper()}={v}\n")
              print(f"Applied overrides: {data}")
          except Exception as e:
              print(f"Warning: could not parse threshold_overrides_yaml: {e}")
          PYEOF
            if [ -f "_thresholds_override.env" ]; then
              source _thresholds_override.env
              rm -f _thresholds_override.env
            fi
          fi

          # Export effective thresholds as outputs
          {
            echo "coverage_min=$COVERAGE_MIN"
            echo "mutation_score_min=$MUTATION_SCORE_MIN"
            echo "owasp_cvss_fail=$OWASP_CVSS_FAIL"
            echo "max_critical_vulns=$MAX_CRITICAL_VULNS"
            echo "max_high_vulns=$MAX_HIGH_VULNS"
            echo "max_semgrep_findings=$MAX_SEMGREP_FINDINGS"
            echo "max_pmd_violations=$MAX_PMD_VIOLATIONS"
            echo "max_checkstyle_errors=$MAX_CHECKSTYLE_ERRORS"
            echo "max_spotbugs_bugs=$MAX_SPOTBUGS_BUGS"
          } >> "$GITHUB_OUTPUT"

          echo "Effective thresholds:"
          echo "  coverage_min: $COVERAGE_MIN"
          echo "  mutation_score_min: $MUTATION_SCORE_MIN"
          echo "  owasp_cvss_fail: $OWASP_CVSS_FAIL"
          echo "  max_critical_vulns: $MAX_CRITICAL_VULNS"
          echo "  max_high_vulns: $MAX_HIGH_VULNS"

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Build and Test
        id: build
        # continue-on-error allows workflow to continue when tests fail,
        # enabling report generation and threshold enforcement
        continue-on-error: true
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            MVN_CMD="mvn"
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              MVN_CMD="./mvnw"
            fi

            # Step 1: Run the build lifecycle (may fail on tests)
            echo "Running: $MVN_CMD -B -ntp verify"
            $MVN_CMD -B -ntp verify || echo "Build/test phase completed with errors (expected for failing fixtures)"

            # Step 2: Run analysis tools separately with -DskipTests
            # This ensures they run even if tests failed above
            ANALYSIS_GOALS=""
            if [ "${{ inputs.run_checkstyle }}" = "true" ]; then
              ANALYSIS_GOALS="$ANALYSIS_GOALS checkstyle:checkstyle"
            fi
            if [ "${{ inputs.run_spotbugs }}" = "true" ]; then
              ANALYSIS_GOALS="$ANALYSIS_GOALS spotbugs:spotbugs"
            fi
            if [ "${{ inputs.run_owasp }}" = "true" ]; then
              ANALYSIS_GOALS="$ANALYSIS_GOALS dependency-check:check"
            fi

            if [ -n "$ANALYSIS_GOALS" ]; then
              # OWASP flags:
              #   -DnvdApiKey - NVD API key for faster vulnerability database updates
              #   -DnvdApiDelay=2500 - 2.5s delay between NVD API calls to avoid 403 rate limiting
              #   -DnvdMaxRetryCount=10 - retry failed API calls
              #   -Ddependencycheck.failOnError=false - don't fail build on vulnerabilities found
              USE_NVD_API_KEY="${{ inputs.use_nvd_api_key }}"
              if [ -z "$USE_NVD_API_KEY" ]; then
                USE_NVD_API_KEY="true"
              fi
              NVD_FLAGS=""
              if [ "$USE_NVD_API_KEY" = "true" ] && [ -n "$NVD_API_KEY" ]; then
                NVD_FLAGS="-DnvdApiKey=$NVD_API_KEY"
                echo "NVD API key configured - using accelerated vulnerability updates"
              elif [ "$USE_NVD_API_KEY" = "true" ]; then
                echo "Warning: use_nvd_api_key=true but NVD_API_KEY secret not set - vulnerability updates will be slow"
              else
                echo "NVD API key disabled via config"
              fi
              # shellcheck disable=SC2086 # ANALYSIS_GOALS and NVD_FLAGS intentionally unquoted for word splitting
              echo "Running analysis tools: $MVN_CMD -B -ntp -DskipTests $NVD_FLAGS -DnvdApiDelay=2500 -DnvdMaxRetryCount=10 -Ddependencycheck.failOnError=false $ANALYSIS_GOALS"
              # shellcheck disable=SC2086 # ANALYSIS_GOALS and NVD_FLAGS intentionally unquoted for word splitting
              $MVN_CMD -B -ntp -DskipTests $NVD_FLAGS -DnvdApiDelay=2500 -DnvdMaxRetryCount=10 -Ddependencycheck.failOnError=false $ANALYSIS_GOALS || echo "Some analysis tools completed with errors"
            fi
          else
            if [ -f "gradlew" ]; then
              chmod +x gradlew
              ./gradlew build
            else
              gradle build
            fi
          fi
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          MAVEN_OPTS: -Xmx1024m

      - name: Extract Test Counts
        id: test-counts
        if: always()
        run: |
          PASSED=0
          FAILED=0
          # Parse surefire XML reports for test counts
          while IFS= read -r xml; do
            TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml" | head -1 || echo 0)
            FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml" | head -1 || echo 0)
            ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml" | head -1 || echo 0)
            FAILED=$((FAILED + FAILURES + ERRORS))
            PASSED=$((PASSED + TESTS - FAILURES - ERRORS))
          done < <(find . -path "*/surefire-reports/*.xml" -name "TEST-*.xml" 2>/dev/null)
          {
            echo "passed=$PASSED"
            echo "failed=$FAILED"
          } >> "$GITHUB_OUTPUT"
          echo "Tests: $PASSED passed, $FAILED failed"

      - name: Extract jqwik Property Test Results
        id: jqwik-results
        if: always() && inputs.run_jqwik
        run: |
          # jqwik runs with JUnit 5, extract property test stats from surefire output
          # Look for jqwik test output patterns
          JQWIK_TESTS=0
          while IFS= read -r report; do
            if [ -f "$report" ]; then
              # Count jqwik property tests (they show in test reports)
              COUNT=$(grep -c "net.jqwik" "$report" 2>/dev/null || echo 0)
              JQWIK_TESTS=$((JQWIK_TESTS + COUNT))
            fi
          done < <(find . -path "*/surefire-reports/*.xml" -name "TEST-*.xml" 2>/dev/null)
          echo "tests=${JQWIK_TESTS:-0}" >> "$GITHUB_OUTPUT"
          echo "jqwik: ${JQWIK_TESTS:-0} property tests"

      - name: Extract Lint Results
        id: lint-results
        if: always()
        run: |
          # Checkstyle
          CHECKSTYLE_ISSUES=0
          if [ "${{ inputs.run_checkstyle }}" = "true" ]; then
            while IFS= read -r report; do
              if [ -f "$report" ]; then
                COUNT=$(grep -c "<error" "$report" 2>/dev/null || echo 0)
                CHECKSTYLE_ISSUES=$((CHECKSTYLE_ISSUES + COUNT))
              fi
            done < <(find . -name "checkstyle-result.xml" -type f 2>/dev/null)
          fi
          echo "checkstyle=$CHECKSTYLE_ISSUES" >> "$GITHUB_OUTPUT"

          # SpotBugs
          SPOTBUGS_ISSUES=0
          if [ "${{ inputs.run_spotbugs }}" = "true" ]; then
            while IFS= read -r report; do
              if [ -f "$report" ]; then
                COUNT=$(grep -c "<BugInstance" "$report" 2>/dev/null || echo 0)
                SPOTBUGS_ISSUES=$((SPOTBUGS_ISSUES + COUNT))
              fi
            done < <(find . -name "spotbugsXml.xml" -type f 2>/dev/null)
          fi
          echo "spotbugs=$SPOTBUGS_ISSUES" >> "$GITHUB_OUTPUT"

          # PMD - count from PMD report if it exists
          PMD_ISSUES=0
          if [ "${{ inputs.run_pmd }}" = "true" ]; then
            while IFS= read -r report; do
              if [ -f "$report" ]; then
                COUNT=$(grep -c "<violation" "$report" 2>/dev/null || echo 0)
                PMD_ISSUES=$((PMD_ISSUES + COUNT))
              fi
            done < <(find . -name "pmd.xml" -type f 2>/dev/null)
          fi
          echo "pmd=$PMD_ISSUES" >> "$GITHUB_OUTPUT"

          echo "Lint: Checkstyle=$CHECKSTYLE_ISSUES, SpotBugs=$SPOTBUGS_ISSUES, PMD=$PMD_ISSUES"

      - name: Extract Security Results
        id: security-results
        if: always()
        run: |
          # OWASP Dependency Check
          OWASP_CRITICAL=0
          OWASP_HIGH=0
          OWASP_MEDIUM=0
          if [ "${{ inputs.run_owasp }}" = "true" ]; then
            OWASP_REPORT=$(find . -name "dependency-check-report.json" -type f 2>/dev/null | head -1)
            if [ -n "$OWASP_REPORT" ] && [ -f "$OWASP_REPORT" ]; then
              OWASP_CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
              OWASP_HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
              OWASP_MEDIUM=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            fi
          fi
          {
            echo "owasp_critical=${OWASP_CRITICAL:-0}"
            echo "owasp_high=${OWASP_HIGH:-0}"
            echo "owasp_medium=${OWASP_MEDIUM:-0}"
          } >> "$GITHUB_OUTPUT"

          echo "Security: OWASP critical=$OWASP_CRITICAL, high=$OWASP_HIGH, medium=$OWASP_MEDIUM"

      - name: Extract Coverage
        id: coverage
        if: inputs.run_jacoco
        run: |
          # Find ALL JaCoCo reports (supports single-module and multi-module projects)
          TOTAL_COVERED=0
          TOTAL_MISSED=0
          FOUND_REPORTS=0

          # Create temp file for per-module data
          echo "" > /tmp/module_coverage.txt

          # Search recursively for all jacoco.xml files
          while IFS= read -r REPORT; do
            if [ -f "$REPORT" ]; then
              FOUND_REPORTS=$((FOUND_REPORTS + 1))
              COVERED=$(grep -oP 'INSTRUCTION.*?counter.*?covered="\K[0-9]+' "$REPORT" | head -1 || echo "0")
              MISSED=$(grep -oP 'INSTRUCTION.*?counter.*?missed="\K[0-9]+' "$REPORT" | head -1 || echo "0")
              TOTAL_COVERED=$((TOTAL_COVERED + ${COVERED:-0}))
              TOTAL_MISSED=$((TOTAL_MISSED + ${MISSED:-0}))

              # Extract module name from path (e.g., modules/01-spring-hello-rest/target/... -> 01-spring-hello-rest)
              MODULE_NAME=$(echo "$REPORT" | sed -E 's|.*/([^/]+)/target/.*|\1|' | sed 's|^\./||')
              if [ "$MODULE_NAME" = "target" ]; then
                MODULE_NAME="(root)"
              fi

              # Calculate per-module coverage
              MODULE_COV=0
              if [ $((COVERED + MISSED)) -gt 0 ]; then
                MODULE_COV=$((COVERED * 100 / (COVERED + MISSED)))
              fi
              echo "$MODULE_NAME|$MODULE_COV" >> /tmp/module_coverage.txt
              echo "Found: $REPORT ($MODULE_NAME: $MODULE_COV%)"
            fi
          done < <(find . -path "*/target/site/jacoco/jacoco.xml" -type f 2>/dev/null)

          # Calculate overall coverage
          COVERAGE=0
          if [ $((TOTAL_COVERED + TOTAL_MISSED)) -gt 0 ]; then
            COVERAGE=$((TOTAL_COVERED * 100 / (TOTAL_COVERED + TOTAL_MISSED)))
          fi

          echo "Found $FOUND_REPORTS JaCoCo report(s)"
          echo "Total: covered=$TOTAL_COVERED, missed=$TOTAL_MISSED"
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "module_count=$FOUND_REPORTS" >> "$GITHUB_OUTPUT"
          echo "Coverage: $COVERAGE%"

      - name: Check Coverage Threshold
        if: inputs.run_jacoco
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          MIN=${{ steps.thresholds.outputs.coverage_min }}
          if [ "$COVERAGE" -lt "$MIN" ]; then
            echo "::error::Coverage $COVERAGE% is below minimum $MIN%"
            exit 1
          fi

      - name: Enforce Checkstyle Threshold
        if: always() && inputs.run_checkstyle
        run: |
          ISSUES="${{ steps.lint-results.outputs.checkstyle }}"
          MAX="${{ steps.thresholds.outputs.max_checkstyle_errors }}"
          if [ "${ISSUES:-0}" -gt "${MAX:-0}" ]; then
            echo "::error::Checkstyle errors ($ISSUES) exceed max_checkstyle_errors ($MAX)"
            exit 1
          fi

      - name: Enforce SpotBugs Threshold
        if: always() && inputs.run_spotbugs
        run: |
          ISSUES="${{ steps.lint-results.outputs.spotbugs }}"
          MAX="${{ steps.thresholds.outputs.max_spotbugs_bugs }}"
          if [ "${ISSUES:-0}" -gt "${MAX:-0}" ]; then
            echo "::error::SpotBugs bugs ($ISSUES) exceed max_spotbugs_bugs ($MAX)"
            exit 1
          fi

      - name: Build Summary
        if: always()
        run: |
          {
            echo "## Tools Enabled"
            echo "| Category | Tool | Configured | Ran | Success |"
            echo "|----------|------|------------|-----|---------|"
            # Build always runs
            echo "| Build | ${{ inputs.build_tool }} | true | true | ${{ steps.build.outcome == 'success' }} |"
            # Testing tools
            echo "| Testing | JaCoCo Coverage | ${{ inputs.run_jacoco }} | ${{ inputs.run_jacoco == true && (steps.coverage.outcome == 'success' || steps.coverage.outcome == 'failure') }} | ${{ steps.coverage.outcome == 'success' }} |"
            echo "| Testing | PITest | ${{ inputs.run_pitest }} | false | false |"
            echo "| Testing | jqwik | ${{ inputs.run_jqwik }} | ${{ inputs.run_jqwik == true && (steps.jqwik-results.outcome == 'success' || steps.jqwik-results.outcome == 'failure') }} | ${{ steps.jqwik-results.outcome == 'success' }} |"
            # Linting tools
            echo "| Linting | Checkstyle | ${{ inputs.run_checkstyle }} | ${{ inputs.run_checkstyle == true && (steps.lint-results.outcome == 'success' || steps.lint-results.outcome == 'failure') }} | ${{ steps.lint-results.outcome == 'success' }} |"
            echo "| Linting | PMD | ${{ inputs.run_pmd }} | false | false |"
            echo "| Linting | SpotBugs | ${{ inputs.run_spotbugs }} | ${{ inputs.run_spotbugs == true && (steps.lint-results.outcome == 'success' || steps.lint-results.outcome == 'failure') }} | ${{ steps.lint-results.outcome == 'success' }} |"
            # Security tools
            echo "| Security | OWASP Dependency-Check | ${{ inputs.run_owasp }} | ${{ inputs.run_owasp == true && (steps.security-results.outcome == 'success' || steps.security-results.outcome == 'failure') }} | ${{ steps.security-results.outcome == 'success' }} |"
            echo "| Security | Semgrep | ${{ inputs.run_semgrep }} | false | false |"
            echo "| Security | Trivy | ${{ inputs.run_trivy }} | false | false |"
            echo "| Security | CodeQL | ${{ inputs.run_codeql }} | false | false |"
            # Container tools
            echo "| Container | Docker | ${{ inputs.run_docker }} | false | false |"
            echo ""
            echo "## Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Min Coverage | ${{ steps.thresholds.outputs.coverage_min }}% |"
            echo "| Min Mutation Score | ${{ steps.thresholds.outputs.mutation_score_min }}% |"
            echo "| OWASP CVSS Fail | ${{ steps.thresholds.outputs.owasp_cvss_fail }} |"
            echo "| Max Critical Vulns | ${{ steps.thresholds.outputs.max_critical_vulns }} |"
            echo "| Max High Vulns | ${{ steps.thresholds.outputs.max_high_vulns }} |"
            echo "| Max Semgrep Findings | ${{ steps.thresholds.outputs.max_semgrep_findings }} |"
            echo "| Max PMD Violations | ${{ steps.thresholds.outputs.max_pmd_violations }} |"
            echo "| Max Checkstyle Errors | ${{ steps.thresholds.outputs.max_checkstyle_errors }} |"
            echo "| Max SpotBugs Bugs | ${{ steps.thresholds.outputs.max_spotbugs_bugs }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            if [ -f "pom.xml" ] && grep -q "<modules>" pom.xml 2>/dev/null; then
              MODULE_COUNT=$(grep -c "<module>" pom.xml 2>/dev/null || echo "0")
              echo "| Project Type | Multi-module ($MODULE_COUNT modules) |"
            else
              echo "| Project Type | Single module |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo ""
            echo "#### Testing"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            TESTS_FAILED="${{ steps.test-counts.outputs.failed || 0 }}"
            MIN_COVERAGE="${{ steps.thresholds.outputs.coverage_min }}"
            STATUS="PASS"
            if [ "${TESTS_FAILED:-0}" -gt 0 ]; then
              STATUS="FAIL"
            fi
            if [ "${{ inputs.run_jacoco }}" = "true" ]; then
              COVERAGE="${{ steps.coverage.outputs.percentage || 0 }}"
              if [ "${COVERAGE:-0}" -lt "${MIN_COVERAGE:-0}" ]; then
                STATUS="FAIL"
              fi
              COVERAGE_DETAIL="coverage: ${COVERAGE:-0}% (min ${MIN_COVERAGE:-0}%)"
            else
              COVERAGE_DETAIL="coverage: N/A (JaCoCo disabled)"
            fi
            echo "| Build/Test | $STATUS | passed: ${{ steps.test-counts.outputs.passed || 0 }}, failed: ${TESTS_FAILED:-0}, ${COVERAGE_DETAIL} |"

            if [ "${{ inputs.run_jqwik }}" = "true" ]; then
              JQWIK_OUTCOME="${{ steps.jqwik-results.outcome }}"
              if [ "$JQWIK_OUTCOME" = "success" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| jqwik | $STATUS | property tests: ${{ steps.jqwik-results.outputs.tests || 0 }} |"
            else
              echo "| jqwik | SKIP | - |"
            fi

            echo ""
            echo "#### Lint"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ "${{ inputs.run_checkstyle }}" = "true" ]; then
              ISSUES="${{ steps.lint-results.outputs.checkstyle }}"
              MAX="${{ steps.thresholds.outputs.max_checkstyle_errors || 0 }}"
              if [ "${ISSUES:-0}" -le "${MAX:-0}" ] 2>/dev/null; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Checkstyle | $STATUS | issues: ${ISSUES:-0} (max ${MAX:-0}) |"
            else
              echo "| Checkstyle | SKIP | - |"
            fi

            if [ "${{ inputs.run_spotbugs }}" = "true" ]; then
              ISSUES="${{ steps.lint-results.outputs.spotbugs }}"
              MAX="${{ steps.thresholds.outputs.max_spotbugs_bugs || 0 }}"
              if [ "${ISSUES:-0}" -le "${MAX:-0}" ] 2>/dev/null; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| SpotBugs | $STATUS | issues: ${ISSUES:-0} (max ${MAX:-0}) |"
            else
              echo "| SpotBugs | SKIP | - |"
            fi

            if [ "${{ inputs.run_pmd }}" = "true" ]; then
              echo "| PMD | ENABLED | See PMD job |"
            else
              echo "| PMD | SKIP | - |"
            fi

            echo ""
            echo "#### Security"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ "${{ inputs.run_owasp }}" = "true" ]; then
              CRITICAL="${{ steps.security-results.outputs.owasp_critical }}"
              HIGH="${{ steps.security-results.outputs.owasp_high }}"
              MEDIUM="${{ steps.security-results.outputs.owasp_medium }}"
              MAX_CRIT="${{ steps.thresholds.outputs.max_critical_vulns || 0 }}"
              MAX_HIGH="${{ steps.thresholds.outputs.max_high_vulns || 0 }}"
              if [ "${CRITICAL:-0}" -le "${MAX_CRIT:-0}" ] && [ "${HIGH:-0}" -le "${MAX_HIGH:-0}" ] 2>/dev/null; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| OWASP | $STATUS | critical: ${CRITICAL:-0} (max ${MAX_CRIT:-0}), high: ${HIGH:-0} (max ${MAX_HIGH:-0}), medium: ${MEDIUM:-0} |"
            else
              echo "| OWASP | SKIP | - |"
            fi

            if [ "${{ inputs.run_semgrep }}" = "true" ]; then
              echo "| Semgrep | ENABLED | See Semgrep job |"
            else
              echo "| Semgrep | SKIP | - |"
            fi

            if [ "${{ inputs.run_trivy }}" = "true" ]; then
              echo "| Trivy | ENABLED | See Trivy job |"
            else
              echo "| Trivy | SKIP | - |"
            fi

            if [ "${{ inputs.run_codeql }}" = "true" ]; then
              echo "| CodeQL | ENABLED | See CodeQL job |"
            else
              echo "| CodeQL | SKIP | - |"
            fi

            MODULE_COUNT="${{ steps.coverage.outputs.module_count }}"
            if [ "${MODULE_COUNT:-0}" -gt 1 ] && [ -f /tmp/module_coverage.txt ]; then
              echo ""
              echo "#### Coverage by Module"
              echo "| Module | Coverage |"
              echo "|--------|----------|"
              while IFS='|' read -r MODULE COV; do
                if [ -n "$MODULE" ]; then
                  echo "| $MODULE | $COV% |"
                fi
              done < /tmp/module_coverage.txt
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ---- Upload Artifacts ----
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}test-reports
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload JaCoCo Reports
        if: always() && inputs.run_jacoco
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}jacoco-reports
          path: '**/target/site/jacoco/'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload Checkstyle Reports
        if: always() && inputs.run_checkstyle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}checkstyle-reports
          path: '**/target/checkstyle-result.xml'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload SpotBugs Reports
        if: always() && inputs.run_spotbugs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}spotbugs-reports
          path: |
            **/target/spotbugsXml.xml
            **/target/spotbugs.html
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload OWASP Reports
        if: always() && inputs.run_owasp
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}owasp-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce OWASP Thresholds
        if: always() && inputs.run_owasp
        run: |
          REPORT=$(find . -name "dependency-check-report.json" -print -quit)
          CRITICAL=0
          HIGH=0
          MAX_CRITICAL="${{ steps.thresholds.outputs.max_critical_vulns || 0 }}"
          MAX_HIGH="${{ steps.thresholds.outputs.max_high_vulns || 0 }}"
          if [ -n "$REPORT" ] && [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
          else
            echo "::warning::dependency-check-report.json not found; skipping vulnerability threshold enforcement"
          fi

          if [ "$CRITICAL" -gt "$MAX_CRITICAL" ]; then
            echo "::error::Critical vulnerabilities ($CRITICAL) exceed max_critical_vulns $MAX_CRITICAL"
            exit 1
          fi
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "::error::High vulnerabilities ($HIGH) exceed max_high_vulns $MAX_HIGH"
            exit 1
          fi

          # CVSS-based enforcement
          CVSS_THRESHOLD="${{ steps.thresholds.outputs.owasp_cvss_fail }}"
          if [ -n "$REPORT" ] && [ -f "$REPORT" ]; then
            MAX_CVSS=$(jq '
              [.dependencies[]?.vulnerabilities[]? |
               (.cvssv3?.baseScore // .cvssv2?.score // .cvssData?.baseScore // 0)] | max // 0
            ' "$REPORT" 2>/dev/null || echo 0)

            # Default to 0 if empty to avoid awk errors
            MAX_CVSS="${MAX_CVSS:-0}"

            if awk "BEGIN {exit !($MAX_CVSS >= $CVSS_THRESHOLD)}"; then
              echo "::error::OWASP found vulnerability with CVSS $MAX_CVSS >= threshold $CVSS_THRESHOLD"
              exit 1
            fi
          fi

      - name: Upload to Codecov
        if: inputs.run_jacoco
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: '**/target/site/jacoco/jacoco.xml'
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # PMD Static Analysis
  # ============================================================================
  pmd:
    name: PMD Analysis
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && inputs.run_pmd
    outputs:
      violations: ${{ steps.pmd.outputs.violations }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Run PMD
        id: pmd
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp pmd:check || true
            else
              mvn -B -ntp pmd:check || true
            fi
          fi

          # Count violations
          VIOLATIONS=0
          while IFS= read -r xml; do
            COUNT=$(grep -c "<violation" "$xml" 2>/dev/null || echo 0)
            VIOLATIONS=$((VIOLATIONS + COUNT))
          done < <(find . -name "pmd.xml" 2>/dev/null)

          echo "violations=$VIOLATIONS" >> "$GITHUB_OUTPUT"
          echo "PMD Violations: $VIOLATIONS"
        continue-on-error: true

      - name: PMD Summary
        if: always()
        run: |
          {
            echo "## PMD Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Linting | PMD | ${{ inputs.run_pmd }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max PMD Violations | ${{ needs.build-test.outputs.eff_max_pmd_violations }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            VIOLATIONS="${{ steps.pmd.outputs.violations || 0 }}"
            MAX_VIOLATIONS="${{ needs.build-test.outputs.eff_max_pmd_violations || 0 }}"
            if [ "${VIOLATIONS:-0}" -le "${MAX_VIOLATIONS:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| PMD | $STATUS | violations: ${VIOLATIONS:-0} (max ${MAX_VIOLATIONS:-0}) |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload PMD Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}pmd-reports
          path: '**/target/pmd.xml'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce PMD Violations
        run: |
          VIOLATIONS=${{ steps.pmd.outputs.violations || 0 }}
          MAX_VIOLATIONS=${{ needs.build-test.outputs.eff_max_pmd_violations || 0 }}
          if [ "$VIOLATIONS" -gt "$MAX_VIOLATIONS" ]; then
            echo "::error::PMD reported $VIOLATIONS violations (max: $MAX_VIOLATIONS)"
            exit 1
          fi

  # ============================================================================
  # Semgrep SAST
  # ============================================================================
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && inputs.run_semgrep
    outputs:
      findings: ${{ steps.semgrep.outputs.findings }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        id: semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true

          FINDINGS=0
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)
          fi

          echo "findings=$FINDINGS" >> "$GITHUB_OUTPUT"
          echo "Semgrep Findings: $FINDINGS"
        continue-on-error: true

      - name: Semgrep Summary
        if: always()
        run: |
          {
            echo "## Semgrep SAST Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | Semgrep | ${{ inputs.run_semgrep }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max Semgrep Findings | ${{ needs.build-test.outputs.eff_max_semgrep_findings }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            FINDINGS="${{ steps.semgrep.outputs.findings || 0 }}"
            MAX_FINDINGS="${{ needs.build-test.outputs.eff_max_semgrep_findings || 0 }}"
            if [ "${FINDINGS:-0}" -le "${MAX_FINDINGS:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| Semgrep | $STATUS | findings: ${FINDINGS:-0} (max ${MAX_FINDINGS:-0}) |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Semgrep Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}semgrep-report
          path: semgrep-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Semgrep Threshold
        run: |
          FINDINGS=${{ steps.semgrep.outputs.findings || 0 }}
          MAX_FINDINGS=${{ needs.build-test.outputs.eff_max_semgrep_findings || 0 }}
          if [ "$FINDINGS" -gt "$MAX_FINDINGS" ]; then
            echo "::error::Semgrep reported $FINDINGS findings (max: $MAX_FINDINGS)"
            exit 1
          fi

  # ============================================================================
  # Trivy Container Scan
  # ============================================================================
  trivy:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && inputs.run_trivy
    outputs:
      critical: ${{ steps.trivy-parse.outputs.critical }}
      high: ${{ steps.trivy-parse.outputs.high }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for Dockerfile
        id: check-dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No Dockerfile found - skipping Trivy container scan"
          fi

      - name: Run Trivy Scan
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: 'fs'
          scan-ref: ${{ inputs.workdir }}
          format: 'json'
          output: 'trivy-report.json'
        continue-on-error: true

      - name: Parse Trivy Results
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy-parse
        run: |
          CRITICAL=0
          HIGH=0
          # trivy-action outputs to workspace root, not working-directory
          REPORT="${{ github.workspace }}/trivy-report.json"
          if [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> "$GITHUB_OUTPUT"
          echo "high=$HIGH" >> "$GITHUB_OUTPUT"
          echo "Trivy: $CRITICAL critical, $HIGH high"

      - name: Trivy Summary
        if: always()
        run: |
          {
            echo "## Trivy Container Scan Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | Trivy | ${{ inputs.run_trivy }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max Critical Vulns | ${{ needs.build-test.outputs.eff_max_critical_vulns }} |"
            echo "| Max High Vulns | ${{ needs.build-test.outputs.eff_max_high_vulns }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ "${{ steps.check-dockerfile.outputs.exists }}" != "true" ]; then
              echo "| Trivy | SKIP | No Dockerfile found |"
            else
              CRIT="${{ steps.trivy-parse.outputs.critical || 0 }}"
              HIGH="${{ steps.trivy-parse.outputs.high || 0 }}"
              MAX_CRIT="${{ needs.build-test.outputs.eff_max_critical_vulns || 0 }}"
              MAX_HIGH="${{ needs.build-test.outputs.eff_max_high_vulns || 0 }}"
              if [ "${CRIT:-0}" -le "${MAX_CRIT:-0}" ] && [ "${HIGH:-0}" -le "${MAX_HIGH:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Trivy | $STATUS | critical: ${CRIT:-0} (max ${MAX_CRIT:-0}), high: ${HIGH:-0} (max ${MAX_HIGH:-0}) |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Trivy Report
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}trivy-report
          path: ${{ github.workspace }}/trivy-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Trivy Thresholds
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          CRIT="${{ steps.trivy-parse.outputs.critical || 0 }}"
          HIGH="${{ steps.trivy-parse.outputs.high || 0 }}"
          MAX_CRITICAL="${{ needs.build-test.outputs.eff_max_critical_vulns || 0 }}"
          MAX_HIGH="${{ needs.build-test.outputs.eff_max_high_vulns || 0 }}"
          if [ "$CRIT" -gt "$MAX_CRITICAL" ]; then
            echo "::error::Trivy critical findings ($CRIT) exceed max_critical_vulns $MAX_CRITICAL"
            exit 1
          fi
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "::error::Trivy high findings ($HIGH) exceed max_high_vulns $MAX_HIGH"
            exit 1
          fi

          # CVSS-based enforcement
          CVSS_THRESHOLD="${{ needs.build-test.outputs.eff_owasp_cvss_fail }}"
          REPORT="${{ github.workspace }}/trivy-report.json"
          if [ -f "$REPORT" ]; then
            MAX_CVSS=$(jq '
              [.Results[]?.Vulnerabilities[]?.CVSS | to_entries[]?.value |
               (.V3Score // .V2Score // 0)] | max // 0
            ' "$REPORT" 2>/dev/null || echo 0)

            # Default to 0 if empty to avoid awk errors
            MAX_CVSS="${MAX_CVSS:-0}"

            if awk "BEGIN {exit !($MAX_CVSS >= $CVSS_THRESHOLD)}"; then
              echo "::error::Trivy found vulnerability with CVSS $MAX_CVSS >= threshold $CVSS_THRESHOLD"
              exit 1
            fi
          fi

  # ============================================================================
  # Mutation Testing
  # ============================================================================
  mutation-test:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && inputs.run_pitest
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}
    outputs:
      score: ${{ steps.pitest.outputs.score }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Run PITest
        id: pitest
        run: |
          PITEST_EXIT=0
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              # Note: Do NOT use -DskipTests with PITest - it needs to run tests to detect killed mutations
              ./mvnw -B -ntp test-compile org.pitest:pitest-maven:mutationCoverage || PITEST_EXIT=$?
            else
              mvn -B -ntp test-compile org.pitest:pitest-maven:mutationCoverage || PITEST_EXIT=$?
            fi
          fi

          if [ "$PITEST_EXIT" -ne 0 ]; then
            echo "::warning::PITest exited with code $PITEST_EXIT"
          fi

          # Extract mutation score from ALL modules (supports multi-module projects)
          # Note: PITest uses single quotes in XML (status='KILLED'), so we match both quote styles
          TOTAL_KILLED=0
          TOTAL_SURVIVED=0
          FOUND_REPORTS=0

          # Create temp file for per-module data
          echo "" > /tmp/module_mutations.txt

          echo "Looking for pit-reports/mutations.xml..."
          while IFS= read -r REPORT; do
            if [ -f "$REPORT" ]; then
              FOUND_REPORTS=$((FOUND_REPORTS + 1))
              KILLED=$(grep -cE "status=['\"]KILLED['\"]" "$REPORT" || echo "0")
              SURVIVED=$(grep -cE "status=['\"]SURVIVED['\"]" "$REPORT" || echo "0")
              TOTAL_KILLED=$((TOTAL_KILLED + ${KILLED:-0}))
              TOTAL_SURVIVED=$((TOTAL_SURVIVED + ${SURVIVED:-0}))

              # Extract module name from path
              MODULE_NAME=$(echo "$REPORT" | sed -E 's|.*/([^/]+)/target/.*|\1|' | sed 's|^\./||')
              if [ "$MODULE_NAME" = "target" ]; then
                MODULE_NAME="(root)"
              fi

              # Calculate per-module score
              MODULE_SCORE=0
              MODULE_TOTAL=$((KILLED + SURVIVED))
              if [ "$MODULE_TOTAL" -gt 0 ]; then
                MODULE_SCORE=$((KILLED * 100 / MODULE_TOTAL))
              fi
              echo "$MODULE_NAME|$MODULE_SCORE|$KILLED|$SURVIVED" >> /tmp/module_mutations.txt
              echo "Found: $REPORT ($MODULE_NAME: $MODULE_SCORE%)"
            fi
          done < <(find . -path "*/target/pit-reports/mutations.xml" -type f 2>/dev/null)

          # Calculate overall mutation score
          SCORE=0
          TOTAL=$((TOTAL_KILLED + TOTAL_SURVIVED))
          if [ "$TOTAL" -gt 0 ]; then
            SCORE=$((TOTAL_KILLED * 100 / TOTAL))
          fi

          if [ "$FOUND_REPORTS" -eq 0 ]; then
            echo "::warning::No mutations.xml found - PITest may not have run"
          else
            echo "Found $FOUND_REPORTS PITest report(s)"
          fi
          echo "Total: killed=$TOTAL_KILLED, survived=$TOTAL_SURVIVED"
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "module_count=$FOUND_REPORTS" >> "$GITHUB_OUTPUT"
          echo "Mutation Score: $SCORE%"

      - name: Check Mutation Threshold
        run: |
          SCORE=${{ steps.pitest.outputs.score }}
          MIN=${{ needs.build-test.outputs.eff_mutation_score_min }}
          if [ "$SCORE" -lt "$MIN" ]; then
            echo "::error::Mutation score $SCORE% is below minimum $MIN%"
            exit 1
          fi

      - name: Mutation Summary
        if: always()
        run: |
          {
            echo "## Mutation Testing Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Testing | PITest | ${{ inputs.run_pitest }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Min Mutation Score | ${{ needs.build-test.outputs.eff_mutation_score_min }}% |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            SCORE="${{ steps.pitest.outputs.score || 0 }}"
            MIN_SCORE="${{ needs.build-test.outputs.eff_mutation_score_min }}"
            if [ "${SCORE:-0}" -ge "${MIN_SCORE:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| PITest | $STATUS | score: ${SCORE:-0}% (min ${MIN_SCORE:-0}%) |"

            MODULE_COUNT="${{ steps.pitest.outputs.module_count }}"
            if [ "${MODULE_COUNT:-0}" -gt 1 ] && [ -f /tmp/module_mutations.txt ]; then
              echo ""
              echo "#### Mutations by Module"
              echo "| Module | Score | Killed | Survived |"
              echo "|--------|-------|--------|----------|"
              while IFS='|' read -r MODULE SCORE KILLED SURVIVED; do
                if [ -n "$MODULE" ]; then
                  echo "| $MODULE | $SCORE% | $KILLED | $SURVIVED |"
                fi
              done < /tmp/module_mutations.txt
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload PITest Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ inputs.artifact_prefix }}pitest-reports
          path: '**/target/pit-reports/'
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

  # ============================================================================
  # Docker Build & Test
  # ============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && inputs.run_docker
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build Docker Image
        id: docker-build
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t ${{ github.repository }}:ci-test .
          fi

      - name: Test with Docker Compose
        id: docker-compose-test
        if: hashFiles(inputs.docker_compose_file) != ''
        run: |
          docker compose -f ${{ inputs.docker_compose_file }} up -d

          # Wait for health check
          echo "Waiting for services to be healthy..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080${{ inputs.docker_health_endpoint }} > /dev/null 2>&1; then
              echo "Service is healthy!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 10
          done

          # Show logs
          docker compose logs

          # Cleanup
          docker compose down

      - name: Docker Summary
        if: always()
        run: |
          {
            echo "## Docker Build Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Container | Docker | ${{ inputs.run_docker }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            COMPOSE_FILE="${{ inputs.docker_compose_file }}"
            if [ ! -f "Dockerfile" ]; then
              echo "| Docker | SKIP | No Dockerfile found |"
            else
              BUILD_STATUS="${{ steps.docker-build.outcome }}"
              COMPOSE_STATUS="${{ steps.docker-compose-test.outcome }}"
              if [ -f "$COMPOSE_FILE" ] && [ "$COMPOSE_STATUS" != "success" ]; then
                STATUS="FAIL"
              elif [ "$BUILD_STATUS" != "success" ]; then
                STATUS="FAIL"
              else
                STATUS="PASS"
              fi
              if [ -f "$COMPOSE_FILE" ]; then
                DETAILS="build: ${BUILD_STATUS:-unknown}, compose: ${COMPOSE_STATUS:-skipped}"
              else
                DETAILS="build: ${BUILD_STATUS:-unknown}, compose: skipped (no compose file)"
              fi
              echo "| Docker | $STATUS | $DETAILS |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # CodeQL Security Analysis
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: inputs.run_codeql
    permissions:
      security-events: write
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7
        with:
          languages: java
          # Scope analysis to workdir only
          source-root: ${{ inputs.workdir }}

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Build for CodeQL
        run: |
          if [ "${{ inputs.build_tool }}" = "maven" ]; then
            if [ -f "mvnw" ]; then
              chmod +x mvnw
              ./mvnw -B -ntp compile -DskipTests
            else
              mvn -B -ntp compile -DskipTests
            fi
          else
            if [ -f "gradlew" ]; then
              chmod +x gradlew
              ./gradlew compileJava
            else
              gradle compileJava
            fi
          fi

      - name: Perform CodeQL Analysis
        id: codeql-analyze
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7

      - name: CodeQL Summary
        if: always()
        run: |
          {
            echo "## CodeQL Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | CodeQL | ${{ inputs.run_codeql }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${{ inputs.java_version }} |"
            echo "| Build Tool | ${{ inputs.build_tool }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${{ inputs.run_docker }}" = "true" ]; then
              echo "| Docker Compose | \`${{ inputs.docker_compose_file }}\` |"
              echo "| Health Endpoint | \`${{ inputs.docker_health_endpoint }}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            OUTCOME="${{ steps.codeql-analyze.outcome }}"
            if [ "$OUTCOME" = "success" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| CodeQL | $STATUS | outcome: ${OUTCOME:-unknown} (see Security tab) |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Generate Final Report
  # ============================================================================
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [build-test, pmd, mutation-test, semgrep, trivy]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        if: always()
        continue-on-error: true
        with:
          path: all-reports/

      - name: Generate Combined Report
        run: |
          # Extract vulnerability counts from OWASP report
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MEDIUM_VULNS=0
          OWASP_CRITICAL=0
          OWASP_HIGH=0

          OWASP_REPORT=$(find all-reports -name "dependency-check-report.json" 2>/dev/null | head -1)
          if [ -n "$OWASP_REPORT" ] && [ -f "$OWASP_REPORT" ]; then
            OWASP_CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            OWASP_HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            MEDIUM_VULNS=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")] | length' "$OWASP_REPORT" 2>/dev/null || echo 0)
            CRITICAL_VULNS=$OWASP_CRITICAL
            HIGH_VULNS=$OWASP_HIGH
          fi

          # Extract Trivy vulnerability counts if available
          TRIVY_CRITICAL=0
          TRIVY_HIGH=0
          TRIVY_REPORT=$(find all-reports -name "trivy-report.json" 2>/dev/null | head -1)
          if [ -n "$TRIVY_REPORT" ] && [ -f "$TRIVY_REPORT" ]; then
            TRIVY_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            CRITICAL_VULNS=$((CRITICAL_VULNS + TRIVY_CRITICAL))
            HIGH_VULNS=$((HIGH_VULNS + TRIVY_HIGH))
            MEDIUM_VULNS=$((MEDIUM_VULNS + TRIVY_MEDIUM))
          fi

          # Extract checkstyle issues from artifact
          CHECKSTYLE_ISSUES=0
          CHECKSTYLE_REPORT=$(find all-reports -name "checkstyle-result.xml" 2>/dev/null | head -1)
          if [ -n "$CHECKSTYLE_REPORT" ] && [ -f "$CHECKSTYLE_REPORT" ]; then
            CHECKSTYLE_ISSUES=$(grep -c "<error" "$CHECKSTYLE_REPORT" 2>/dev/null || echo 0)
          fi

          # Extract spotbugs issues from artifact
          SPOTBUGS_ISSUES=0
          SPOTBUGS_REPORT=$(find all-reports -name "spotbugsXml.xml" 2>/dev/null | head -1)
          if [ -n "$SPOTBUGS_REPORT" ] && [ -f "$SPOTBUGS_REPORT" ]; then
            SPOTBUGS_ISSUES=$(grep -c "<BugInstance" "$SPOTBUGS_REPORT" 2>/dev/null || echo 0)
          fi

          cat > report.json << EOF
          {
            "schema_version": "2.0",
            "metadata": {
              "workflow_version": "v1.0.0",
              "workflow_ref": "${{ github.repository }}/.github/workflows/java-ci.yml@${{ github.ref_name }}",
              "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            },
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "hub_correlation_id": "${{ inputs.hub_correlation_id }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "java_version": "${{ inputs.java_version }}",
            "results": {
              "build": "${{ needs.build-test.outputs.status }}",
              "coverage": ${{ needs.build-test.outputs.coverage || 0 }},
              "mutation_score": ${{ needs.mutation-test.outputs.score || 0 }},
              "tests_passed": ${{ needs.build-test.outputs.tests_passed || 0 }},
              "tests_failed": ${{ needs.build-test.outputs.tests_failed || 0 }},
              "critical_vulns": ${CRITICAL_VULNS},
              "high_vulns": ${HIGH_VULNS},
              "medium_vulns": ${MEDIUM_VULNS}
            },
            "tool_metrics": {
              "checkstyle_issues": ${CHECKSTYLE_ISSUES},
              "spotbugs_issues": ${SPOTBUGS_ISSUES},
              "pmd_violations": ${{ needs.pmd.outputs.violations || 0 }},
              "owasp_critical": ${OWASP_CRITICAL},
              "owasp_high": ${OWASP_HIGH},
              "semgrep_findings": ${{ needs.semgrep.outputs.findings || 0 }},
              "trivy_critical": ${{ needs.trivy.outputs.critical || 0 }},
              "trivy_high": ${{ needs.trivy.outputs.high || 0 }}
            },
            "tools_configured": {
              "jacoco": ${{ inputs.run_jacoco }},
              "checkstyle": ${{ inputs.run_checkstyle }},
              "spotbugs": ${{ inputs.run_spotbugs }},
              "pmd": ${{ inputs.run_pmd }},
              "owasp": ${{ inputs.run_owasp }},
              "pitest": ${{ inputs.run_pitest }},
              "jqwik": ${{ inputs.run_jqwik }},
              "semgrep": ${{ inputs.run_semgrep }},
              "trivy": ${{ inputs.run_trivy }},
              "codeql": ${{ inputs.run_codeql }},
              "docker": ${{ inputs.run_docker }}
            },
            "tools_ran": {
              "jacoco": ${{ inputs.run_jacoco == true && needs.build-test.result != 'skipped' }},
              "checkstyle": ${{ inputs.run_checkstyle == true && needs.build-test.result != 'skipped' }},
              "spotbugs": ${{ inputs.run_spotbugs == true && needs.build-test.result != 'skipped' }},
              "pmd": ${{ inputs.run_pmd == true && needs.pmd.result != 'skipped' }},
              "owasp": ${{ inputs.run_owasp == true && needs.build-test.result != 'skipped' }},
              "pitest": ${{ inputs.run_pitest == true && needs.mutation-test.result != 'skipped' }},
              "jqwik": ${{ inputs.run_jqwik == true && needs.build-test.result != 'skipped' }},
              "semgrep": ${{ inputs.run_semgrep == true && needs.semgrep.result != 'skipped' }},
              "trivy": ${{ inputs.run_trivy == true && needs.trivy.result != 'skipped' }},
              "codeql": ${{ inputs.run_codeql == true }},
              "docker": ${{ inputs.run_docker == true }}
            },
            "tools_success": {
              "jacoco": ${{ inputs.run_jacoco == true && needs.build-test.result == 'success' }},
              "checkstyle": ${{ inputs.run_checkstyle == true && needs.build-test.result == 'success' }},
              "spotbugs": ${{ inputs.run_spotbugs == true && needs.build-test.result == 'success' }},
              "pmd": ${{ inputs.run_pmd == true && needs.pmd.result == 'success' }},
              "owasp": ${{ inputs.run_owasp == true && needs.build-test.result == 'success' }},
              "pitest": ${{ inputs.run_pitest == true && needs.mutation-test.result == 'success' }},
              "jqwik": ${{ inputs.run_jqwik == true && needs.build-test.result == 'success' }},
              "semgrep": ${{ inputs.run_semgrep == true && needs.semgrep.result == 'success' }},
              "trivy": ${{ inputs.run_trivy == true && needs.trivy.result == 'success' }},
              "codeql": ${{ inputs.run_codeql == true }},
              "docker": ${{ inputs.run_docker == true }}
            },
            "thresholds": {
              "coverage_min": ${{ needs.build-test.outputs.eff_coverage_min }},
              "mutation_score_min": ${{ needs.build-test.outputs.eff_mutation_score_min }},
              "owasp_cvss_fail": ${{ needs.build-test.outputs.eff_owasp_cvss_fail }},
              "max_pmd_violations": ${{ needs.build-test.outputs.eff_max_pmd_violations }},
              "max_critical_vulns": ${{ needs.build-test.outputs.eff_max_critical_vulns }},
              "max_high_vulns": ${{ needs.build-test.outputs.eff_max_high_vulns }},
              "max_semgrep_findings": ${{ needs.build-test.outputs.eff_max_semgrep_findings }},
              "max_checkstyle_errors": ${{ needs.build-test.outputs.eff_max_checkstyle_errors }},
              "max_spotbugs_bugs": ${{ needs.build-test.outputs.eff_max_spotbugs_bugs }}
            }
          }
          EOF

          cat report.json

      - name: Upload Combined Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: report.json
          retention-days: ${{ inputs.retention_days }}

      - name: Report Summary
        if: always()
        env:
          INPUT_JAVA_VERSION: ${{ inputs.java_version }}
          INPUT_BUILD_TOOL: ${{ inputs.build_tool }}
          INPUT_WORKDIR: ${{ inputs.workdir }}
          INPUT_RETENTION_DAYS: ${{ inputs.retention_days }}
          INPUT_ARTIFACT_PREFIX: ${{ inputs.artifact_prefix }}
          INPUT_RUN_DOCKER: ${{ inputs.run_docker }}
          INPUT_DOCKER_COMPOSE_FILE: ${{ inputs.docker_compose_file }}
          INPUT_DOCKER_HEALTH_ENDPOINT: ${{ inputs.docker_health_endpoint }}
        run: |
          {
            echo "## Report Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Reporting | ci-report | true |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Java Version | ${INPUT_JAVA_VERSION} |"
            echo "| Build Tool | ${INPUT_BUILD_TOOL} |"
            WORKDIR="${INPUT_WORKDIR}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${INPUT_RETENTION_DAYS} days |"
            PREFIX="${INPUT_ARTIFACT_PREFIX}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            if [ "${INPUT_RUN_DOCKER}" = "true" ]; then
              echo "| Docker Compose | \`${INPUT_DOCKER_COMPOSE_FILE}\` |"
              echo "| Health Endpoint | \`${INPUT_DOCKER_HEALTH_ENDPOINT}\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            if [ -f "report.json" ]; then
              STATUS="PASS"
              DETAILS="report.json generated"
            else
              STATUS="FAIL"
              DETAILS="report.json missing"
            fi
            echo "| ci-report | $STATUS | $DETAILS |"
          } >> "$GITHUB_STEP_SUMMARY"
