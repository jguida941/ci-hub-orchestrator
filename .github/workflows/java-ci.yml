# ============================================================================
# CI/CD Hub - Java CI Workflow
# ============================================================================
#
# Reusable workflow with boolean toggles for Java testing, linting, and
# security scanning. Configure tools via .ci-hub.yml, run via `cihub ci`.
#
# HOW IT WORKS:
#   1. Your repo calls this workflow via `uses:`
#   2. This workflow installs and runs `cihub ci`
#   3. cihub reads YOUR .ci-hub.yml config file
#   4. Tools execute based on YOUR enabled: true/false toggles
#   5. Report + summary written to .cihub/ directory
#
# TOGGLE CONFIGURATION (in your repo's .ci-hub.yml):
#   java:
#     tools:
#       jacoco:    { enabled: true }   # Coverage
#       pitest:    { enabled: true }   # Mutation testing
#       checkstyle:{ enabled: true }   # Style checks
#       spotbugs:  { enabled: true }   # Static analysis
#       pmd:       { enabled: true }   # Static analysis
#       owasp:     { enabled: true }   # Dependency scan
#       jqwik:     { enabled: false }  # Property-based testing
#       semgrep:   { enabled: false }  # SAST (expensive, opt-in)
#       trivy:     { enabled: false }  # Container scan (expensive, opt-in)
#       codeql:    { enabled: false }  # CodeQL (expensive, opt-in)
#       docker:    { enabled: false }  # Docker build/test (opt-in)
#
# QUICK START WITH PROFILES (hub-side config):
#   Use a pre-built profile to generate hub configs:
#     cihub new myrepo --profile java-minimal     # Coverage + lint (~5-10 min)
#     cihub new myrepo --profile java-quality     # Core tools (~15-30 min)
#     cihub new myrepo --profile java-security    # + semgrep, trivy, codeql
#
# THRESHOLDS (quality gates in .ci-hub.yml):
#   thresholds:
#     coverage_min: 70        # Fail if coverage < 70%
#     mutation_score_min: 70  # Fail if mutation score < 70%
#     max_high_vulns: 0       # Fail on any high-severity vulnerability
#     max_checkstyle_errors: 0
#
# CALLER EXAMPLE (minimal - config lives in .ci-hub.yml):
#   # .github/workflows/hub-ci.yml
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/java-ci.yml@v1
#       secrets: inherit
#
# INSTALL: Tools are installed from the hub repo via `pip install -e "hub[ci]"`
#          (PyPI distribution is planned; see ADR-0033).
#
# ============================================================================

name: Java CI Pipeline

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # ---- Java Settings ----
      java_version:
        description: 'Java version'
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven or gradle)'
        type: string
        default: 'maven'

      # ---- Tool Toggles ----
      run_jacoco:
        description: 'Run JaCoCo coverage'
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP Dependency Check'
        type: boolean
        default: true
      use_nvd_api_key:
        description: 'Use NVD API key for faster OWASP scans (requires NVD_API_KEY secret)'
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing'
        type: boolean
        default: true
      run_jqwik:
        description: 'Run jqwik property-based testing'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      run_pmd:
        description: 'Run PMD static analysis'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      owasp_cvss_fail:
        description: 'CVSS score to fail on'
        type: number
        default: 7
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_pmd_violations:
        description: 'Maximum allowed PMD violations (default: 0 = fail on any)'
        type: number
        default: 0
      max_checkstyle_errors:
        description: 'Maximum allowed Checkstyle errors (default: 0 = fail on any)'
        type: number
        default: 0
      max_spotbugs_bugs:
        description: 'Maximum allowed SpotBugs bugs (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Docker Settings ----
      docker_compose_file:
        description: 'Docker compose file path'
        type: string
        default: 'docker-compose.yml'
      docker_health_endpoint:
        description: 'Health check endpoint'
        type: string
        default: '/actuator/health'

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        type: boolean
        default: true

    secrets:
      NVD_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.ci.outputs.build_status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.ci.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.ci.outputs.mutation_score }}

jobs:
  ci:
    name: Java CI (cihub)
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.report.outputs.build_status }}
      coverage: ${{ steps.report.outputs.coverage }}
      mutation_score: ${{ steps.report.outputs.mutation_score }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Checkout hub repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.hub_repo }}
          ref: ${{ inputs.hub_ref }}
          path: hub
          persist-credentials: false

      - name: Set up JDK ${{ inputs.java_version }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: 'temurin'
          cache: ${{ inputs.build_tool }}

      - name: Set up Python 3.12
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub + tools
        run: |
          python -m pip install --upgrade pip
          pip install -e "hub[ci]"

      - name: Run cihub ci
        env:
          WORKDIR: ${{ inputs.workdir }}
          CORRELATION_ID: ${{ inputs.hub_correlation_id }}
          WRITE_SUMMARY: ${{ inputs.write_github_summary }}
        run: |
          summary_flag="--no-write-github-summary"
          if [ "$WRITE_SUMMARY" = "true" ]; then
            summary_flag="--write-github-summary"
          fi
          cihub ci \
            --workdir "$WORKDIR" \
            --correlation-id "$CORRELATION_ID" \
            --output-dir .cihub \
            $summary_flag

      - name: Read report outputs
        id: report
        run: |
          cihub report outputs --report .cihub/report.json

      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/tool-outputs/*.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: warn
