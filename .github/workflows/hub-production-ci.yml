# ============================================================================
# CI/CD Hub - Production CI
# ============================================================================
# Comprehensive CI pipeline for the hub repository itself.
# Runs on every push/PR with full security scanning, testing, and compliance.
#
# Jobs are organized in stages for fast feedback:
# - Stage 0: Workflow Security (actionlint, zizmor) - validates our own workflows
# - Stage 1: Fast checks (lint, syntax, type) - fail fast
# - Stage 2: Testing (unit, mutation)
# - Stage 3: Security (SAST, dependency audit, secrets, trivy)
# - Stage 4: Validation (templates, configs, schemas)
# - Stage 5: Supply Chain (scorecard, dependency-review)
# - Stage 6: Summary
#
# Security hardening:
# - harden-runner on all jobs (egress monitoring)
# - Actions pinned to SHAs (see pinact)
# - Least-privilege GITHUB_TOKEN per job
# ============================================================================

name: Hub Production CI

on:
  push:
    branches: [main, master]
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  pull_request:
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  workflow_dispatch:
  schedule:
    # Weekly scan for new CVEs
    - cron: '0 6 * * 1'

concurrency:
  group: hub-ci-${{ github.ref }}
  cancel-in-progress: true

# Note: No global env: block - Scorecard rejects workflows with global env vars.
# PYTHON_VERSION is defined at job-level for jobs that need it.

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Stage 0: Workflow Security (validates our own workflows)
  # ============================================================================
  actionlint:
    name: Workflow Lint (actionlint)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install actionlint
        run: |
          # Install latest actionlint (supports workflow_call, id-token, ref_name)
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Setup reviewdog
        uses: reviewdog/action-setup@e04ffabe3898a0af8d0fb1af00c188831c4b5893 # v1.3.2
        with:
          reviewdog_version: latest

      - name: Run actionlint with reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Only lint hub-production-ci.yml (other files are reusable workflow templates)
          # Format: prepend 'e:' (error) to oneline output for reviewdog's efm parser
          ./actionlint -oneline .github/workflows/hub-production-ci.yml | \
            while read -r line; do echo "e:${line}"; done | \
            reviewdog -efm="%t:%f:%l:%c: %m" -name="actionlint" -reporter=github-check -level=error -fail-level=error

  zizmor:
    name: Workflow Security (zizmor)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Install zizmor
        run: |
          pip install zizmor==0.8.0

      - name: Run zizmor
        run: |
          # zizmor 0.8.0 uses stdout redirect instead of --output flag
          zizmor --format sarif .github/workflows/ > zizmor.sarif 2>&1 || true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: zizmor.sarif
          category: zizmor

      - name: Check for high-severity findings
        run: |
          if [ -f zizmor.sarif ]; then
            HIGH=$(python3 -c "
          import json
          with open('zizmor.sarif') as f:
              sarif = json.load(f)
          runs = sarif.get('runs', [])
          if runs:
              results = runs[0].get('results', [])
              high = [r for r in results if r.get('level') in ('error', 'warning')]
              print(len(high))
          else:
              print(0)
          " 2>/dev/null || echo "0")

            {
              echo "## Zizmor Workflow Security"
              echo "High/Warning findings: $HIGH"
            } >> "$GITHUB_STEP_SUMMARY"

            if [ "$HIGH" -gt 0 ]; then
              echo "::error::Found $HIGH workflow security findings - review in Security tab"
              exit 1
            fi
          fi

  # ============================================================================
  # Stage 1: Fast Checks (fail fast)
  # ============================================================================
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Ruff lint
        run: ruff check . --output-format=github --force-exclude

      - name: Ruff format check
        run: ruff format --check . --force-exclude

  syntax-check:
    name: Python Syntax
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check syntax
        run: |
          set -e
          echo "Checking scripts/*.py..."
          python -m py_compile scripts/*.py
          echo "Checking cihub/**/*.py..."
          find cihub -name '*.py' -exec python -m py_compile {} +
          echo "✓ Python syntax valid"

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mypy
        run: pip install mypy pyyaml jsonschema types-PyYAML

      - name: Run mypy
        run: |
          mypy cihub/ --ignore-missing-imports --show-error-codes
          echo "✓ Type check passed"

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: disable}}" \
            config/defaults.yaml config/repos/ templates/profiles/
          echo "✓ YAML lint passed"

  # ============================================================================
  # Stage 2: Testing
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[wizard]"
          pip install pytest pytest-cov pyyaml jsonschema

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v \
            --cov=cihub --cov=scripts \
            --cov-report=xml --cov-report=term-missing \
            --cov-fail-under=70 \
            --junitxml=test-results.xml

      - name: Upload coverage
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 7

  mutation-tests:
    name: Mutation Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev,wizard]"
          pip install pytest pyyaml jsonschema mutmut

      - name: Run mutation tests
        id: mutmut
        run: |
          set -e  # Fail on any error

          # Run mutmut 3.x - reads paths from pyproject.toml [tool.mutmut]
          echo "Running mutation tests on cihub/..."
          if ! mutmut run; then
            echo "::error::mutmut run failed - check for import errors or test failures"
            exit 1
          fi

          # Get results - mutmut 3.x: --all true shows all mutants including killed
          # Without --all, it only shows non-killed mutants (empty if all killed)
          RESULTS=$(mutmut results --all true 2>&1)
          if [ -z "$RESULTS" ]; then
            echo "::error::mutmut produced no results - check configuration"
            exit 1
          fi

          # Count ALL mutant states (not just killed/survived)
          KILLED=$(echo "$RESULTS" | grep -c "killed" || echo "0")
          SURVIVED=$(echo "$RESULTS" | grep -c "survived" || echo "0")
          TIMEOUT=$(echo "$RESULTS" | grep -c "timeout" || echo "0")
          SUSPICIOUS=$(echo "$RESULTS" | grep -c "suspicious" || echo "0")
          SKIPPED=$(echo "$RESULTS" | grep -c "skipped" || echo "0")

          # Total = all mutants that were tested (exclude skipped)
          TESTED=$((KILLED + SURVIVED + TIMEOUT + SUSPICIOUS))

          if [ "$TESTED" -eq 0 ]; then
            echo "::error::No mutants were tested - check test coverage"
            exit 1
          fi

          # Score = killed / tested (timeout/suspicious count as not killed)
          SCORE=$((KILLED * 100 / TESTED))

          {
            echo "mutation_score=$SCORE"
            echo "killed=$KILLED"
            echo "survived=$SURVIVED"
            echo "timeout=$TIMEOUT"
            echo "suspicious=$SUSPICIOUS"
          } >> "$GITHUB_OUTPUT"

          {
            echo "## Mutation Testing"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **Score** | **${SCORE}%** |"
            echo "| Killed | $KILLED |"
            echo "| Survived | $SURVIVED |"
            echo "| Timeout | $TIMEOUT |"
            echo "| Suspicious | $SUSPICIOUS |"
            echo "| Skipped | $SKIPPED |"
            echo "| Total Tested | $TESTED |"
          } >> "$GITHUB_STEP_SUMMARY"

          # Fail if score below threshold
          if [ "$SCORE" -lt 70 ]; then
            {
              echo ""
              echo "**FAILED**: Score ${SCORE}% below 70% threshold"
            } >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Mutation score ${SCORE}% below 70% threshold"
            mutmut results --all true  # Show all mutant details
            exit 1
          fi

          {
            echo ""
            echo "**PASSED**: Score ${SCORE}% meets 70% threshold"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload mutation results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mutation-results
          path: mutants/
          retention-days: 7

  # ============================================================================
  # Stage 3: Security Scanning
  # ============================================================================
  bandit:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit
        run: |
          bandit -r cihub/ scripts/ -f json -o bandit.json \
            --severity-level medium --confidence-level medium || true

          HIGH=$(python3 -c "import json; r=json.load(open('bandit.json')); print(len([i for i in r.get('results',[]) if i['issue_severity']=='HIGH']))")

          {
            echo "## Bandit SAST"
            echo "High severity: $HIGH"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $HIGH high-severity issues"
            bandit -r cihub/ scripts/ --severity-level high
            exit 1
          fi

      - name: Upload bandit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bandit-results
          path: bandit.json
          retention-days: 7

  pip-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit and deps
        run: |
          pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit -r requirements.txt -r requirements-dev.txt --format json --output pip-audit.json || true
          # Count actual vulnerabilities, not packages scanned
          VULNS=$(python3 -c "import json; data=json.load(open('pip-audit.json')); print(sum(len(d.get('vulns',[])) for d in data))" 2>/dev/null || echo "0")

          {
            echo "## Dependency Vulnerabilities"
            echo "Found: $VULNS"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$VULNS" -gt 0 ]; then
            pip-audit --format markdown >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Found $VULNS dependency vulnerabilities"
            exit 1
          fi

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pip-audit-results
          path: pip-audit.json
          retention-days: 7

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report result
        if: always()
        run: |
          COMMITS=$(git rev-list --count HEAD)
          FILES=$(git ls-files | wc -l)

          {
            echo "## Secret Detection (gitleaks)"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Commits scanned | $COMMITS |"
            echo "| Files in repo | $FILES |"
            echo "| Leaks found | ${{ steps.gitleaks.outcome == 'success' && '0' || 'CHECK LOGS' }} |"
            echo "| Result | ${{ steps.gitleaks.outcome == 'success' && 'PASS' || 'FAIL' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # 0.31.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy FS SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-fs

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # 0.31.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # ============================================================================
  # Stage 4: Validation
  # ============================================================================
  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pyyaml jsonschema

      - name: Validate templates
        run: python -m pytest tests/test_templates.py -v --tb=short

  validate-configs:
    name: Validate Configs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml jsonschema

      - name: Validate repo configs
        run: |
          for cfg in config/repos/*.yaml; do
            repo=$(basename "$cfg" .yaml)
            echo "Validating $repo"
            python scripts/load_config.py --repo "$repo" --output workflow-inputs >/dev/null
          done
          echo "✓ All configs valid"

      - name: Validate profiles
        run: |
          python3 -c "
          import yaml
          from pathlib import Path
          for p in Path('templates/profiles').glob('*.yaml'):
              data = yaml.safe_load(p.read_text())
              assert isinstance(data, dict), f'{p} not a dict'
              print(f'✓ {p.name}')
          "

  verify-matrix-keys:
    name: Verify Matrix Keys
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml

      - name: Verify matrix keys
        run: python scripts/verify_hub_matrix_keys.py

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: |
          pip install pip-licenses
          pip install -e ".[dev]" || pip install -e .

      - name: Check licenses
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          TOTAL=$(pip-licenses --format=csv | wc -l)
          COPYLEFT=$(pip-licenses --format=csv | grep -icE "GPL|AGPL" || echo "0")

          {
            echo "## License Check"
            echo "Total packages: $TOTAL"
            echo "Copyleft (GPL/AGPL): $COPYLEFT"
          } >> "$summary_file"

          if [ "$COPYLEFT" -gt 0 ]; then
            {
              echo ""
              echo "Copyleft packages (dev dependencies are acceptable):"
              pip-licenses --format=csv | grep -iE "GPL|AGPL"
            } >> "$summary_file"
            # Only warn - dev dependencies like mutmut (GPL) are acceptable
            echo "::warning::Found $COPYLEFT packages with copyleft licenses"
          else
            echo "PASS - no copyleft licenses" >> "$summary_file"
          fi

  # ============================================================================
  # Stage 5: Supply Chain Security
  # ============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4.7.1
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    # Only run on main branch pushes and scheduled runs
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      id-token: write  # Required for scorecard
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186 # v2.4.1
        with:
          results_file: scorecard.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: scorecard.sarif
          category: scorecard

  # ============================================================================
  # Stage 6: Summary
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - actionlint
      - zizmor
      - lint
      - syntax-check
      - type-check
      - yaml-lint
      - unit-tests
      - mutation-tests
      - bandit
      - pip-audit
      - secret-scan
      - trivy
      - validate-templates
      - validate-configs
      - verify-matrix-keys
      - license-check
      - dependency-review
      - scorecard
    if: always()
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Generate summary
        run: |
          # Helpers for unified format
          ran() { [[ "$1" != "skipped" && "$1" != "cancelled" ]] && echo "true" || echo "false"; }
          ok() { [[ "$1" == "success" ]] && echo "true" || echo "false"; }
          summary_file="$GITHUB_STEP_SUMMARY"

          {
            echo "## Hub Production CI Summary"
            echo ""

            # Environment
            echo "### Environment"
            echo ""
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Repository | ${{ github.repository }} |"
            echo "| Branch | ${{ github.ref_name }} |"
            echo "| Run Number | #${{ github.run_number }} |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo "| Language | Python |"
            echo ""

            # Results (unified format per SUMMARY_CONTRACT.md contract)
            echo "## Tools Enabled"
            echo ""
            echo "| Category | Tool | Configured | Ran | Success |"
            echo "|----------|------|------------|-----|---------|"
            echo "| Workflow | actionlint | true | $(ran "${{ needs.actionlint.result }}") | $(ok "${{ needs.actionlint.result }}") |"
            echo "| Workflow | zizmor | true | $(ran "${{ needs.zizmor.result }}") | $(ok "${{ needs.zizmor.result }}") |"
            echo "| Quality | ruff | true | $(ran "${{ needs.lint.result }}") | $(ok "${{ needs.lint.result }}") |"
            echo "| Quality | syntax | true | $(ran "${{ needs.syntax-check.result }}") | $(ok "${{ needs.syntax-check.result }}") |"
            echo "| Quality | mypy | true | $(ran "${{ needs.type-check.result }}") | $(ok "${{ needs.type-check.result }}") |"
            echo "| Quality | yamllint | true | $(ran "${{ needs.yaml-lint.result }}") | $(ok "${{ needs.yaml-lint.result }}") |"
            echo "| Testing | pytest | true | $(ran "${{ needs.unit-tests.result }}") | $(ok "${{ needs.unit-tests.result }}") |"
            echo "| Testing | mutmut | true | $(ran "${{ needs.mutation-tests.result }}") | $(ok "${{ needs.mutation-tests.result }}") |"
            echo "| Security | bandit | true | $(ran "${{ needs.bandit.result }}") | $(ok "${{ needs.bandit.result }}") |"
            echo "| Security | pip-audit | true | $(ran "${{ needs.pip-audit.result }}") | $(ok "${{ needs.pip-audit.result }}") |"
            echo "| Security | gitleaks | true | $(ran "${{ needs.secret-scan.result }}") | $(ok "${{ needs.secret-scan.result }}") |"
            echo "| Security | trivy | true | $(ran "${{ needs.trivy.result }}") | $(ok "${{ needs.trivy.result }}") |"
            echo "| Validate | templates | true | $(ran "${{ needs.validate-templates.result }}") | $(ok "${{ needs.validate-templates.result }}") |"
            echo "| Validate | configs | true | $(ran "${{ needs.validate-configs.result }}") | $(ok "${{ needs.validate-configs.result }}") |"
            echo "| Validate | matrix-keys | true | $(ran "${{ needs.verify-matrix-keys.result }}") | $(ok "${{ needs.verify-matrix-keys.result }}") |"
            echo "| Validate | licenses | true | $(ran "${{ needs.license-check.result }}") | $(ok "${{ needs.license-check.result }}") |"
            echo "| Supply Chain | dependency-review | true | $(ran "${{ needs.dependency-review.result }}") | $(ok "${{ needs.dependency-review.result }}") |"
            echo "| Supply Chain | scorecard | true | $(ran "${{ needs.scorecard.result }}") | $(ok "${{ needs.scorecard.result }}") |"
            echo ""

            # Failures/Skips
            echo "### Failed or Skipped Checks"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
          } >> "$summary_file"

          checks=(
            "actionlint:${{ needs.actionlint.result }}"
            "zizmor:${{ needs.zizmor.result }}"
            "ruff:${{ needs.lint.result }}"
            "syntax:${{ needs.syntax-check.result }}"
            "mypy:${{ needs.type-check.result }}"
            "yamllint:${{ needs.yaml-lint.result }}"
            "pytest:${{ needs.unit-tests.result }}"
            "mutmut:${{ needs.mutation-tests.result }}"
            "bandit:${{ needs.bandit.result }}"
            "pip-audit:${{ needs.pip-audit.result }}"
            "gitleaks:${{ needs.secret-scan.result }}"
            "trivy:${{ needs.trivy.result }}"
            "templates:${{ needs.validate-templates.result }}"
            "configs:${{ needs.validate-configs.result }}"
            "matrix-keys:${{ needs.verify-matrix-keys.result }}"
            "licenses:${{ needs.license-check.result }}"
            "dependency-review:${{ needs.dependency-review.result }}"
            "scorecard:${{ needs.scorecard.result }}"
          )

          has_issues=0
          for item in "${checks[@]}"; do
            name="${item%%:*}"
            status="${item##*:}"
            if [ "$status" != "success" ]; then
              has_issues=1
              echo "| $name | $status |" >> "$summary_file"
            fi
          done
          if [ "$has_issues" -eq 0 ]; then
            echo "| None | success |" >> "$summary_file"
          fi
          echo "" >> "$summary_file"

          {
            # Quality Gates
            echo "### Quality Gates"
            echo ""
            echo "| Check | Threshold | Status |"
            echo "|-------|-----------|--------|"
            echo "| Unit Tests | pass | ${{ needs.unit-tests.result == 'success' && 'Passed' || needs.unit-tests.result == 'skipped' && 'Skipped' || 'Failed' }} |"
            echo "| Coverage | 70% min | ${{ needs.unit-tests.result == 'success' && 'Passed' || 'N/A' }} |"
            echo "| Mutation Score | 70% min | ${{ needs.mutation-tests.result == 'success' && 'Passed' || needs.mutation-tests.result == 'skipped' && 'Skipped' || 'Failed' }} |"
            echo "| Type Check (mypy) | 0 errors | ${{ needs.type-check.result == 'success' && 'Passed' || 'Failed' }} |"
            echo "| SAST (bandit) | 0 high | ${{ needs.bandit.result == 'success' && 'Passed' || 'Failed' }} |"
            echo "| Secrets (gitleaks) | 0 leaks | ${{ needs.secret-scan.result == 'success' && 'Passed' || 'Failed' }} |"
            echo ""
            echo "Job summary generated at run-time"
          } >> "$summary_file"

      - name: Check critical failures
        run: |
          FAILED=0

          fail_if_hard() {
            local name="$1"
            local result="$2"
            local message="$3"
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              echo "::error::${name} failed - ${message}"
              FAILED=1
            fi
          }

          # Workflow security - must pass
          fail_if_hard "actionlint" "${{ needs.actionlint.result }}" "fix workflow syntax"
          fail_if_hard "zizmor" "${{ needs.zizmor.result }}" "address workflow security findings"

          # Code quality gates - must pass
          fail_if_hard "mypy" "${{ needs.type-check.result }}" "fix mypy errors"
          fail_if_hard "yamllint" "${{ needs.yaml-lint.result }}" "fix config syntax"
          fail_if_hard "ruff" "${{ needs.lint.result }}" "fix ruff lint violations"
          fail_if_hard "syntax" "${{ needs.syntax-check.result }}" "fix Python syntax errors"

          # Critical code checks that must pass
          fail_if_hard "unit-tests" "${{ needs.unit-tests.result }}" "unit tests failed"
          fail_if_hard "mutation-tests" "${{ needs.mutation-tests.result }}" "mutation testing failed"
          fail_if_hard "bandit" "${{ needs.bandit.result }}" "security scan failed"
          fail_if_hard "pip-audit" "${{ needs.pip-audit.result }}" "dependency audit failed"
          fail_if_hard "gitleaks" "${{ needs.secret-scan.result }}" "secret detection failed"
          fail_if_hard "trivy" "${{ needs.trivy.result }}" "trivy scan failed"
          fail_if_hard "validate-templates" "${{ needs.validate-templates.result }}" "template validation failed"
          fail_if_hard "validate-configs" "${{ needs.validate-configs.result }}" "config validation failed"
          fail_if_hard "verify-matrix-keys" "${{ needs.verify-matrix-keys.result }}" "matrix key validation failed"
          fail_if_hard "license-check" "${{ needs.license-check.result }}" "license compliance failed"

          # Supply chain checks - must pass when they run
          fail_if_hard "dependency-review" "${{ needs.dependency-review.result }}" "dependency review failed"
          fail_if_hard "scorecard" "${{ needs.scorecard.result }}" "scorecard checks failed"

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

          echo "All critical checks passed"
