# ============================================================================
# CI/CD Hub - Production CI
# ============================================================================
# Comprehensive CI pipeline for the hub repository itself.
# Runs on every push/PR with full security scanning, testing, and compliance.
#
# Jobs are organized in stages for fast feedback:
# - Stage 0: Workflow Security (actionlint, zizmor) - validates our own workflows
# - Stage 1: Fast checks (lint, syntax, type) - fail fast
# - Stage 2: Testing (unit, mutation)
# - Stage 3: Security (SAST, dependency audit, secrets, trivy)
# - Stage 4: Validation (templates, configs, schemas)
# - Stage 5: Supply Chain (scorecard, dependency-review)
# - Stage 6: Summary
#
# Security hardening:
# - harden-runner on all jobs (egress monitoring)
# - Actions pinned to SHAs (see pinact)
# - Least-privilege GITHUB_TOKEN per job
# ============================================================================

name: Hub Production CI

on:
  push:
    branches: [main, master]
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  pull_request:
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  workflow_dispatch:
  schedule:
    # Weekly scan for new CVEs
    - cron: '0 6 * * 1'

concurrency:
  group: hub-ci-${{ github.ref }}
  cancel-in-progress: true

# Note: No global env: block - Scorecard rejects workflows with global env vars.
# PYTHON_VERSION is defined at job-level for jobs that need it.

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Stage 0: Workflow Security (validates our own workflows)
  # ============================================================================
  actionlint:
    name: Workflow Lint (actionlint)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install actionlint
        run: |
          # Install latest actionlint (supports workflow_call, id-token, ref_name)
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)

      - name: Setup reviewdog
        uses: reviewdog/action-setup@d8a7baabd7f3e8544ee4dbde3ee41d0011c3a93f # v1.5.0
        with:
          reviewdog_version: latest

      - name: Run actionlint with reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Only lint hub-production-ci.yml (other files are reusable workflow templates)
          # Format: prepend 'e:' (error) to oneline output for reviewdog's efm parser
          ./actionlint -oneline .github/workflows/hub-production-ci.yml | \
            while read -r line; do echo "e:${line}"; done | \
            reviewdog -efm="%t:%f:%l:%c: %m" -name="actionlint" -reporter=github-check -level=error -fail-level=error

  zizmor:
    name: Workflow Security (zizmor)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install zizmor
        run: |
          pip install zizmor==0.8.0

      - name: Run zizmor
        run: |
          # zizmor 0.8.0 outputs SARIF to stdout
          # Don't redirect stderr to file - it corrupts SARIF on error
          if ! zizmor --format sarif .github/workflows/ > zizmor.sarif 2>/dev/null; then
            # Create empty valid SARIF if zizmor fails
            cat > zizmor.sarif << 'SARIF'
          {"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"zizmor","version":"0.8.0"}},"results":[]}]}
          SARIF
          fi

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: zizmor.sarif
          category: zizmor
      - name: Upload zizmor SARIF artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.3.0
        if: always()
        with:
          name: zizmor-sarif
          path: zizmor.sarif
          retention-days: 30
          if-no-files-found: warn

      - name: Check for high-severity findings
        run: |
          if [ -f zizmor.sarif ]; then
            HIGH=$(python3 -c "
          import json
          with open('zizmor.sarif') as f:
              sarif = json.load(f)
          runs = sarif.get('runs', [])
          if runs:
              results = runs[0].get('results', [])
              high = [r for r in results if r.get('level') in ('error', 'warning')]
              print(len(high))
          else:
              print(0)
          " 2>/dev/null || echo "0")

            {
              echo "## Zizmor Workflow Security"
              echo "High/Warning findings: $HIGH"
            } >> "$GITHUB_STEP_SUMMARY"

            if [ "$HIGH" -gt 0 ]; then
              echo "::error::Found $HIGH workflow security findings - review in Security tab"
              exit 1
            fi
          fi

  # ============================================================================
  # Stage 1: Fast Checks (fail fast)
  # ============================================================================
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      ruff_issues: ${{ steps.ruff.outputs.issues }}
      black_issues: ${{ steps.black.outputs.issues }}
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff==0.8.6 black==24.10.0

      - name: Ruff lint
        id: ruff
        run: |
          ISSUES=$(ruff check . --force-exclude --output-format=json 2>/dev/null | python3 -c "import sys,json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
          ruff check . --output-format=github --force-exclude

      - name: Ruff format check
        run: ruff format --check . --force-exclude

      - name: Black format check
        id: black
        run: |
          set +e
          black --check . 2>&1 | tee black-output.txt
          STATUS=${PIPESTATUS[0]}
          set -e

          ISSUES=$(grep -c "would reformat" black-output.txt 2>/dev/null || echo "0")
          if [ "$STATUS" -ne 0 ] && [ "$ISSUES" -eq 0 ]; then
            ISSUES=1
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"

  syntax-check:
    name: Python Syntax
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check syntax
        run: |
          set -e
          echo "Checking scripts/*.py..."
          python -m py_compile scripts/*.py
          echo "Checking cihub/**/*.py..."
          find cihub -name '*.py' -exec python -m py_compile {} +
          echo "âœ“ Python syntax valid"

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mypy
        run: pip install mypy==1.14.1 pyyaml==6.0.2 jsonschema==4.23.0 types-PyYAML==6.0.12.20241230

      - name: Run mypy
        run: |
          mypy cihub/ --ignore-missing-imports --show-error-codes
          echo "âœ“ Type check passed"

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install yamllint
        run: pip install yamllint==1.35.1

      - name: Lint YAML
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: disable}}" \
            config/defaults.yaml config/repos/ templates/profiles/
          echo "âœ“ YAML lint passed"

  # ============================================================================
  # Stage 2: Testing
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[wizard]"
          pip install pytest pytest-cov pyyaml jsonschema

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v \
            --cov=cihub --cov=scripts \
            --cov-report=xml --cov-report=term-missing \
            --cov-fail-under=70 \
            --junitxml=test-results.xml

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 7

  mutation-tests:
    name: Mutation Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    permissions:
      contents: read
    outputs:
      mutation_score: ${{ steps.mutmut.outputs.mutation_score }}
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev,wizard]"
          pip install pytest==8.3.4 pyyaml==6.0.2 jsonschema==4.23.0 mutmut==3.2.3

      - name: Run mutation tests
        id: mutmut
        run: |
          set -e  # Fail on any error

          KILLED=0
          SURVIVED=0
          TIMEOUT=0
          SUSPICIOUS=0
          SKIPPED=0
          SCORE=0

          # Run mutmut 3.x - reads paths from pyproject.toml [tool.mutmut]
          echo "Running mutation tests on cihub/..."
          if ! mutmut run 2>&1 | tee mutmut-run.log; then
            echo "::error::mutmut run failed - check for import errors or test failures"
            exit 1
          fi

          # Parse results from mutmut 3.x run output
          # Final line format: "â ™ 73/73  ðŸŽ‰ 73 ðŸ«¥ 0  â° 0  ðŸ¤” 0  ðŸ™ 0  ðŸ”‡ 0"
          # ðŸŽ‰ = killed, ðŸ™ = survived, â° = timeout, ðŸ¤” = suspicious, ðŸ”‡ = skipped
          if grep -q "mutations/second" mutmut-run.log; then
            # Get the line with final counts (contains X/X pattern)
            FINAL=$(grep -E '[0-9]+/[0-9]+' mutmut-run.log | tail -1)
            echo "Final line: $FINAL"

            # Extract counts from emoji markers (use tr to strip newlines)
            KILLED=$(echo "$FINAL" | sed -n 's/.*ðŸŽ‰[[:space:]]*\([0-9]*\).*/\1/p' | tr -d '\n' | head -1)
            SURVIVED=$(echo "$FINAL" | sed -n 's/.*ðŸ™[[:space:]]*\([0-9]*\).*/\1/p' | tr -d '\n' | head -1)
            TIMEOUT=$(echo "$FINAL" | sed -n 's/.*â°[[:space:]]*\([0-9]*\).*/\1/p' | tr -d '\n' | head -1)
            SUSPICIOUS=$(echo "$FINAL" | sed -n 's/.*ðŸ¤”[[:space:]]*\([0-9]*\).*/\1/p' | tr -d '\n' | head -1)
            SKIPPED=$(echo "$FINAL" | sed -n 's/.*ðŸ”‡[[:space:]]*\([0-9]*\).*/\1/p' | tr -d '\n' | head -1)

            # Default to 0 if empty
            KILLED=${KILLED:-0}
            SURVIVED=${SURVIVED:-0}
            TIMEOUT=${TIMEOUT:-0}
            SUSPICIOUS=${SUSPICIOUS:-0}
            SKIPPED=${SKIPPED:-0}

            echo "Parsed: killed=$KILLED, survived=$SURVIVED, timeout=$TIMEOUT, suspicious=$SUSPICIOUS, skipped=$SKIPPED"
          else
            echo "::error::mutmut did not complete successfully - no 'mutations/second' found"
            cat mutmut-run.log
            exit 1
          fi

          # Total = all mutants that were tested (exclude skipped)
          TESTED=$((KILLED + SURVIVED + TIMEOUT + SUSPICIOUS))

          if [ "$TESTED" -eq 0 ]; then
            echo "::error::No mutants were tested - check test coverage"
            exit 1
          fi

          # Score = killed / tested (timeout/suspicious count as not killed)
          SCORE=$((KILLED * 100 / TESTED))

          {
            echo "mutation_score=$SCORE"
            echo "killed=$KILLED"
            echo "survived=$SURVIVED"
            echo "timeout=$TIMEOUT"
            echo "suspicious=$SUSPICIOUS"
          } >> "$GITHUB_OUTPUT"

          {
            echo "## Mutation Testing"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **Score** | **${SCORE}%** |"
            echo "| Killed | $KILLED |"
            echo "| Survived | $SURVIVED |"
            echo "| Timeout | $TIMEOUT |"
            echo "| Suspicious | $SUSPICIOUS |"
            echo "| Skipped | $SKIPPED |"
            echo "| Total Tested | $TESTED |"
          } >> "$GITHUB_STEP_SUMMARY"

          # Fail if score below threshold
          if [ "$SCORE" -lt 70 ]; then
            {
              echo ""
              echo "**FAILED**: Score ${SCORE}% below 70% threshold"
            } >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Mutation score ${SCORE}% below 70% threshold"
            cat mutmut-run.log
            exit 1
          fi

          {
            echo ""
            echo "**PASSED**: Score ${SCORE}% meets 70% threshold"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload mutation results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: mutation-results
          path: |
            mutants/
            mutmut-run.log
          retention-days: 7

  # ============================================================================
  # Stage 3: Security Scanning
  # ============================================================================
  bandit:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install "bandit[toml]==1.8.3"

      - name: Run bandit
        run: |
          bandit -r cihub/ scripts/ -f json -o bandit.json \
            --severity-level medium --confidence-level medium || true

          HIGH=$(python3 -c "import json; r=json.load(open('bandit.json')); print(len([i for i in r.get('results',[]) if i['issue_severity']=='HIGH']))")

          {
            echo "## Bandit SAST"
            echo "High severity: $HIGH"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $HIGH high-severity issues"
            bandit -r cihub/ scripts/ --severity-level high
            exit 1
          fi

      - name: Upload bandit results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bandit-results
          path: bandit.json
          retention-days: 7

  pip-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit and deps
        run: |
          pip install --upgrade pip
          pip install pip-audit==2.8.0

      - name: Run pip-audit
        run: |
          pip-audit -r requirements/requirements.txt -r requirements/requirements-dev.txt --format json --output pip-audit.json || true
          # Count actual vulnerabilities, not packages scanned
          VULNS=$(python3 -c "import json; data=json.load(open('pip-audit.json')); print(sum(len(d.get('vulns',[])) for d in data))" 2>/dev/null || echo "0")

          {
            echo "## Dependency Vulnerabilities"
            echo "Found: $VULNS"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$VULNS" -gt 0 ]; then
            pip-audit --format markdown >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Found $VULNS dependency vulnerabilities"
            exit 1
          fi

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pip-audit-results
          path: pip-audit.json
          retention-days: 7

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report result
        if: always()
        run: |
          COMMITS=$(git rev-list --count HEAD)
          FILES=$(git ls-files | wc -l)

          {
            echo "## Secret Detection (gitleaks)"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Commits scanned | $COMMITS |"
            echo "| Files in repo | $FILES |"
            echo "| Leaks found | ${{ steps.gitleaks.outcome == 'success' && '0' || 'CHECK LOGS' }} |"
            echo "| Result | ${{ steps.gitleaks.outcome == 'success' && 'PASS' || 'FAIL' }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy FS SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-fs

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # ============================================================================
  # Stage 4: Validation
  # ============================================================================
  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest==8.3.4 pyyaml==6.0.2 jsonschema==4.23.0

      - name: Validate templates
        run: python -m pytest tests/test_templates.py -v --tb=short

  validate-configs:
    name: Validate Configs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml==6.0.2 jsonschema==4.23.0

      - name: Validate repo configs
        run: |
          for cfg in config/repos/*.yaml; do
            repo=$(basename "$cfg" .yaml)
            echo "Validating $repo"
            python scripts/load_config.py --repo "$repo" --output workflow-inputs >/dev/null
          done
          echo "âœ“ All configs valid"

      - name: Validate profiles
        run: |
          python3 -c "
          import yaml
          from pathlib import Path
          for p in Path('templates/profiles').glob('*.yaml'):
              data = yaml.safe_load(p.read_text())
              assert isinstance(data, dict), f'{p} not a dict'
              print(f'âœ“ {p.name}')
          "

  verify-matrix-keys:
    name: Verify Matrix Keys
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install pyyaml==6.0.2

      - name: Verify matrix keys
        run: python scripts/verify_hub_matrix_keys.py

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: |
          pip install pip-licenses==5.0.0
          pip install -e ".[dev]" || pip install -e .

      - name: Check licenses
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          TOTAL=$(pip-licenses --format=csv | wc -l)
          COPYLEFT=$(pip-licenses --format=csv | grep -icE "GPL|AGPL" || echo "0")

          {
            echo "## License Check"
            echo "Total packages: $TOTAL"
            echo "Copyleft (GPL/AGPL): $COPYLEFT"
          } >> "$summary_file"

          if [ "$COPYLEFT" -gt 0 ]; then
            {
              echo ""
              echo "Copyleft packages (dev dependencies are acceptable):"
              pip-licenses --format=csv | grep -iE "GPL|AGPL"
            } >> "$summary_file"
            # Only warn - dev dependencies like mutmut (GPL) are acceptable
            echo "::warning::Found $COPYLEFT packages with copyleft licenses"
          else
            echo "PASS - no copyleft licenses" >> "$summary_file"
          fi

  # ============================================================================
  # Stage 5: Supply Chain Security
  # ============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    # Only run on main branch pushes and scheduled runs
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      security-events: write
      id-token: write  # Required for scorecard
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: scorecard.sarif
          category: scorecard

  # ============================================================================
  # Stage 6: Update Badges (on main only)
  # ============================================================================
  update-badges:
    name: Update Badges
    runs-on: ubuntu-latest
    needs: [lint, mutation-tests, bandit, pip-audit, zizmor]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: write
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate badges
        env:
          UPDATE_BADGES: 'true'
          RUFF_ISSUES: ${{ needs.lint.outputs.ruff_issues }}
          MUTATION_SCORE: ${{ needs.mutation-tests.outputs.mutation_score }}
          BLACK_ISSUES: ${{ needs.lint.outputs.black_issues }}
        run: |
          mkdir -p badges

          # Copy artifacts to expected locations
          [ -f artifacts/bandit-results/bandit.json ] && cp artifacts/bandit-results/bandit.json .
          [ -f artifacts/pip-audit-results/pip-audit.json ] && cp artifacts/pip-audit-results/pip-audit.json .
          [ -f artifacts/zizmor-sarif/zizmor.sarif ] && cp artifacts/zizmor-sarif/zizmor.sarif .

          # Run badge generator
          python scripts/python_ci_badges.py

      - name: Commit badges
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add badges/
          git diff --staged --quiet || git commit -m "chore: update CI badges [skip ci]"
          git push

  # ============================================================================
  # Stage 7: Summary
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - actionlint
      - zizmor
      - lint
      - syntax-check
      - type-check
      - yaml-lint
      - unit-tests
      - mutation-tests
      - bandit
      - pip-audit
      - secret-scan
      - trivy
      - validate-templates
      - validate-configs
      - verify-matrix-keys
      - license-check
      - dependency-review
      - scorecard
    if: always()
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate summary
        env:
          # Use environment variables to avoid template injection vulnerabilities
          # Branch name can be attacker-controlled, so never interpolate directly in run scripts
          GH_REPOSITORY: ${{ github.repository }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_EVENT_NAME: ${{ github.event_name }}
          # Job results are safe (predefined values only) but use env vars for consistency
          RESULT_ACTIONLINT: ${{ needs.actionlint.result }}
          RESULT_ZIZMOR: ${{ needs.zizmor.result }}
          RESULT_LINT: ${{ needs.lint.result }}
          RESULT_SYNTAX: ${{ needs.syntax-check.result }}
          RESULT_TYPECHECK: ${{ needs.type-check.result }}
          RESULT_YAMLLINT: ${{ needs.yaml-lint.result }}
          RESULT_UNIT_TESTS: ${{ needs.unit-tests.result }}
          RESULT_MUTATION: ${{ needs.mutation-tests.result }}
          RESULT_BANDIT: ${{ needs.bandit.result }}
          RESULT_PIP_AUDIT: ${{ needs.pip-audit.result }}
          RESULT_SECRET_SCAN: ${{ needs.secret-scan.result }}
          RESULT_TRIVY: ${{ needs.trivy.result }}
          RESULT_TEMPLATES: ${{ needs.validate-templates.result }}
          RESULT_CONFIGS: ${{ needs.validate-configs.result }}
          RESULT_MATRIX_KEYS: ${{ needs.verify-matrix-keys.result }}
          RESULT_LICENSE: ${{ needs.license-check.result }}
          RESULT_DEP_REVIEW: ${{ needs.dependency-review.result }}
          RESULT_SCORECARD: ${{ needs.scorecard.result }}
        run: |
          # Helpers for unified format
          ran() { [[ "$1" != "skipped" && "$1" != "cancelled" ]] && echo "true" || echo "false"; }
          ok() { [[ "$1" == "success" ]] && echo "true" || echo "false"; }
          status_text() {
            case "$1" in
              success) echo "Passed" ;;
              skipped) echo "Skipped" ;;
              *) echo "Failed" ;;
            esac
          }
          summary_file="$GITHUB_STEP_SUMMARY"

          {
            echo "## Hub Production CI Summary"
            echo ""

            # Environment
            echo "### Environment"
            echo ""
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Repository | $GH_REPOSITORY |"
            echo "| Branch | $GH_REF_NAME |"
            echo "| Run Number | #$GH_RUN_NUMBER |"
            echo "| Trigger | $GH_EVENT_NAME |"
            echo "| Language | Python |"
            echo ""

            # Results (unified format per SUMMARY_CONTRACT.md contract)
            echo "## Tools Enabled"
            echo ""
            echo "| Category | Tool | Configured | Ran | Success |"
            echo "|----------|------|------------|-----|---------|"
            echo "| Workflow | actionlint | true | $(ran "$RESULT_ACTIONLINT") | $(ok "$RESULT_ACTIONLINT") |"
            echo "| Workflow | zizmor | true | $(ran "$RESULT_ZIZMOR") | $(ok "$RESULT_ZIZMOR") |"
            echo "| Quality | ruff | true | $(ran "$RESULT_LINT") | $(ok "$RESULT_LINT") |"
            echo "| Quality | syntax | true | $(ran "$RESULT_SYNTAX") | $(ok "$RESULT_SYNTAX") |"
            echo "| Quality | mypy | true | $(ran "$RESULT_TYPECHECK") | $(ok "$RESULT_TYPECHECK") |"
            echo "| Quality | yamllint | true | $(ran "$RESULT_YAMLLINT") | $(ok "$RESULT_YAMLLINT") |"
            echo "| Testing | pytest | true | $(ran "$RESULT_UNIT_TESTS") | $(ok "$RESULT_UNIT_TESTS") |"
            echo "| Testing | mutmut | true | $(ran "$RESULT_MUTATION") | $(ok "$RESULT_MUTATION") |"
            echo "| Security | bandit | true | $(ran "$RESULT_BANDIT") | $(ok "$RESULT_BANDIT") |"
            echo "| Security | pip-audit | true | $(ran "$RESULT_PIP_AUDIT") | $(ok "$RESULT_PIP_AUDIT") |"
            echo "| Security | gitleaks | true | $(ran "$RESULT_SECRET_SCAN") | $(ok "$RESULT_SECRET_SCAN") |"
            echo "| Security | trivy | true | $(ran "$RESULT_TRIVY") | $(ok "$RESULT_TRIVY") |"
            echo "| Validate | templates | true | $(ran "$RESULT_TEMPLATES") | $(ok "$RESULT_TEMPLATES") |"
            echo "| Validate | configs | true | $(ran "$RESULT_CONFIGS") | $(ok "$RESULT_CONFIGS") |"
            echo "| Validate | matrix-keys | true | $(ran "$RESULT_MATRIX_KEYS") | $(ok "$RESULT_MATRIX_KEYS") |"
            echo "| Validate | licenses | true | $(ran "$RESULT_LICENSE") | $(ok "$RESULT_LICENSE") |"
            echo "| Supply Chain | dependency-review | true | $(ran "$RESULT_DEP_REVIEW") | $(ok "$RESULT_DEP_REVIEW") |"
            echo "| Supply Chain | scorecard | true | $(ran "$RESULT_SCORECARD") | $(ok "$RESULT_SCORECARD") |"
            echo ""

            # Failures/Skips
            echo "### Failed or Skipped Checks"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
          } >> "$summary_file"

          checks=(
            "actionlint:$RESULT_ACTIONLINT"
            "zizmor:$RESULT_ZIZMOR"
            "ruff:$RESULT_LINT"
            "syntax:$RESULT_SYNTAX"
            "mypy:$RESULT_TYPECHECK"
            "yamllint:$RESULT_YAMLLINT"
            "pytest:$RESULT_UNIT_TESTS"
            "mutmut:$RESULT_MUTATION"
            "bandit:$RESULT_BANDIT"
            "pip-audit:$RESULT_PIP_AUDIT"
            "gitleaks:$RESULT_SECRET_SCAN"
            "trivy:$RESULT_TRIVY"
            "templates:$RESULT_TEMPLATES"
            "configs:$RESULT_CONFIGS"
            "matrix-keys:$RESULT_MATRIX_KEYS"
            "licenses:$RESULT_LICENSE"
            "dependency-review:$RESULT_DEP_REVIEW"
            "scorecard:$RESULT_SCORECARD"
          )

          has_issues=0
          for item in "${checks[@]}"; do
            name="${item%%:*}"
            status="${item##*:}"
            if [ "$status" != "success" ]; then
              has_issues=1
              echo "| $name | $status |" >> "$summary_file"
            fi
          done
          if [ "$has_issues" -eq 0 ]; then
            echo "| None | success |" >> "$summary_file"
          fi
          echo "" >> "$summary_file"

          {
            # Quality Gates
            echo "### Quality Gates"
            echo ""
            echo "| Check | Threshold | Status |"
            echo "|-------|-----------|--------|"
            echo "| Unit Tests | pass | $(status_text "$RESULT_UNIT_TESTS") |"
            echo "| Coverage | 70% min | $([[ "$RESULT_UNIT_TESTS" == "success" ]] && echo "Passed" || echo "N/A") |"
            echo "| Mutation Score | 70% min | $(status_text "$RESULT_MUTATION") |"
            echo "| Type Check (mypy) | 0 errors | $([[ "$RESULT_TYPECHECK" == "success" ]] && echo "Passed" || echo "Failed") |"
            echo "| SAST (bandit) | 0 high | $([[ "$RESULT_BANDIT" == "success" ]] && echo "Passed" || echo "Failed") |"
            echo "| Secrets (gitleaks) | 0 leaks | $([[ "$RESULT_SECRET_SCAN" == "success" ]] && echo "Passed" || echo "Failed") |"
            echo ""
            echo "Job summary generated at run-time"
          } >> "$summary_file"

      - name: Check critical failures
        env:
          # Use environment variables to avoid template injection vulnerabilities
          RESULT_ACTIONLINT: ${{ needs.actionlint.result }}
          RESULT_ZIZMOR: ${{ needs.zizmor.result }}
          RESULT_LINT: ${{ needs.lint.result }}
          RESULT_SYNTAX: ${{ needs.syntax-check.result }}
          RESULT_TYPECHECK: ${{ needs.type-check.result }}
          RESULT_YAMLLINT: ${{ needs.yaml-lint.result }}
          RESULT_UNIT_TESTS: ${{ needs.unit-tests.result }}
          RESULT_MUTATION: ${{ needs.mutation-tests.result }}
          RESULT_BANDIT: ${{ needs.bandit.result }}
          RESULT_PIP_AUDIT: ${{ needs.pip-audit.result }}
          RESULT_SECRET_SCAN: ${{ needs.secret-scan.result }}
          RESULT_TRIVY: ${{ needs.trivy.result }}
          RESULT_TEMPLATES: ${{ needs.validate-templates.result }}
          RESULT_CONFIGS: ${{ needs.validate-configs.result }}
          RESULT_MATRIX_KEYS: ${{ needs.verify-matrix-keys.result }}
          RESULT_LICENSE: ${{ needs.license-check.result }}
          RESULT_DEP_REVIEW: ${{ needs.dependency-review.result }}
          RESULT_SCORECARD: ${{ needs.scorecard.result }}
        run: |
          FAILED=0

          fail_if_hard() {
            local name="$1"
            local result="$2"
            local message="$3"
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              echo "::error::${name} failed - ${message}"
              FAILED=1
            fi
          }

          # Workflow security - must pass
          fail_if_hard "actionlint" "$RESULT_ACTIONLINT" "fix workflow syntax"
          fail_if_hard "zizmor" "$RESULT_ZIZMOR" "address workflow security findings"

          # Code quality gates - must pass
          fail_if_hard "mypy" "$RESULT_TYPECHECK" "fix mypy errors"
          fail_if_hard "yamllint" "$RESULT_YAMLLINT" "fix config syntax"
          fail_if_hard "ruff" "$RESULT_LINT" "fix ruff lint violations"
          fail_if_hard "syntax" "$RESULT_SYNTAX" "fix Python syntax errors"

          # Critical code checks that must pass
          fail_if_hard "unit-tests" "$RESULT_UNIT_TESTS" "unit tests failed"
          fail_if_hard "mutation-tests" "$RESULT_MUTATION" "mutation testing failed"
          fail_if_hard "bandit" "$RESULT_BANDIT" "security scan failed"
          fail_if_hard "pip-audit" "$RESULT_PIP_AUDIT" "dependency audit failed"
          fail_if_hard "gitleaks" "$RESULT_SECRET_SCAN" "secret detection failed"
          fail_if_hard "trivy" "$RESULT_TRIVY" "trivy scan failed"
          fail_if_hard "validate-templates" "$RESULT_TEMPLATES" "template validation failed"
          fail_if_hard "validate-configs" "$RESULT_CONFIGS" "config validation failed"
          fail_if_hard "verify-matrix-keys" "$RESULT_MATRIX_KEYS" "matrix key validation failed"
          fail_if_hard "license-check" "$RESULT_LICENSE" "license compliance failed"

          # Supply chain checks - must pass when they run
          fail_if_hard "dependency-review" "$RESULT_DEP_REVIEW" "dependency review failed"
          fail_if_hard "scorecard" "$RESULT_SCORECARD" "scorecard checks failed"

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

          echo "All critical checks passed"
