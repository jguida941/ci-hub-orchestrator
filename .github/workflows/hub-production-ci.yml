# ============================================================================
# CI/CD Hub - Production CI
# ============================================================================
# Comprehensive CI pipeline for the hub repository itself.
# Runs on every push/PR with full security scanning, testing, and compliance.
#
# Jobs are organized in stages for fast feedback:
# - Stage 0: Workflow Security (actionlint, zizmor) - validates our own workflows
# - Stage 1: Fast checks (lint, syntax, type) - fail fast
# - Stage 2: Testing (unit, mutation)
# - Stage 3: Security (SAST, dependency audit, secrets, trivy)
# - Stage 4: Validation (templates, configs, schemas)
# - Stage 5: Supply Chain (scorecard, dependency-review)
# - Stage 6: Summary
#
# Security hardening:
# - harden-runner on all jobs (egress monitoring)
# - Actions pinned to SHAs (see pinact)
# - Least-privilege GITHUB_TOKEN per job
# ============================================================================

name: Hub Production CI

on:
  push:
    branches: [main, master]
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  pull_request:
    paths:
      - 'cihub/**'
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.pre-commit-config.yaml'
  workflow_dispatch:
  schedule:
    # Weekly scan for new CVEs
    - cron: '0 6 * * 1'

concurrency:
  group: hub-ci-${{ github.ref }}
  cancel-in-progress: true

# Note: No global env: block - Scorecard rejects workflows with global env vars.
# PYTHON_VERSION is defined at job-level for jobs that need it.

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  hub-ci-config:
    name: Hub CI Config
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      hub_ci_enabled: ${{ steps.outputs.outputs.hub_ci_enabled }}
      run_actionlint: ${{ steps.outputs.outputs.run_actionlint }}
      run_zizmor: ${{ steps.outputs.outputs.run_zizmor }}
      run_ruff: ${{ steps.outputs.outputs.run_ruff }}
      run_syntax: ${{ steps.outputs.outputs.run_syntax }}
      run_mypy: ${{ steps.outputs.outputs.run_mypy }}
      run_yamllint: ${{ steps.outputs.outputs.run_yamllint }}
      run_pytest: ${{ steps.outputs.outputs.run_pytest }}
      run_mutmut: ${{ steps.outputs.outputs.run_mutmut }}
      run_bandit: ${{ steps.outputs.outputs.run_bandit }}
      run_pip_audit: ${{ steps.outputs.outputs.run_pip_audit }}
      run_gitleaks: ${{ steps.outputs.outputs.run_gitleaks }}
      run_trivy: ${{ steps.outputs.outputs.run_trivy }}
      run_validate_templates: ${{ steps.outputs.outputs.run_validate_templates }}
      run_validate_configs: ${{ steps.outputs.outputs.run_validate_configs }}
      run_verify_matrix_keys: ${{ steps.outputs.outputs.run_verify_matrix_keys }}
      run_license_check: ${{ steps.outputs.outputs.run_license_check }}
      run_dependency_review: ${{ steps.outputs.outputs.run_dependency_review }}
      run_scorecard: ${{ steps.outputs.outputs.run_scorecard }}
      coverage_min: ${{ steps.outputs.outputs.coverage_min }}
      mutation_score_min: ${{ steps.outputs.outputs.mutation_score_min }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install cihub
        run: pip install -e .

      - name: Emit hub CI outputs
        id: outputs
        run: python -m cihub hub-ci outputs --github-output

  # ============================================================================
  # Stage 0: Workflow Security (validates our own workflows)
  # ============================================================================
  actionlint:
    name: Workflow Lint (actionlint)
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_actionlint == 'true' }}
    permissions:
      contents: read
      checks: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install cihub
        run: pip install -e .

      - name: Install actionlint (pinned version with checksum)
        id: actionlint-install
        run: cihub hub-ci actionlint-install --version 1.7.4 --checksum fc0a6886bbb9a23a39eeec4b176193cadb54ddbe77cdbb19b637933919545395 --dest .cihub/tools --github-output

      - name: Setup reviewdog
        uses: reviewdog/action-setup@e04ffabe3898a0af8d0fb1af00c188831c4b5893 # v1.3.2
        with:
          reviewdog_version: latest

      - name: Run actionlint with reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: cihub hub-ci actionlint --workflow .github/workflows/hub-production-ci.yml --bin "${{ steps.actionlint-install.outputs.path }}" --reviewdog

  zizmor:
    name: Workflow Security (zizmor)
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_zizmor == 'true' }}
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install cihub
        run: pip install -e .

      - name: Install zizmor
        run: pip install zizmor==0.8.0

      - name: Run zizmor
        run: python -m cihub hub-ci zizmor-run --output zizmor.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: zizmor.sarif
          category: zizmor
      - name: Upload zizmor SARIF artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: zizmor-sarif
          path: zizmor.sarif
          retention-days: 30
          if-no-files-found: warn

      - name: Check for high-severity findings
        run: python -m cihub hub-ci zizmor-check --sarif zizmor.sarif --github-summary

  # ============================================================================
  # Stage 1: Fast Checks (fail fast)
  # ============================================================================
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_ruff == 'true' }}
    permissions:
      contents: read
    outputs:
      ruff_issues: ${{ steps.ruff.outputs.issues }}
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff==0.14.10

      - name: Install cihub
        run: pip install -e .

      - name: Ruff lint
        id: ruff
        run: python -m cihub hub-ci ruff --path . --force-exclude --github-output

      - name: Ruff format check
        run: ruff format --check . --force-exclude

  syntax-check:
    name: Python Syntax
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_syntax == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install cihub
        run: pip install -e .

      - name: Check syntax
        run: cihub hub-ci syntax-check --root . --paths scripts cihub

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_mypy == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mypy
        run: pip install mypy==1.14.1 pyyaml==6.0.2 jsonschema==4.23.0 types-PyYAML==6.0.12.20241230

      - name: Run mypy
        run: mypy cihub/ --ignore-missing-imports --show-error-codes

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_yamllint == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Install yamllint
        run: pip install yamllint==1.35.1

      - name: Lint YAML
        run: 'yamllint -d "{extends: relaxed, rules: {line-length: disable}}" config/defaults.yaml config/repos/ templates/profiles/'

  # ============================================================================
  # Stage 2: Testing
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [hub-ci-config, lint, syntax-check]
    if: ${{ always() && needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_pytest == 'true' && needs.lint.result != 'failure' && needs.lint.result != 'cancelled' && needs.syntax-check.result != 'failure' && needs.syntax-check.result != 'cancelled' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: pip install --upgrade pip

      - name: Install cihub extras
        run: pip install -e ".[wizard]"

      - name: Install test dependencies
        run: pip install pytest pytest-cov pyyaml jsonschema syrupy

      - name: Run tests with coverage
        run: python -m pytest tests/ -v --cov=cihub --cov=scripts --cov-report=xml --cov-report=term-missing --cov-fail-under=${{ needs.hub-ci-config.outputs.coverage_min }} --junitxml=test-results.xml

      - name: Upload coverage
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          retention-days: 7

  mutation-tests:
    name: Mutation Tests
    runs-on: ubuntu-latest
    needs: [hub-ci-config, unit-tests]
    if: ${{ always() && needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_mutmut == 'true' && needs.unit-tests.result == 'success' }}
    permissions:
      contents: read
    outputs:
      mutation_score: ${{ steps.mutmut.outputs.mutation_score }}
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install --upgrade pip

      - name: Install cihub extras
        run: pip install -e ".[dev,wizard]"

      - name: Install mutation test dependencies
        run: pip install pytest==8.3.4 pyyaml==6.0.2 jsonschema==4.23.0 mutmut==3.4.0

      - name: Run mutation tests
        id: mutmut
        run: python -m cihub hub-ci mutmut --min-score ${{ needs.hub-ci-config.outputs.mutation_score_min }} --output-dir . --github-output --github-summary

      - name: Upload mutation results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: mutation-results
          path: |
            mutants/
            mutmut-run.log
          retention-days: 7

  # ============================================================================
  # Stage 3: Security Scanning
  # ============================================================================
  bandit:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_bandit == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install "bandit[toml]==1.8.3"

      - name: Install cihub
        run: pip install -e .

      - name: Run bandit
        run: python -m cihub hub-ci bandit --paths cihub scripts --output bandit.json --github-summary

      - name: Upload bandit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bandit-results
          path: bandit.json
          retention-days: 7

  pip-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_pip_audit == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install pip-audit
        run: pip install pip-audit==2.8.0

      - name: Install cihub
        run: pip install -e .

      - name: Run pip-audit
        run: python -m cihub hub-ci pip-audit --requirements requirements/requirements.txt requirements/requirements-dev.txt --output pip-audit.json --github-summary

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pip-audit-results
          path: pip-audit.json
          retention-days: 7

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_gitleaks == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install cihub
        run: pip install -e .

      - name: Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report result
        if: always()
        env:
          GITLEAKS_OUTCOME: ${{ steps.gitleaks.outcome }}
        run: python -m cihub hub-ci gitleaks-summary --github-summary

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_trivy == 'true' }}
    permissions:
      contents: read
      security-events: write  # For SARIF upload
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # 0.31.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy FS SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-fs

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@76071ef0d7ec797419534a183b498b4d6366cf37 # 0.31.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # ============================================================================
  # Stage 4: Validation
  # ============================================================================
  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_validate_templates == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e .

      - name: Install test dependencies
        run: pip install pytest==8.3.4 pyyaml==6.0.2 jsonschema==4.23.0

      - name: Validate templates
        run: python -m pytest tests/test_templates.py -v --tb=short

  validate-configs:
    name: Validate Configs
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_validate_configs == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -e .

      - name: Install config dependencies
        run: pip install pyyaml==6.0.2 jsonschema==4.23.0

      - name: Validate repo configs
        run: python -m cihub hub-ci validate-configs

      - name: Validate profiles
        run: python -m cihub hub-ci validate-profiles

  verify-matrix-keys:
    name: Verify Matrix Keys
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_verify_matrix_keys == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Verify matrix keys
        run: cihub hub-ci verify-matrix-keys

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_license_check == 'true' }}
    permissions:
      contents: read
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: pip install pip-licenses==5.0.0

      - name: Install cihub extras
        run: pip install -e ".[dev]"

      - name: Check licenses
        run: python -m cihub hub-ci license-check --github-summary

  # ============================================================================
  # Stage 5: Supply Chain Security
  # ============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_dependency_review == 'true' && github.event_name == 'pull_request' }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4.7.1
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    # Only run on default branch (scorecard requires it)
    needs: hub-ci-config
    if: ${{ needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && needs.hub-ci-config.outputs.run_scorecard == 'true' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
    permissions:
      contents: read
      security-events: write
      id-token: write  # Required for scorecard
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186 # v2.4.1
        with:
          results_file: scorecard.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard SARIF
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4
        with:
          sarif_file: scorecard.sarif
          category: scorecard

  # ============================================================================
  # Stage 6: Update Badges (on main only)
  # ============================================================================
  update-badges:
    name: Update Badges
    runs-on: ubuntu-latest
    needs: [hub-ci-config, lint, mutation-tests, bandit, pip-audit, zizmor]
    if: ${{ always() && needs.hub-ci-config.outputs.hub_ci_enabled == 'true' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
    permissions:
      contents: write
    env:
      PYTHON_VERSION: '3.12'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true

      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install cihub
        run: pip install -e .

      - name: Generate badges
        env:
          UPDATE_BADGES: 'true'
          RUFF_ISSUES: ${{ needs.lint.outputs.ruff_issues }}
          MUTATION_SCORE: ${{ needs.mutation-tests.outputs.mutation_score }}
        run: cihub hub-ci badges --artifacts-dir artifacts

      - name: Commit badges
        run: cihub hub-ci badges-commit

  # ============================================================================
  # Stage 7: Summary
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - hub-ci-config
      - actionlint
      - zizmor
      - lint
      - syntax-check
      - type-check
      - yaml-lint
      - unit-tests
      - mutation-tests
      - bandit
      - pip-audit
      - secret-scan
      - trivy
      - validate-templates
      - validate-configs
      - verify-matrix-keys
      - license-check
      - dependency-review
      - scorecard
    if: ${{ always() && needs.hub-ci-config.outputs.hub_ci_enabled == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install cihub
        run: pip install -e .

      - name: Generate summary
        env:
          # Use environment variables to avoid template injection vulnerabilities
          # Branch name can be attacker-controlled, so never interpolate directly in run scripts
          GH_REPOSITORY: ${{ github.repository }}
          GH_REF_NAME: ${{ github.ref_name }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_EVENT_NAME: ${{ github.event_name }}
          # Job results are safe (predefined values only) but use env vars for consistency
          RESULT_ACTIONLINT: ${{ needs.actionlint.result }}
          RESULT_ZIZMOR: ${{ needs.zizmor.result }}
          RESULT_LINT: ${{ needs.lint.result }}
          RESULT_SYNTAX: ${{ needs.syntax-check.result }}
          RESULT_TYPECHECK: ${{ needs.type-check.result }}
          RESULT_YAMLLINT: ${{ needs.yaml-lint.result }}
          RESULT_UNIT_TESTS: ${{ needs.unit-tests.result }}
          RESULT_MUTATION: ${{ needs.mutation-tests.result }}
          RESULT_BANDIT: ${{ needs.bandit.result }}
          RESULT_PIP_AUDIT: ${{ needs.pip-audit.result }}
          RESULT_SECRET_SCAN: ${{ needs.secret-scan.result }}
          RESULT_TRIVY: ${{ needs.trivy.result }}
          RESULT_TEMPLATES: ${{ needs.validate-templates.result }}
          RESULT_CONFIGS: ${{ needs.validate-configs.result }}
          RESULT_MATRIX_KEYS: ${{ needs.verify-matrix-keys.result }}
          RESULT_LICENSE: ${{ needs.license-check.result }}
          RESULT_DEP_REVIEW: ${{ needs.dependency-review.result }}
          RESULT_SCORECARD: ${{ needs.scorecard.result }}
        run: python -m cihub hub-ci summary --github-summary

      - name: Check critical failures
        env:
          # Use environment variables to avoid template injection vulnerabilities
          RESULT_ACTIONLINT: ${{ needs.actionlint.result }}
          RESULT_ZIZMOR: ${{ needs.zizmor.result }}
          RESULT_LINT: ${{ needs.lint.result }}
          RESULT_SYNTAX: ${{ needs.syntax-check.result }}
          RESULT_TYPECHECK: ${{ needs.type-check.result }}
          RESULT_YAMLLINT: ${{ needs.yaml-lint.result }}
          RESULT_UNIT_TESTS: ${{ needs.unit-tests.result }}
          RESULT_MUTATION: ${{ needs.mutation-tests.result }}
          RESULT_BANDIT: ${{ needs.bandit.result }}
          RESULT_PIP_AUDIT: ${{ needs.pip-audit.result }}
          RESULT_SECRET_SCAN: ${{ needs.secret-scan.result }}
          RESULT_TRIVY: ${{ needs.trivy.result }}
          RESULT_TEMPLATES: ${{ needs.validate-templates.result }}
          RESULT_CONFIGS: ${{ needs.validate-configs.result }}
          RESULT_MATRIX_KEYS: ${{ needs.verify-matrix-keys.result }}
          RESULT_LICENSE: ${{ needs.license-check.result }}
          RESULT_DEP_REVIEW: ${{ needs.dependency-review.result }}
          RESULT_SCORECARD: ${{ needs.scorecard.result }}
        run: python -m cihub hub-ci enforce
