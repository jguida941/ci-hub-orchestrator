# ============================================================================
# CI/CD Hub - Main Orchestrator
# ============================================================================
# This workflow orchestrates CI/CD for all configured repositories.
# It reads config, triggers builds, and aggregates reports.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Scheduled (e.g., nightly)
#   - When config changes
# ============================================================================

name: Hub Orchestrator

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repo names (empty = all)'
        required: false
        type: string
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: boolean
        default: true
      include_details:
        description: 'Include per-repo details in the summary (can be large)'
        required: false
        type: boolean
        default: true

  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - '.github/workflows/hub-orchestrator.yml'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

# Prevent concurrent runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Load Configuration
  # ============================================================================
  load-config:
    name: Load Repository Config
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.config.outputs.matrix }}
      repo_count: ${{ steps.config.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Generate Build Matrix
        id: config
        env:
          INPUT_REPOS: ${{ inputs.repos || '' }}
        run: cihub discover --dispatch-only --repos "${INPUT_REPOS:-}" --github-output

      - name: Summary
        env:
          REPO_COUNT: ${{ steps.config.outputs.count }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
        run: cihub report orchestrator-summary --mode load-config --repo-count "$REPO_COUNT"

  # ============================================================================
  # Trigger Builds for Each Repo
  # ============================================================================
  trigger-builds:
    name: Build ${{ matrix.config_basename }}
    runs-on: ubuntu-latest
    needs: load-config
    if: needs.load-config.outputs.repo_count > 0
    permissions:
      contents: read
      actions: write  # For workflow dispatch
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Trigger Repository Workflow
        id: dispatch
        env:
          HUB_DISPATCH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN || secrets.GITHUB_TOKEN }}
          CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt || '1' }}-${{ matrix.config_basename }}
        run: cihub dispatch trigger --owner "${{ matrix.owner }}" --repo "${{ matrix.name }}" --ref "${{ matrix.default_branch }}" --workflow "${{ matrix.dispatch_workflow || 'hub-ci.yml' }}" --correlation-id "${CORRELATION_ID}" --dispatch-enabled "${{ matrix.dispatch_enabled }}" --timeout 1800

      - name: Record Build Trigger
        env:
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          STEP_WORKFLOW_ID: ${{ steps.dispatch.outputs.workflow_id }}
          STEP_RUN_ID: ${{ steps.dispatch.outputs.run_id }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
        run: cihub report orchestrator-summary --mode trigger-record --owner "$MATRIX_OWNER" --repo "$MATRIX_NAME" --language "$MATRIX_LANGUAGE" --branch "$MATRIX_BRANCH" --workflow-id "$STEP_WORKFLOW_ID" --run-id "$STEP_RUN_ID" --status "Triggered"

      - name: Save Dispatch Metadata
        if: always()
        run: cihub dispatch metadata --config-basename "${{ matrix.config_basename }}" --owner "${{ matrix.owner }}" --repo "${{ matrix.name }}" --output-dir dispatch-results --subdir "${{ matrix.subdir }}" --language "${{ matrix.language }}" --branch "${{ matrix.default_branch }}" --workflow "${{ steps.dispatch.outputs.workflow_id }}" --run-id "${{ steps.dispatch.outputs.run_id }}" --correlation-id "${{ steps.dispatch.outputs.correlation_id }}" --status "${{ job.status }}"

      - name: Upload Dispatch Metadata
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: dispatch-${{ matrix.config_basename }}-${{ github.run_id }}
          path: dispatch-results/${{ matrix.config_basename }}.json
          retention-days: 7

  # ============================================================================
  # Aggregate Reports
  # ============================================================================
  aggregate-reports:
    name: Aggregate Reports
    runs-on: ubuntu-latest
    needs: [load-config, trigger-builds]
    if: always()
    permissions:
      contents: read
      actions: read  # For reading run artifacts

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download Dispatch Metadata
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          path: dispatch-artifacts
        continue-on-error: true

      - name: Generate Hub Summary and Report
        env:
          TOTAL_REPOS: ${{ needs.load-config.outputs.repo_count }}
          HUB_RUN_ID: ${{ github.run_id }}
          HUB_EVENT: ${{ github.event_name }}
          # Use HUB_DISPATCH_TOKEN for cross-repo artifact access
          HUB_DISPATCH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          CIHUB_REPORT_INCLUDE_DETAILS: ${{ inputs.include_details || 'false' }}
        run: cihub report aggregate --dispatch-dir dispatch-artifacts --output hub-report.json --details-output hub-report-details.md --defaults-file config/defaults.yaml

      - name: Upload Hub Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: hub-report-${{ github.run_id }}
          path: hub-report.json
          retention-days: 30

      - name: Upload Hub Report Details
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: hub-report-details-${{ github.run_id }}
          path: hub-report-details.md
          retention-days: 30
          if-no-files-found: warn
