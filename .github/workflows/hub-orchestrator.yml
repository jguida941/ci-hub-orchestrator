# ============================================================================
# CI/CD Hub - Main Orchestrator
# ============================================================================
# This workflow orchestrates CI/CD for all configured repositories.
# It reads config, triggers builds, and aggregates reports.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Scheduled (e.g., nightly)
#   - When config changes
# ============================================================================

name: Hub Orchestrator

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repo names (empty = all)'
        required: false
        type: string

  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - '.github/workflows/hub-orchestrator.yml'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

# Prevent concurrent runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Load Configuration
  # ============================================================================
  load-config:
    name: Load Repository Config
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.config.outputs.matrix }}
      repo_count: ${{ steps.config.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Generate Build Matrix
        id: config
        env:
          INPUT_REPOS: ${{ inputs.repos || '' }}
        run: |
          cihub discover \
            --repos "${INPUT_REPOS:-}" \
            --github-output

      - name: Summary
        env:
          REPO_COUNT: ${{ steps.config.outputs.count }}
        run: |
          {
            echo "## Hub Orchestrator"
            echo ""
            echo "**Repositories to build:** $REPO_COUNT"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Trigger Builds for Each Repo
  # ============================================================================
  trigger-builds:
    name: Build ${{ matrix.config_basename }}
    runs-on: ubuntu-latest
    needs: load-config
    if: needs.load-config.outputs.repo_count > 0
    permissions:
      contents: read
      actions: write  # For workflow dispatch
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}


      - name: Trigger Repository Workflow
        id: dispatch
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v7
        env:
          # Pass matrix/step values via env vars to prevent expression injection
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          MATRIX_CONFIG_BASENAME: ${{ matrix.config_basename }}
          MATRIX_DISPATCH_ENABLED: ${{ matrix.dispatch_enabled }}
          MATRIX_DISPATCH_WORKFLOW: ${{ matrix.dispatch_workflow }}
          GH_RUN_ID: ${{ github.run_id }}
          GH_RUN_ATTEMPT: ${{ github.run_attempt }}
        with:
          github-token: ${{ secrets.HUB_DISPATCH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            // Read values from environment variables (prevents expression injection)
            const owner = process.env.MATRIX_OWNER;
            const repo = process.env.MATRIX_NAME;
            const branch = process.env.MATRIX_BRANCH;
            const dispatchEnabled = (process.env.MATRIX_DISPATCH_ENABLED || '').toLowerCase() !== 'false';
            const correlationId = `${process.env.GH_RUN_ID}-${process.env.GH_RUN_ATTEMPT || '1'}-${process.env.MATRIX_CONFIG_BASENAME}`;

            if (!dispatchEnabled) {
              core.info(`Dispatch disabled for ${owner}/${repo}; skipping dispatch.`);
              return;
            }

            const inputs = { hub_correlation_id: correlationId };
            const MAX_POLL_MS = 30 * 60 * 1000; // 30 minutes

            // Use configurable workflow name from matrix, with fallback to hub-ci.yml
            const workflowId = process.env.MATRIX_DISPATCH_WORKFLOW || 'hub-ci.yml';
            const startedAt = Date.now();

            core.info(`Dispatching ${workflowId} on ${owner}/${repo}@${branch}`);
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: workflowId,
                ref: branch,
                inputs,
              });
            } catch (err) {
              core.setFailed(`Dispatch failed for ${owner}/${repo}: ${err.message}`);
              throw err;
            }

            let runId = '';
            let pollDelay = 5000;
            const deadline = startedAt + MAX_POLL_MS;

            while (Date.now() < deadline) {
              await new Promise((resolve) => setTimeout(resolve, pollDelay));
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowId,
                event: 'workflow_dispatch',
                branch,
                per_page: 5,
              });

            const recent = runs.data.workflow_runs.find((run) => {
                const created = new Date(run.created_at).getTime();
                return (
                  created >= startedAt - 2000 && // tighter window to reduce collisions
                  run.head_branch === branch &&
                  run.status !== 'completed'
                );
              });

              if (recent) {
                runId = String(recent.id);
                core.info(`Captured run id ${runId} for ${repo}`);
                break;
              }

              pollDelay = Math.min(pollDelay * 2, 30000); // backoff up to 30s
            }

            if (!runId) {
              core.setFailed(`Dispatched ${workflowId} for ${repo}, but could not determine run id.`);
              return;
            }

            core.setOutput('run_id', runId);
            core.setOutput('branch', branch);
            core.setOutput('workflow_id', workflowId);
            core.setOutput('correlation_id', correlationId);

      - name: Record Build Trigger
        env:
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          STEP_WORKFLOW_ID: ${{ steps.dispatch.outputs.workflow_id }}
          STEP_RUN_ID: ${{ steps.dispatch.outputs.run_id }}
        run: |
          {
            echo "## $MATRIX_NAME"
            echo ""
            echo "- **Owner:** $MATRIX_OWNER"
            echo "- **Language:** $MATRIX_LANGUAGE"
            echo "- **Branch:** $MATRIX_BRANCH"
            echo "- **Workflow:** $STEP_WORKFLOW_ID"
            echo "- **Run ID:** ${STEP_RUN_ID:-pending}"
            echo "- **Status:** Triggered"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Save Dispatch Metadata
        if: always()
        env:
          MATRIX_CONFIG_BASENAME: ${{ matrix.config_basename }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_SUBDIR: ${{ matrix.subdir }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          STEP_WORKFLOW_ID: ${{ steps.dispatch.outputs.workflow_id }}
          STEP_RUN_ID: ${{ steps.dispatch.outputs.run_id }}
          STEP_CORRELATION_ID: ${{ steps.dispatch.outputs.correlation_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          mkdir -p dispatch-results
          cat > "dispatch-results/${MATRIX_CONFIG_BASENAME}.json" << EOF
          {
            "config": "${MATRIX_CONFIG_BASENAME}",
            "repo": "${MATRIX_OWNER}/${MATRIX_NAME}",
            "subdir": "${MATRIX_SUBDIR}",
            "language": "${MATRIX_LANGUAGE}",
            "branch": "${MATRIX_BRANCH}",
            "workflow": "${STEP_WORKFLOW_ID}",
            "run_id": "${STEP_RUN_ID}",
            "correlation_id": "${STEP_CORRELATION_ID}",
            "dispatch_time": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "status": "${JOB_STATUS}"
          }
          EOF

      - name: Upload Dispatch Metadata
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: dispatch-${{ matrix.config_basename }}-${{ github.run_id }}
          path: dispatch-results/${{ matrix.config_basename }}.json
          retention-days: 7

  # ============================================================================
  # Aggregate Reports
  # ============================================================================
  aggregate-reports:
    name: Aggregate Reports
    runs-on: ubuntu-latest
    needs: [load-config, trigger-builds]
    if: always()
    permissions:
      contents: read
      actions: read  # For reading run artifacts

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download Dispatch Metadata
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          path: dispatch-artifacts
        continue-on-error: true

      - name: Generate Hub Summary and Report
        env:
          TOTAL_REPOS: ${{ needs.load-config.outputs.repo_count }}
          HUB_RUN_ID: ${{ github.run_id }}
          HUB_EVENT: ${{ github.event_name }}
          # Use HUB_DISPATCH_TOKEN for cross-repo artifact access
          HUB_DISPATCH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN }}
        run: |
          if [ -z "${HUB_DISPATCH_TOKEN}" ]; then
            echo "::error::HUB_DISPATCH_TOKEN is required for cross-repo artifact access"
            exit 1
          fi
          python -m cihub report aggregate \
            --dispatch-dir dispatch-artifacts \
            --output hub-report.json \
            --summary-file "$GITHUB_STEP_SUMMARY" \
            --defaults-file config/defaults.yaml

      - name: Upload Hub Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: hub-report-${{ github.run_id }}
          path: hub-report.json
          retention-days: 30
