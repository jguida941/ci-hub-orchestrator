# ============================================================================
# CI/CD Hub - Unified Wrapper Workflow
# ============================================================================
# This is the ONLY workflow target repos need to call.
# It reads .ci-hub.yml from the calling repo and routes to the correct
# language-specific workflow (python-ci.yml or java-ci.yml).
#
# Usage in target repo (.github/workflows/ci.yml):
#   name: CI
#   on: [push, pull_request, workflow_dispatch]
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/hub-ci.yml@main
#       secrets: inherit
#
# Configuration in target repo (.ci-hub.yml):
#   language: python
#   python:
#     version: "3.12"
#     tools:
#       pytest: { enabled: true, min_coverage: 80 }
#       ruff: { enabled: true }
# ============================================================================

name: Hub CI

on:
  workflow_call:
    inputs:
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''

permissions:
  contents: read

jobs:
  # ============================================================================
  # Config: Read .ci-hub.yml and output all settings
  # ============================================================================
  config:
    name: Parse Config
    runs-on: ubuntu-latest
    outputs:
      # Language
      language: ${{ steps.parse.outputs.language }}
      python_version: ${{ steps.parse.outputs.python_version }}
      java_version: ${{ steps.parse.outputs.java_version }}
      build_tool: ${{ steps.parse.outputs.build_tool }}
      workdir: ${{ steps.parse.outputs.workdir }}
      retention_days: ${{ steps.parse.outputs.retention_days }}
      # Thresholds
      coverage_min: ${{ steps.parse.outputs.coverage_min }}
      mutation_score_min: ${{ steps.parse.outputs.mutation_score_min }}
      owasp_cvss_fail: ${{ steps.parse.outputs.owasp_cvss_fail }}
      max_critical_vulns: ${{ steps.parse.outputs.max_critical_vulns }}
      max_high_vulns: ${{ steps.parse.outputs.max_high_vulns }}
      max_semgrep_findings: ${{ steps.parse.outputs.max_semgrep_findings }}
      max_ruff_errors: ${{ steps.parse.outputs.max_ruff_errors }}
      max_black_issues: ${{ steps.parse.outputs.max_black_issues }}
      max_isort_issues: ${{ steps.parse.outputs.max_isort_issues }}
      max_checkstyle_errors: ${{ steps.parse.outputs.max_checkstyle_errors }}
      max_spotbugs_bugs: ${{ steps.parse.outputs.max_spotbugs_bugs }}
      max_pmd_violations: ${{ steps.parse.outputs.max_pmd_violations }}
      # Python tool toggles
      run_pytest: ${{ steps.parse.outputs.run_pytest }}
      run_ruff: ${{ steps.parse.outputs.run_ruff }}
      run_bandit: ${{ steps.parse.outputs.run_bandit }}
      run_pip_audit: ${{ steps.parse.outputs.run_pip_audit }}
      run_mypy: ${{ steps.parse.outputs.run_mypy }}
      run_black: ${{ steps.parse.outputs.run_black }}
      run_isort: ${{ steps.parse.outputs.run_isort }}
      run_mutmut: ${{ steps.parse.outputs.run_mutmut }}
      run_hypothesis: ${{ steps.parse.outputs.run_hypothesis }}
      run_semgrep: ${{ steps.parse.outputs.run_semgrep }}
      run_trivy: ${{ steps.parse.outputs.run_trivy }}
      run_codeql: ${{ steps.parse.outputs.run_codeql }}
      run_docker: ${{ steps.parse.outputs.run_docker }}
      # Java tool toggles
      run_jacoco: ${{ steps.parse.outputs.run_jacoco }}
      run_checkstyle: ${{ steps.parse.outputs.run_checkstyle }}
      run_spotbugs: ${{ steps.parse.outputs.run_spotbugs }}
      run_owasp: ${{ steps.parse.outputs.run_owasp }}
      use_nvd_api_key: ${{ steps.parse.outputs.use_nvd_api_key }}
      run_pmd: ${{ steps.parse.outputs.run_pmd }}
      run_pitest: ${{ steps.parse.outputs.run_pitest }}
      run_jqwik: ${{ steps.parse.outputs.run_jqwik }}

    steps:
      - name: Checkout calling repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        env:
          HUB_REPO: ${{ inputs.hub_repo || vars.HUB_REPO }}
          HUB_REF: ${{ inputs.hub_ref || vars.HUB_REF }}
        run: |
          if [ -z "$HUB_REPO" ] || [ -z "$HUB_REF" ]; then
            echo "::error::Set inputs hub_repo/hub_ref or repo/org vars HUB_REPO and HUB_REF"
            exit 1
          fi
          python -m pip install --upgrade pip
          python -m pip install "git+https://github.com/${HUB_REPO}.git@${HUB_REF}"

      - name: Emit config outputs
        id: parse
        run: cihub config-outputs --repo . --github-output

  # ============================================================================
  # Python CI
  # ============================================================================
  python:
    name: Python CI
    needs: config
    if: needs.config.outputs.language == 'python'
    uses: ./.github/workflows/python-ci.yml
    with:
      python_version: ${{ needs.config.outputs.python_version }}
      workdir: ${{ needs.config.outputs.workdir }}
      hub_correlation_id: ${{ inputs.hub_correlation_id }}
      hub_repo: ${{ inputs.hub_repo || vars.HUB_REPO }}
      hub_ref: ${{ inputs.hub_ref || vars.HUB_REF }}

      # Tool toggles - use fromJson() for proper boolean conversion
      run_pytest: ${{ fromJson(needs.config.outputs.run_pytest) }}
      run_ruff: ${{ fromJson(needs.config.outputs.run_ruff) }}
      run_bandit: ${{ fromJson(needs.config.outputs.run_bandit) }}
      run_pip_audit: ${{ fromJson(needs.config.outputs.run_pip_audit) }}
      run_mypy: ${{ fromJson(needs.config.outputs.run_mypy) }}
      run_black: ${{ fromJson(needs.config.outputs.run_black) }}
      run_isort: ${{ fromJson(needs.config.outputs.run_isort) }}
      run_mutmut: ${{ fromJson(needs.config.outputs.run_mutmut) }}
      run_hypothesis: ${{ fromJson(needs.config.outputs.run_hypothesis) }}
      run_semgrep: ${{ fromJson(needs.config.outputs.run_semgrep) }}
      run_trivy: ${{ fromJson(needs.config.outputs.run_trivy) }}
      run_codeql: ${{ fromJson(needs.config.outputs.run_codeql) }}
      run_docker: ${{ fromJson(needs.config.outputs.run_docker) }}

      # Thresholds - use fromJson() for proper number conversion
      coverage_min: ${{ fromJson(needs.config.outputs.coverage_min) }}
      mutation_score_min: ${{ fromJson(needs.config.outputs.mutation_score_min) }}
      max_critical_vulns: ${{ fromJson(needs.config.outputs.max_critical_vulns) }}
      max_high_vulns: ${{ fromJson(needs.config.outputs.max_high_vulns) }}
      max_semgrep_findings: ${{ fromJson(needs.config.outputs.max_semgrep_findings) }}
      max_ruff_errors: ${{ fromJson(needs.config.outputs.max_ruff_errors) }}
      max_black_issues: ${{ fromJson(needs.config.outputs.max_black_issues) }}
      max_isort_issues: ${{ fromJson(needs.config.outputs.max_isort_issues) }}
      owasp_cvss_fail: ${{ fromJson(needs.config.outputs.owasp_cvss_fail) }}
      retention_days: ${{ fromJson(needs.config.outputs.retention_days) }}
    secrets: inherit

  # ============================================================================
  # Java CI
  # ============================================================================
  java:
    name: Java CI
    needs: config
    if: needs.config.outputs.language == 'java'
    uses: ./.github/workflows/java-ci.yml
    with:
      java_version: ${{ needs.config.outputs.java_version }}
      build_tool: ${{ needs.config.outputs.build_tool }}
      workdir: ${{ needs.config.outputs.workdir }}
      hub_correlation_id: ${{ inputs.hub_correlation_id }}
      hub_repo: ${{ inputs.hub_repo || vars.HUB_REPO }}
      hub_ref: ${{ inputs.hub_ref || vars.HUB_REF }}

      # Tool toggles - use fromJson() for proper boolean conversion
      run_jacoco: ${{ fromJson(needs.config.outputs.run_jacoco) }}
      run_checkstyle: ${{ fromJson(needs.config.outputs.run_checkstyle) }}
      run_spotbugs: ${{ fromJson(needs.config.outputs.run_spotbugs) }}
      run_owasp: ${{ fromJson(needs.config.outputs.run_owasp) }}
      use_nvd_api_key: ${{ fromJson(needs.config.outputs.use_nvd_api_key) }}
      run_pmd: ${{ fromJson(needs.config.outputs.run_pmd) }}
      run_pitest: ${{ fromJson(needs.config.outputs.run_pitest) }}
      run_jqwik: ${{ fromJson(needs.config.outputs.run_jqwik) }}
      run_semgrep: ${{ fromJson(needs.config.outputs.run_semgrep) }}
      run_trivy: ${{ fromJson(needs.config.outputs.run_trivy) }}
      run_codeql: ${{ fromJson(needs.config.outputs.run_codeql) }}
      run_docker: ${{ fromJson(needs.config.outputs.run_docker) }}

      # Thresholds - use fromJson() for proper number conversion
      coverage_min: ${{ fromJson(needs.config.outputs.coverage_min) }}
      mutation_score_min: ${{ fromJson(needs.config.outputs.mutation_score_min) }}
      owasp_cvss_fail: ${{ fromJson(needs.config.outputs.owasp_cvss_fail) }}
      max_critical_vulns: ${{ fromJson(needs.config.outputs.max_critical_vulns) }}
      max_high_vulns: ${{ fromJson(needs.config.outputs.max_high_vulns) }}
      max_semgrep_findings: ${{ fromJson(needs.config.outputs.max_semgrep_findings) }}
      max_checkstyle_errors: ${{ fromJson(needs.config.outputs.max_checkstyle_errors) }}
      max_spotbugs_bugs: ${{ fromJson(needs.config.outputs.max_spotbugs_bugs) }}
      max_pmd_violations: ${{ fromJson(needs.config.outputs.max_pmd_violations) }}
      retention_days: ${{ fromJson(needs.config.outputs.retention_days) }}
    secrets: inherit
