# ============================================================================
# CI/CD Hub - Security & Supply Chain
# ============================================================================
# Comprehensive security scanning for all connected repos:
#   - CodeQL (SAST)
#   - SBOM generation
#   - Dependency review
#   - ZAP DAST (for web apps)
#   - Secret scanning
# ============================================================================

name: "Hub: Security & Supply Chain"

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repos (comma-separated, empty=all)'
        required: false
        type: string
      run_zap:
        description: 'Run ZAP DAST scan (requires running app)'
        required: false
        type: boolean
        default: false

  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Discover Repos
  # ============================================================================
  discover:
    name: Discover Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.repos.outputs.matrix }}
      count: ${{ steps.repos.outputs.count }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Build Repo Matrix
        id: repos
        env:
          # Pass input via env var to prevent shell injection
          INPUT_REPOS: ${{ inputs.repos }}
        run: |
          REPOS='{"include":['
          FIRST=true
          COUNT=0

          for config in config/repos/*.yaml; do
            if [ -f "$config" ]; then
              NAME=$(grep -E "^\s+name:" "$config" | head -1 | sed 's/.*name:\s*//' | tr -d '"' | tr -d "'")
              OWNER=$(grep -E "^\s+owner:" "$config" | head -1 | sed 's/.*owner:\s*//' | tr -d '"' | tr -d "'")
              LANG=$(grep -E "^\s+language:" "$config" | head -1 | sed 's/.*language:\s*//' | tr -d '"' | tr -d "'")

              if [ -n "$NAME" ] && [ -n "$OWNER" ]; then
                if [ -n "$INPUT_REPOS" ]; then
                  if ! echo "$INPUT_REPOS" | grep -q "$NAME"; then
                    continue
                  fi
                fi

                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  REPOS+=','
                fi
                REPOS+="{\"name\":\"$NAME\",\"owner\":\"$OWNER\",\"language\":\"${LANG:-java}\"}"
                COUNT=$((COUNT + 1))
              fi
            fi
          done

          REPOS+=']}'
          {
            echo "matrix=$REPOS"
            echo "count=$COUNT"
          } >> "$GITHUB_OUTPUT"

  # ============================================================================
  # Security Scan Each Repo
  # ============================================================================
  security-scan:
    name: "Security: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    permissions:
      contents: read
      security-events: write  # For CodeQL SARIF upload
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          path: repo
          fetch-depth: 1
          persist-credentials: false
          token: ${{ secrets.HUB_DISPATCH_TOKEN || github.token }}
        continue-on-error: true

      - name: Verify checkout
        id: repo-check
        env:
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
        run: |
          if [ -d repo/.git ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Repo checkout failed for ${MATRIX_OWNER}/${MATRIX_NAME}"
          fi

      # ========================================
      # CODEQL ANALYSIS
      # ========================================
      - name: Check for source code
        id: source-check
        if: steps.repo-check.outputs.present == 'true'
        env:
          MATRIX_LANGUAGE: ${{ matrix.language }}
        working-directory: repo
        run: |
          HAS_SOURCE=false
          if [ "$MATRIX_LANGUAGE" = "java" ]; then
            # Check for Java/Kotlin source files
            if find . -name "*.java" -o -name "*.kt" 2>/dev/null | head -1 | grep -q .; then
              HAS_SOURCE=true
            fi
          elif [ "$MATRIX_LANGUAGE" = "python" ]; then
            # Check for Python source files
            if find . -name "*.py" 2>/dev/null | head -1 | grep -q .; then
              HAS_SOURCE=true
            fi
          fi
          echo "has_source=$HAS_SOURCE" >> "$GITHUB_OUTPUT"
          echo "Source code present: $HAS_SOURCE"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true'
        continue-on-error: true
        with:
          languages: ${{ matrix.language == 'java' && 'java-kotlin' || 'python' }}
          source-root: repo

      - name: Set up JDK (for Java CodeQL)
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true' && matrix.language == 'java'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4.8.0
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build for CodeQL (Java)
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true' && matrix.language == 'java'
        working-directory: repo
        run: |
          if [ -f "mvnw" ]; then
            chmod +x mvnw
            ./mvnw -B -ntp compile -DskipTests
          elif [ -f "pom.xml" ]; then
            mvn -B -ntp compile -DskipTests
          fi
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true'
        continue-on-error: true
        with:
          category: "/language:${{ matrix.language }}"

      # ========================================
      # SBOM GENERATION
      # ========================================
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        if: steps.repo-check.outputs.present == 'true'
        continue-on-error: true
        with:
          path: repo
          artifact-name: sbom-${{ matrix.name }}-${{ github.run_id }}.spdx.json
          output-file: sbom-${{ matrix.name }}.spdx.json

      # ========================================
      # DEPENDENCY REVIEW (for PRs)
      # ========================================
      - name: Dependency Review
        if: steps.repo-check.outputs.present == 'true' && github.event_name == 'pull_request'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high

      # ========================================
      # PYTHON SPECIFIC SECURITY
      # ========================================
      - name: Set up Python
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: "[Python] pip-audit"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: pip-audit
        working-directory: repo
        run: |
          pip install pip-audit==2.7.3
          pip install -r requirements.txt 2>/dev/null || true
          pip-audit --format=json --output=pip-audit-report.json 2>/dev/null || true
          VULNS=$(jq '
            if type == "array" then
              [.[] | .vulns // [] | length] | add // 0
            elif .dependencies then
              [.dependencies[] | .vulnerabilities // [] | length] | add // 0
            else 0 end
          ' pip-audit-report.json 2>/dev/null || echo 0)
          echo "vulnerabilities=$VULNS" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: "[Python] Bandit"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: bandit
        working-directory: repo
        run: |
          pip install bandit==1.7.10
          bandit -r . -f json -o bandit-report.json 2>/dev/null || true
          HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo 0)
          echo "high=$HIGH" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: "[Python] Ruff Security Rules"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: ruff-security
        working-directory: repo
        run: |
          pip install ruff==0.8.4
          ruff check . --select=S --output-format=json > ruff-security.json 2>/dev/null || true
          ISSUES=$(jq 'length' ruff-security.json 2>/dev/null || echo 0)
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      # ========================================
      # JAVA SPECIFIC SECURITY
      # ========================================
      - name: "[Java] OWASP Dependency-Check"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'java'
        id: owasp
        working-directory: repo
        run: |
          if [ -f "mvnw" ]; then
            chmod +x mvnw
            ./mvnw -B -ntp org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=11 2>/dev/null || true
          fi

          REPORT=$(find . -name "dependency-check-report.json" 2>/dev/null | head -1)
          CRITICAL=0; HIGH=0
          if [ -n "$REPORT" ] && [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
          fi
          {
            echo "critical=$CRITICAL"
            echo "high=$HIGH"
          } >> "$GITHUB_OUTPUT"
        continue-on-error: true

      # ========================================
      # GENERATE SECURITY REPORT
      # ========================================
      - name: Generate Security Summary
        env:
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          HAS_SOURCE: ${{ steps.source-check.outputs.has_source }}
          PIP_AUDIT_VULNS: ${{ steps.pip-audit.outputs.vulnerabilities }}
          BANDIT_HIGH: ${{ steps.bandit.outputs.high }}
          RUFF_ISSUES: ${{ steps.ruff-security.outputs.issues }}
          OWASP_CRITICAL: ${{ steps.owasp.outputs.critical }}
          OWASP_HIGH: ${{ steps.owasp.outputs.high }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          exec 3> "$summary_file"
          cat >&3 << EOF
          # Security & Supply Chain: ${MATRIX_NAME}

          **Language:** ${MATRIX_LANGUAGE}

          ---

          ## Jobs

          | Job | Status | Duration |
          |-----|--------|----------|
          EOF

          # Determine CodeQL status
          if [ "${HAS_SOURCE}" = "true" ]; then
            CODEQL_STATUS="Complete"
          else
            CODEQL_STATUS="Skipped (no source code)"
          fi

          if [ "${MATRIX_LANGUAGE}" = "python" ]; then
            cat >&3 << EOF
          | pip-audit | ${PIP_AUDIT_VULNS:-0} vulns | - |
          | bandit | ${BANDIT_HIGH:-0} high severity | - |
          | ruff-security | ${RUFF_ISSUES:-0} issues | - |
          | codeql | ${CODEQL_STATUS} | - |
          | sbom | Generated | - |
          EOF
          else
            cat >&3 << EOF
          | OWASP | ${OWASP_CRITICAL:-0} critical, ${OWASP_HIGH:-0} high | - |
          | codeql | ${CODEQL_STATUS} | - |
          | sbom | Generated | - |
          EOF
          fi

          cat >&3 << EOF

          ---

          ## Artifacts

          | Name | Size | Digest |
          |------|------|--------|
          | sbom-${MATRIX_NAME}.spdx.json | - | - |

          EOF
          exec 3>&-

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-reports-${{ matrix.name }}-${{ github.run_id }}
          path: |
            repo/*-report.json
            repo/ruff-security.json
            repo/**/dependency-check-report.*
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # ZAP DAST Scan (Optional)
  # ============================================================================
  zap-scan:
    name: "ZAP DAST: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    needs: discover
    if: inputs.run_zap == true && needs.discover.outputs.count > 0
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          path: repo
          fetch-depth: 1
          persist-credentials: false
          token: ${{ secrets.HUB_DISPATCH_TOKEN || github.token }}
        continue-on-error: true

      - name: Verify checkout
        id: repo-check
        env:
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
        run: |
          if [ -d repo/.git ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Repo checkout failed for ${MATRIX_OWNER}/${MATRIX_NAME}"
          fi

      - name: Check for Docker Compose
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true
        id: check-docker
        working-directory: repo
        run: |
          if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            echo "has_docker=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_docker=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Start Application
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        working-directory: repo
        run: |
          docker compose up -d
          sleep 60  # Wait for app to start

      - name: ZAP Baseline Scan
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        uses: zaproxy/action-baseline@66042c8e7e24680119199a017e5b0e8603bf4dae # v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false
        continue-on-error: true

      - name: Stop Application
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        working-directory: repo
        run: docker compose down

      - name: Generate ZAP Summary
        env:
          MATRIX_NAME: ${{ matrix.name }}
          REPO_PRESENT: ${{ steps.repo-check.outputs.present }}
          RUN_ZAP: ${{ inputs.run_zap }}
          HAS_DOCKER: ${{ steps.check-docker.outputs.has_docker }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          exec 3> "$summary_file"
          echo "## ZAP DAST Scan: ${MATRIX_NAME}" >&3
          if [ "${REPO_PRESENT}" != "true" ]; then
            echo "Skipped - Repo checkout failed" >&3
          elif [ "${RUN_ZAP}" != "true" ]; then
            echo "Skipped - run_zap input is false" >&3
          elif [ "${HAS_DOCKER}" = "true" ]; then
            echo "Scan completed. See artifacts for detailed report." >&3
          else
            echo "Skipped - No docker-compose.yml found" >&3
          fi
          exec 3>&-

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [discover, security-scan]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate Summary
        env:
          REPO_COUNT: ${{ needs.discover.outputs.count }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          exec 3> "$summary_file"
          cat >&3 << EOF
          # Security & Supply Chain Summary

          **Repositories Scanned:** ${REPO_COUNT}
          **Run:** #${RUN_NUMBER}

          ## Tools Executed

          | Tool | Purpose |
          |------|---------|
          | CodeQL | Static Application Security Testing (SAST) |
          | SBOM | Software Bill of Materials generation |
          | pip-audit / OWASP | Dependency vulnerability scanning |
          | Bandit / Ruff-S | Python security linting |
          | ZAP | Dynamic Application Security Testing (DAST) |

          EOF
          exec 3>&-
