# ============================================================================
# CI/CD Hub - Python CI Workflow
# ============================================================================
#
# Reusable workflow with boolean toggles for Python linting, testing, and
# security scanning. Configure tools via .ci-hub.yml, run via `cihub ci`.
#
# HOW IT WORKS:
#   1. Your repo calls this workflow via `uses:`
#   2. This workflow installs and runs `cihub ci`
#   3. cihub reads YOUR .ci-hub.yml config file
#   4. Tools execute based on YOUR enabled: true/false toggles
#   5. Report + summary written to .cihub/ directory
#
# TOGGLE CONFIGURATION (in your repo's .ci-hub.yml):
#   python:
#     tools:
#       pytest:    { enabled: true }   # Testing + coverage
#       ruff:      { enabled: true }   # Fast linting
#       black:     { enabled: true }   # Code formatting
#       isort:     { enabled: true }   # Import sorting
#       bandit:    { enabled: true }   # Security scanning
#       pip_audit: { enabled: true }   # Dependency vulnerabilities
#       mypy:      { enabled: false }  # Type checking (opt-in)
#       mutmut:    { enabled: true }   # Mutation testing
#       hypothesis:{ enabled: true }   # Property-based testing (with pytest)
#       semgrep:   { enabled: false }  # SAST (expensive, opt-in)
#       trivy:     { enabled: false }  # Container scan (expensive, opt-in)
#       codeql:    { enabled: false }  # CodeQL (expensive, opt-in)
#       docker:    { enabled: false }  # Docker build/test (opt-in)
#
# QUICK START WITH PROFILES (hub-side config):
#   Use a pre-built profile to generate hub configs:
#     cihub new myrepo --profile python-minimal   # pytest + ruff only (~2-5 min)
#     cihub new myrepo --profile python-quality   # All core tools (~15-30 min)
#     cihub new myrepo --profile python-security  # + semgrep, trivy, codeql
#
# THRESHOLDS (quality gates in .ci-hub.yml):
#   thresholds:
#     coverage_min: 70        # Fail if coverage < 70%
#     mutation_score_min: 70  # Fail if mutation score < 70%
#     max_high_vulns: 0       # Fail on any high-severity vulnerability
#     max_ruff_errors: 0      # Fail on any linting error
#
# CALLER EXAMPLE (minimal - config lives in .ci-hub.yml):
#   # .github/workflows/hub-ci.yml
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@v1
#       secrets: inherit
#
# INSTALL: Tools are installed from the hub repo via `pip install -e "hub[ci]"`
#          (PyPI distribution is planned; see ADR-0033).
#          Extras include: pytest, ruff, black, isort, bandit, pip-audit,
#          mypy, mutmut, hypothesis, semgrep (see pyproject.toml [ci] extras)
#
# ============================================================================

name: Python CI Pipeline

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # ---- Python Settings ----
      python_version:
        description: 'Python version'
        type: string
        default: '3.12'

      # ---- Tool Toggles ----
      run_pytest:
        description: 'Run pytest with coverage'
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit security scanner'
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit dependency check'
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy type checker'
        type: boolean
        default: false
      run_black:
        description: 'Run Black format checker'
        type: boolean
        default: true
      run_isort:
        description: 'Run isort import checker'
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        type: boolean
        default: true
      run_hypothesis:
        description: 'Run Hypothesis property-based testing'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      owasp_cvss_fail:
        description: 'CVSS score to fail on for Trivy (default: 7)'
        type: number
        default: 7
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_black_issues:
        description: 'Maximum allowed Black formatting issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_isort_issues:
        description: 'Maximum allowed isort import issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_ruff_errors:
        description: 'Maximum allowed Ruff errors (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        type: boolean
        default: true

    secrets:
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.ci.outputs.build_status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.ci.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.ci.outputs.mutation_score }}

jobs:
  ci:
    name: Python CI (cihub)
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.report.outputs.build_status }}
      coverage: ${{ steps.report.outputs.coverage }}
      mutation_score: ${{ steps.report.outputs.mutation_score }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Checkout hub repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.hub_repo }}
          ref: ${{ inputs.hub_ref }}
          path: hub
          persist-credentials: false

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install cihub + tools
        run: |
          python -m pip install --upgrade pip
          pip install -e "hub[ci]"

      - name: Run cihub ci
        env:
          WORKDIR: ${{ inputs.workdir }}
          CORRELATION_ID: ${{ inputs.hub_correlation_id }}
          WRITE_SUMMARY: ${{ inputs.write_github_summary }}
        run: |
          summary_flag="--no-write-github-summary"
          if [ "$WRITE_SUMMARY" = "true" ]; then
            summary_flag="--write-github-summary"
          fi
          cihub ci \
            --workdir "$WORKDIR" \
            --correlation-id "$CORRELATION_ID" \
            --output-dir .cihub \
            --install-deps \
            $summary_flag

      - name: Read report outputs
        id: report
        run: |
          cihub report outputs --report .cihub/report.json

      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.arme tifact_prefix }}ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/tool-outputs/*.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: warn
