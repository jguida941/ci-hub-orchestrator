# ============================================================================
# CI/CD Hub - Reusable Python CI Workflow
# ============================================================================
# Call this workflow from any Python repository to run the full CI pipeline.
#
# Usage in your repo's workflow:
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@main
#       with:
#         python_version: '3.12'
#         run_bandit: true
#       secrets: inherit
# ============================================================================

name: Python CI Pipeline

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # ---- Python Settings ----
      python_version:
        description: 'Python version'
        type: string
        default: '3.12'

      # ---- Tool Toggles ----
      run_pytest:
        description: 'Run pytest with coverage'
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit security scanner'
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit dependency check'
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy type checker'
        type: boolean
        default: false
      run_black:
        description: 'Run Black format checker'
        type: boolean
        default: true
      run_isort:
        description: 'Run isort import checker'
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        type: boolean
        default: true
      run_hypothesis:
        description: 'Run Hypothesis property-based testing'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_black_issues:
        description: 'Maximum allowed Black formatting issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_isort_issues:
        description: 'Maximum allowed isort import issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_ruff_errors:
        description: 'Maximum allowed Ruff errors (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Threshold Override (single input, all thresholds) ----
      # YAML string containing thresholds from .ci-hub.yml or orchestrator
      # Takes precedence over individual threshold inputs above
      # Format: "coverage_min: 80\nmax_critical_vulns: 0\n..."
      threshold_overrides_yaml:
        description: 'YAML string with threshold overrides (from .ci-hub.yml)'
        type: string
        default: ''

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''

    secrets:
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.test.outputs.status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.test.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.mutation-test.outputs.score }}

jobs:
  # ============================================================================
  # Lint
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    outputs:
      ruff_errors: ${{ steps.ruff.outputs.errors }}
      bandit_high: ${{ steps.bandit.outputs.high }}
      bandit_medium: ${{ steps.bandit.outputs.medium }}
      black_issues: ${{ steps.black.outputs.issues }}
      isort_issues: ${{ steps.isort.outputs.issues }}
      # Effective thresholds (from .ci-hub.yml or inputs)
      eff_coverage_min: ${{ steps.thresholds.outputs.coverage_min }}
      eff_mutation_score_min: ${{ steps.thresholds.outputs.mutation_score_min }}
      eff_max_critical_vulns: ${{ steps.thresholds.outputs.max_critical_vulns }}
      eff_max_high_vulns: ${{ steps.thresholds.outputs.max_high_vulns }}
      eff_max_semgrep_findings: ${{ steps.thresholds.outputs.max_semgrep_findings }}
      eff_max_black_issues: ${{ steps.thresholds.outputs.max_black_issues }}
      eff_max_isort_issues: ${{ steps.thresholds.outputs.max_isort_issues }}
      eff_max_ruff_errors: ${{ steps.thresholds.outputs.max_ruff_errors }}
      eff_owasp_cvss_fail: ${{ steps.thresholds.outputs.owasp_cvss_fail }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ========================================
      # RESOLVE EFFECTIVE THRESHOLDS
      # Priority: threshold_overrides_yaml > .ci-hub.yml > inputs
      # See ADR-0024 for rationale
      # ========================================
      - name: Resolve Thresholds
        id: thresholds
        run: |
          # Start with input defaults
          COVERAGE_MIN="${{ inputs.coverage_min }}"
          MUTATION_SCORE_MIN="${{ inputs.mutation_score_min }}"
          MAX_CRITICAL_VULNS="${{ inputs.max_critical_vulns }}"
          MAX_HIGH_VULNS="${{ inputs.max_high_vulns }}"
          MAX_SEMGREP_FINDINGS="${{ inputs.max_semgrep_findings }}"
          MAX_BLACK_ISSUES="${{ inputs.max_black_issues }}"
          MAX_ISORT_ISSUES="${{ inputs.max_isort_issues }}"
          MAX_RUFF_ERRORS="${{ inputs.max_ruff_errors }}"
          # CVSS threshold for Trivy - named owasp_cvss_fail for consistency with Java (default: 7)
          OWASP_CVSS_FAIL=7

          # Check for .ci-hub.yml in repo
          if [ -f ".ci-hub.yml" ]; then
            echo "Found .ci-hub.yml, loading thresholds..."
            python3 << 'PYEOF'
          import yaml
          import os

          try:
              with open('.ci-hub.yml') as f:
                  data = yaml.safe_load(f) or {}
              thresholds = data.get('thresholds', {})
              if thresholds:
                  print(f"Loaded thresholds from .ci-hub.yml: {thresholds}")
                  # Write to env file for shell to pick up
                  with open('_thresholds_from_config.env', 'w') as ef:
                      for k, v in thresholds.items():
                          ef.write(f"{k.upper()}={v}\n")
          except Exception as e:
              print(f"Warning: could not read .ci-hub.yml: {e}")
          PYEOF
            if [ -f "_thresholds_from_config.env" ]; then
              source _thresholds_from_config.env
              rm -f _thresholds_from_config.env
            fi
          fi

          # Override with threshold_overrides_yaml if provided (highest precedence)
          OVERRIDES='${{ inputs.threshold_overrides_yaml }}'
          if [ -n "$OVERRIDES" ]; then
            echo "Applying threshold_overrides_yaml..."
            OVERRIDES="$OVERRIDES" python3 << 'PYEOF'
          import os
          import yaml

          try:
              raw = os.environ.get("OVERRIDES", "")
              data = yaml.safe_load(raw) or {}
              with open('_thresholds_override.env', 'w') as ef:
                  for k, v in data.items():
                      ef.write(f"{k.upper()}={v}\n")
              print(f"Applied overrides: {data}")
          except Exception as e:
              print(f"Warning: could not parse threshold_overrides_yaml: {e}")
          PYEOF
            if [ -f "_thresholds_override.env" ]; then
              source _thresholds_override.env
              rm -f _thresholds_override.env
            fi
          fi

          # Export effective thresholds as outputs
          {
            echo "coverage_min=$COVERAGE_MIN"
            echo "mutation_score_min=$MUTATION_SCORE_MIN"
            echo "max_critical_vulns=$MAX_CRITICAL_VULNS"
            echo "max_high_vulns=$MAX_HIGH_VULNS"
            echo "max_semgrep_findings=$MAX_SEMGREP_FINDINGS"
            echo "max_black_issues=$MAX_BLACK_ISSUES"
            echo "max_isort_issues=$MAX_ISORT_ISSUES"
            echo "max_ruff_errors=$MAX_RUFF_ERRORS"
            echo "owasp_cvss_fail=$OWASP_CVSS_FAIL"
          } >> "$GITHUB_OUTPUT"

          echo "Effective thresholds:"
          echo "  coverage_min: $COVERAGE_MIN"
          echo "  mutation_score_min: $MUTATION_SCORE_MIN"
          echo "  max_critical_vulns: $MAX_CRITICAL_VULNS"
          echo "  max_high_vulns: $MAX_HIGH_VULNS"

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Linters
        run: |
          pip install --upgrade pip
          pip install ruff bandit black isort

      - name: Run Ruff
        if: inputs.run_ruff
        id: ruff
        run: |
          ruff check . --output-format=json --output-file=ruff-report.json || true
          ruff check . --output-format=github || true

          # Count errors safely
          ERRORS=0
          if [ -f "ruff-report.json" ]; then
            COUNT=$(jq '. | length' ruff-report.json 2>/dev/null || true)
            if [ -n "$COUNT" ] && [ "$COUNT" -gt 0 ]; then
              ERRORS=$COUNT
            fi
          fi
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"

      - name: Enforce Ruff Threshold
        if: inputs.run_ruff
        run: |
          ERRORS="${{ steps.ruff.outputs.errors || 0 }}"
          MAX="${{ steps.thresholds.outputs.max_ruff_errors || 0 }}"
          if [ "$ERRORS" -gt "$MAX" ]; then
            echo "::error::Ruff errors ($ERRORS) exceed max_ruff_errors $MAX"
            exit 1
          fi

      - name: Upload Ruff Report
        if: always() && inputs.run_ruff
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}ruff-report
          path: ruff-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Run Bandit
        if: inputs.run_bandit
        id: bandit
        run: |
          # Exclude test directories - assert statements in tests are expected (B101 false positives)
          bandit -r . --exclude ./tests,./test -f json -o bandit-report.json || true

          # Count issues safely
          HIGH=0
          MEDIUM=0
          LOW=0
          if [ -f "bandit-report.json" ]; then
            H=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || true)
            M=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json 2>/dev/null || true)
            L=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-report.json 2>/dev/null || true)
            [ -n "$H" ] && [ "$H" -ge 0 ] && HIGH=$H
            [ -n "$M" ] && [ "$M" -ge 0 ] && MEDIUM=$M
            [ -n "$L" ] && [ "$L" -ge 0 ] && LOW=$L
          fi
          {
            echo "high=$HIGH"
            echo "medium=$MEDIUM"
            echo "low=$LOW"
          } >> "$GITHUB_OUTPUT"

      - name: Upload Bandit Report
        if: always() && inputs.run_bandit
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}bandit-report
          path: bandit-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Bandit Thresholds
        if: inputs.run_bandit
        run: |
          HIGH="${{ steps.bandit.outputs.high || 0 }}"
          MAX_HIGH="${{ steps.thresholds.outputs.max_high_vulns || 0 }}"
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "::error::Bandit HIGH findings ($HIGH) exceed max_high_vulns $MAX_HIGH"
            exit 1
          fi

      - name: Run Black
        if: inputs.run_black
        id: black
        run: |
          black --check . 2>&1 | tee black-output.txt || true
          ISSUES=0
          if [ -f black-output.txt ]; then
            COUNT=$(grep -c "would reformat" black-output.txt 2>/dev/null || true)
            if [ -n "$COUNT" ] && [ "$COUNT" -gt 0 ]; then
              ISSUES=$COUNT
            fi
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"

      - name: Enforce Black Threshold
        if: inputs.run_black
        run: |
          ISSUES="${{ steps.black.outputs.issues || 0 }}"
          MAX="${{ steps.thresholds.outputs.max_black_issues || 0 }}"
          if [ "$ISSUES" -gt "$MAX" ]; then
            echo "::error::Black formatting issues ($ISSUES) exceed max_black_issues $MAX"
            exit 1
          fi

      - name: Upload Black Output
        if: always() && inputs.run_black
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}black-output
          path: black-output.txt
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Run isort
        if: inputs.run_isort
        id: isort
        run: |
          isort --check-only --diff . 2>&1 | tee isort-output.txt || true
          # Count ERROR lines (isort says "ERROR: <file> Imports are incorrectly sorted")
          ISSUES=0
          if [ -f isort-output.txt ]; then
            COUNT=$(grep -c "^ERROR:" isort-output.txt 2>/dev/null || true)
            if [ -n "$COUNT" ] && [ "$COUNT" -gt 0 ]; then
              ISSUES=$COUNT
            fi
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"

      - name: Enforce isort Threshold
        if: inputs.run_isort
        run: |
          ISSUES="${{ steps.isort.outputs.issues || 0 }}"
          MAX="${{ steps.thresholds.outputs.max_isort_issues || 0 }}"
          if [ "$ISSUES" -gt "$MAX" ]; then
            echo "::error::isort import issues ($ISSUES) exceed max_isort_issues $MAX"
            exit 1
          fi

      - name: Upload isort Output
        if: always() && inputs.run_isort
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}isort-output
          path: isort-output.txt
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Lint Summary
        if: always()
        run: |
          {
            echo "## Lint Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Testing | pytest | ${{ inputs.run_pytest }} |"
            echo "| Testing | mutmut | ${{ inputs.run_mutmut }} |"
            echo "| Testing | Hypothesis | ${{ inputs.run_hypothesis }} |"
            echo "| Linting | Ruff | ${{ inputs.run_ruff }} |"
            echo "| Linting | Black | ${{ inputs.run_black }} |"
            echo "| Linting | isort | ${{ inputs.run_isort }} |"
            echo "| Linting | mypy | ${{ inputs.run_mypy }} |"
            echo "| Security | Bandit | ${{ inputs.run_bandit }} |"
            echo "| Security | pip-audit | ${{ inputs.run_pip_audit }} |"
            echo "| Security | Semgrep | ${{ inputs.run_semgrep }} |"
            echo "| Security | Trivy | ${{ inputs.run_trivy }} |"
            echo "| Security | CodeQL | ${{ inputs.run_codeql }} |"
            echo "| Container | Docker | ${{ inputs.run_docker }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Min Coverage | ${{ steps.thresholds.outputs.coverage_min }}% |"
            echo "| Min Mutation Score | ${{ steps.thresholds.outputs.mutation_score_min }}% |"
            echo "| Max Ruff Errors | ${{ steps.thresholds.outputs.max_ruff_errors }} |"
            echo "| Max Black Issues | ${{ steps.thresholds.outputs.max_black_issues }} |"
            echo "| Max isort Issues | ${{ steps.thresholds.outputs.max_isort_issues }} |"
            echo "| Max Critical Vulns | ${{ steps.thresholds.outputs.max_critical_vulns }} |"
            echo "| Max High Vulns | ${{ steps.thresholds.outputs.max_high_vulns }} |"
            echo "| Max Semgrep Findings | ${{ steps.thresholds.outputs.max_semgrep_findings }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo ""
            echo "#### Lint"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            # Ruff
            if [ "${{ inputs.run_ruff }}" != "true" ]; then
              echo "| Ruff | SKIP | - |"
            else
              RUFF_ISSUES="${{ steps.ruff.outputs.errors || 0 }}"
              RUFF_MAX="${{ steps.thresholds.outputs.max_ruff_errors || 0 }}"
              if [ "${RUFF_ISSUES:-0}" -le "${RUFF_MAX:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Ruff | $STATUS | issues: ${RUFF_ISSUES:-0} (max ${RUFF_MAX:-0}) |"
            fi

            # Black
            if [ "${{ inputs.run_black }}" != "true" ]; then
              echo "| Black | SKIP | - |"
            else
              BLACK_ISSUES="${{ steps.black.outputs.issues || 0 }}"
              BLACK_MAX="${{ steps.thresholds.outputs.max_black_issues || 0 }}"
              if [ "${BLACK_ISSUES:-0}" -le "${BLACK_MAX:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Black | $STATUS | issues: ${BLACK_ISSUES:-0} (max ${BLACK_MAX:-0}) |"
            fi

            # isort
            if [ "${{ inputs.run_isort }}" != "true" ]; then
              echo "| isort | SKIP | - |"
            else
              ISORT_ISSUES="${{ steps.isort.outputs.issues || 0 }}"
              ISORT_MAX="${{ steps.thresholds.outputs.max_isort_issues || 0 }}"
              if [ "${ISORT_ISSUES:-0}" -le "${ISORT_MAX:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| isort | $STATUS | issues: ${ISORT_ISSUES:-0} (max ${ISORT_MAX:-0}) |"
            fi

            # mypy (separate job)
            if [ "${{ inputs.run_mypy }}" != "true" ]; then
              echo "| mypy | SKIP | - |"
            else
              echo "| mypy | ENABLED | See Type Check job |"
            fi

            echo ""
            echo "#### Security"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            # Bandit
            if [ "${{ inputs.run_bandit }}" != "true" ]; then
              echo "| Bandit | SKIP | - |"
            else
              BANDIT_HIGH="${{ steps.bandit.outputs.high || 0 }}"
              BANDIT_MED="${{ steps.bandit.outputs.medium || 0 }}"
              BANDIT_LOW="${{ steps.bandit.outputs.low || 0 }}"
              BANDIT_MAX="${{ steps.thresholds.outputs.max_high_vulns || 0 }}"
              if [ "${BANDIT_HIGH:-0}" -le "${BANDIT_MAX:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Bandit | $STATUS | high: ${BANDIT_HIGH:-0}, med: ${BANDIT_MED:-0}, low: ${BANDIT_LOW:-0} (max high ${BANDIT_MAX:-0}) |"
            fi

            # pip-audit (separate job)
            if [ "${{ inputs.run_pip_audit }}" = "true" ]; then
              echo "| pip-audit | ENABLED | See Security Scan job |"
            else
              echo "| pip-audit | SKIP | - |"
            fi

            # Semgrep (separate job)
            if [ "${{ inputs.run_semgrep }}" = "true" ]; then
              echo "| Semgrep | ENABLED | See Semgrep job |"
            else
              echo "| Semgrep | SKIP | - |"
            fi

            # Trivy (separate job)
            if [ "${{ inputs.run_trivy }}" = "true" ]; then
              echo "| Trivy | ENABLED | See Trivy job |"
            else
              echo "| Trivy | SKIP | - |"
            fi

            # CodeQL (separate job)
            if [ "${{ inputs.run_codeql }}" = "true" ]; then
              echo "| CodeQL | ENABLED | See CodeQL job |"
            else
              echo "| CodeQL | SKIP | - |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Test
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      status: ${{ steps.test.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}
      tests_passed: ${{ steps.test.outputs.tests_passed }}
      tests_failed: ${{ steps.test.outputs.tests_failed }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "requirements-dev.txt" ]; then pip install -r requirements-dev.txt; fi
          if [ -f "pyproject.toml" ]; then pip install -e ".[dev]" || pip install -e .; fi
          pip install pytest pytest-cov hypothesis

      - name: Run Tests
        id: test
        if: inputs.run_pytest
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term --junitxml=test-results.xml -v || true

          # Extract test counts from JUnit XML
          PASSED=0
          FAILED=0
          if [ -f "test-results.xml" ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' test-results.xml | head -1 || echo 0)
            FAILURES=$(grep -oP 'failures="\K[0-9]+' test-results.xml | head -1 || echo 0)
            ERRORS=$(grep -oP 'errors="\K[0-9]+' test-results.xml | head -1 || echo 0)
            FAILED=$((FAILURES + ERRORS))
            PASSED=$((TESTS - FAILED))
          fi
          echo "tests_passed=$PASSED" >> "$GITHUB_OUTPUT"
          echo "tests_failed=$FAILED" >> "$GITHUB_OUTPUT"

      - name: Run Hypothesis Property Tests
        id: hypothesis
        if: inputs.run_hypothesis
        run: |
          # Run with hypothesis statistics to capture example counts
          # Property tests gate on pass/fail - build fails if any property test fails
          pytest --hypothesis-show-statistics -v 2>&1 | tee hypothesis-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          EXAMPLES=$(grep -oP '\d+(?= passing examples)' hypothesis-output.txt | tail -1 || echo 0)
          echo "examples=${EXAMPLES:-0}" >> "$GITHUB_OUTPUT"
          echo "Hypothesis: ${EXAMPLES:-0} passing examples"
          exit "$EXIT_CODE"

      - name: Extract Coverage
        id: coverage
        if: inputs.run_pytest
        run: |
          COVERAGE=0
          if [ -f "coverage.xml" ]; then
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1 | awk '{printf "%.0f", $1 * 100}')
          fi
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          echo "Coverage: $COVERAGE%"

      - name: Check Coverage Threshold
        if: inputs.run_pytest
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage || 0 }}
          MIN=${{ needs.lint.outputs.eff_coverage_min }}
          if [ "$COVERAGE" -lt "$MIN" ]; then
            echo "::error::Coverage $COVERAGE% is below minimum $MIN%"
            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          {
            echo "## Test Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Testing | pytest | ${{ inputs.run_pytest }} |"
            echo "| Testing | Hypothesis | ${{ inputs.run_hypothesis }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Min Coverage | ${{ needs.lint.outputs.eff_coverage_min }}% |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ "${{ inputs.run_pytest }}" != "true" ]; then
              echo "| pytest | SKIP | - |"
            else
              TESTS_PASSED="${{ steps.test.outputs.tests_passed || 0 }}"
              TESTS_FAILED="${{ steps.test.outputs.tests_failed || 0 }}"
              COVERAGE="${{ steps.coverage.outputs.percentage || 0 }}"
              MIN_COVERAGE="${{ needs.lint.outputs.eff_coverage_min }}"
              if [ "${TESTS_FAILED:-0}" -gt 0 ] || [ "${COVERAGE:-0}" -lt "${MIN_COVERAGE:-0}" ]; then
                STATUS="FAIL"
              else
                STATUS="PASS"
              fi
              echo "| pytest | $STATUS | passed: ${TESTS_PASSED:-0}, failed: ${TESTS_FAILED:-0}, coverage: ${COVERAGE:-0}% (min ${MIN_COVERAGE:-0}%) |"
            fi

            if [ "${{ inputs.run_hypothesis }}" != "true" ]; then
              echo "| Hypothesis | SKIP | - |"
            else
              HYP_OUTCOME="${{ steps.hypothesis.outcome }}"
              if [ "$HYP_OUTCOME" = "success" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              EXAMPLES="${{ steps.hypothesis.outputs.examples || 0 }}"
              echo "| Hypothesis | $STATUS | examples: ${EXAMPLES:-0} |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Test Results
        if: always() && inputs.run_pytest
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}test-results
          path: test-results.xml
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload Hypothesis Output
        if: always() && inputs.run_hypothesis
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}hypothesis-output
          path: hypothesis-output.txt
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Upload to Codecov
        if: inputs.run_pytest
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    if: always() && inputs.run_pip_audit
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --format=json --output=pip-audit-report.json || true

      - name: Upload pip-audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}pip-audit-report
          path: pip-audit-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce pip-audit Thresholds
        run: |
          CRITICAL=0
          HIGH=0
          MAX_CRITICAL="${{ needs.lint.outputs.eff_max_critical_vulns || 0 }}"
          MAX_HIGH="${{ needs.lint.outputs.eff_max_high_vulns || 0 }}"

          if [ -f "pip-audit-report.json" ]; then
            # pip-audit does not consistently emit severity; treat all findings as HIGH
            HIGH=$(jq '[.dependencies[]?.vulnerabilities[]?] | length' pip-audit-report.json 2>/dev/null || echo 0)
          fi

          echo "critical=$CRITICAL, high=$HIGH"
          if [ "$CRITICAL" -gt "$MAX_CRITICAL" ]; then
            echo "::error::pip-audit critical findings ($CRITICAL) exceed max_critical_vulns $MAX_CRITICAL"
            exit 1
          fi
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "::error::pip-audit high findings ($HIGH) exceed max_high_vulns $MAX_HIGH"
            exit 1
          fi

      - name: Security Scan Summary
        if: always()
        run: |
          {
            echo "## Security Scan Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | pip-audit | ${{ inputs.run_pip_audit }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max Critical Vulns | ${{ needs.lint.outputs.eff_max_critical_vulns }} |"
            echo "| Max High Vulns | ${{ needs.lint.outputs.eff_max_high_vulns }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            CRITICAL=0
            HIGH=0
            if [ -f "pip-audit-report.json" ]; then
              HIGH=$(python -c "import json; from pathlib import Path; path = Path('pip-audit-report.json'); data = json.loads(path.read_text()) if path.exists() else {}; print(sum(len(dep.get('vulnerabilities', []) or []) for dep in data.get('dependencies', [])))")
            fi
            MAX_CRITICAL="${{ needs.lint.outputs.eff_max_critical_vulns || 0 }}"
            MAX_HIGH="${{ needs.lint.outputs.eff_max_high_vulns || 0 }}"
            if [ "${CRITICAL:-0}" -le "${MAX_CRITICAL:-0}" ] && [ "${HIGH:-0}" -le "${MAX_HIGH:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| pip-audit | $STATUS | high: ${HIGH:-0} (max ${MAX_HIGH:-0}), critical: ${CRITICAL:-0} (max ${MAX_CRITICAL:-0}) |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Type Checking
  # ============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    if: inputs.run_mypy
    outputs:
      errors: ${{ steps.mypy.outputs.errors }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install mypy
        run: |
          pip install mypy
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi

      - name: Run mypy
        id: mypy
        run: |
          mypy . --ignore-missing-imports 2>&1 | tee mypy-output.txt || true
          ERRORS=$(grep -c ": error:" mypy-output.txt 2>/dev/null || echo 0)
          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"

      - name: Upload mypy Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}mypy-output
          path: mypy-output.txt
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Type Check Summary
        if: always()
        run: |
          {
            echo "## Type Check Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Linting | mypy | ${{ inputs.run_mypy }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max mypy errors | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            ERRORS="${{ steps.mypy.outputs.errors || 0 }}"
            if [ "${ERRORS:-0}" -eq 0 ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| mypy | $STATUS | errors: ${ERRORS:-0} |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Mutation Testing
  # ============================================================================
  mutation-test:
    name: Mutation Testing
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always() && inputs.run_mutmut
    outputs:
      score: ${{ steps.mutmut.outputs.score }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "requirements-dev.txt" ]; then pip install -r requirements-dev.txt; fi
          if [ -f "pyproject.toml" ]; then pip install -e ".[dev]" || pip install -e .; fi
          pip install pytest mutmut

      - name: Run mutmut
        id: mutmut
        run: |
          KILLED=0
          SURVIVED=0
          SCORE=0

          # mutmut 3.x requires config in pyproject.toml or setup.cfg (no CLI options)
          # Check if config exists, if not create a temporary one
          HAS_MUTMUT_CONFIG=false
          if [ -f "pyproject.toml" ] && grep -q '\[tool\.mutmut\]' pyproject.toml; then
            HAS_MUTMUT_CONFIG=true
            echo "Found [tool.mutmut] in pyproject.toml - using project config"
          elif [ -f "setup.cfg" ] && grep -q '\[mutmut\]' setup.cfg; then
            HAS_MUTMUT_CONFIG=true
            echo "Found [mutmut] in setup.cfg - using project config"
          fi

          if [ "$HAS_MUTMUT_CONFIG" = "false" ]; then
            # No config - detect source dir and create temporary config
            SRC_DIR=""
            if [ -d "src" ]; then
              SRC_DIR="src/"
            else
              # Look for Python packages (dirs with __init__.py), excluding tests/venv
              for dir in */; do
                dir="${dir%/}"
                if [ -f "$dir/__init__.py" ] && [[ ! "$dir" =~ ^(tests?|venv|\.venv|build|dist)$ ]]; then
                  SRC_DIR="$dir/"
                  break
                fi
              done
            fi

            if [ -z "$SRC_DIR" ]; then
              SRC_DIR="./"
            fi
            echo "No mutmut config found - creating temporary config for: $SRC_DIR"
            ls -la "${SRC_DIR%/}" || echo "Cannot list $SRC_DIR"

            # Create setup.cfg with mutmut config (mutmut 3.x reads this)
            if [ -f "setup.cfg" ]; then
              # Append to existing setup.cfg
              echo -e "\n[mutmut]\npaths_to_mutate=$SRC_DIR" >> setup.cfg
            else
              echo -e "[mutmut]\npaths_to_mutate=$SRC_DIR" > setup.cfg
            fi
            echo "Created [mutmut] section in setup.cfg with paths_to_mutate=$SRC_DIR"
          fi

          echo "Running: mutmut run"
          timeout 600 mutmut run 2>&1 | tee mutmut-run.log || {
            echo "::warning::mutmut run failed or timed out"
          }

          # Parse results from mutmut 3.x run output
          # Final line format: "â ™ 73/73  ðŸŽ‰ 73 ðŸ«¥ 0  â° 0  ðŸ¤” 0  ðŸ™ 0  ðŸ”‡ 0"
          # ðŸŽ‰ = killed, ðŸ™ = survived
          if grep -q "mutations/second" mutmut-run.log; then
            # Get the line with final counts (contains X/X pattern)
            FINAL=$(grep -E '[0-9]+/[0-9]+' mutmut-run.log | tail -1)
            echo "Final line: $FINAL"
            # Extract killed (after ðŸŽ‰) and survived (after ðŸ™)
            KILLED=$(echo "$FINAL" | sed -n 's/.*ðŸŽ‰[[:space:]]*\([0-9]*\).*/\1/p' | head -1)
            SURVIVED=$(echo "$FINAL" | sed -n 's/.*ðŸ™[[:space:]]*\([0-9]*\).*/\1/p' | head -1)
            KILLED=${KILLED:-0}
            SURVIVED=${SURVIVED:-0}
            TOTAL=$((KILLED + SURVIVED))
            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$((KILLED * 100 / TOTAL))
            fi
            echo "Parsed: killed=$KILLED, survived=$SURVIVED, total=$TOTAL, score=$SCORE"
          else
            echo "::warning::mutmut did not complete successfully"
          fi

          {
            echo "killed=$KILLED"
            echo "survived=$SURVIVED"
            echo "score=$SCORE"
          } >> "$GITHUB_OUTPUT"
          echo "Mutation Score: $SCORE% (killed=$KILLED, survived=$SURVIVED)"
        continue-on-error: true
        timeout-minutes: 15

      - name: Upload mutmut Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}mutmut-log
          path: mutmut-run.log
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Mutation Threshold
        run: |
          SCORE=${{ steps.mutmut.outputs.score || 0 }}
          MIN=${{ needs.lint.outputs.eff_mutation_score_min }}
          if [ "$SCORE" -lt "$MIN" ]; then
            echo "::error::Mutation score $SCORE% is below minimum $MIN%"
            exit 1
          fi

      - name: Mutation Summary
        if: always()
        run: |
          {
            echo "## Mutation Testing Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Testing | mutmut | ${{ inputs.run_mutmut }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Min Mutation Score | ${{ needs.lint.outputs.eff_mutation_score_min }}% |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            SCORE="${{ steps.mutmut.outputs.score || 0 }}"
            MIN_SCORE="${{ needs.lint.outputs.eff_mutation_score_min }}"
            if [ "${SCORE:-0}" -ge "${MIN_SCORE:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| mutmut | $STATUS | score: ${SCORE:-0}% (min ${MIN_SCORE:-0}%), killed: ${{ steps.mutmut.outputs.killed || 0 }}, survived: ${{ steps.mutmut.outputs.survived || 0 }} |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Semgrep SAST
  # ============================================================================
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always() && inputs.run_semgrep
    outputs:
      findings: ${{ steps.semgrep.outputs.findings }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        id: semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true

          FINDINGS=0
          if [ -f "semgrep-report.json" ]; then
            FINDINGS=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)
          fi

          echo "findings=$FINDINGS" >> "$GITHUB_OUTPUT"
          echo "Semgrep Findings: $FINDINGS"
        continue-on-error: true

      - name: Semgrep Summary
        if: always()
        run: |
          {
            echo "## Semgrep SAST Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | Semgrep | ${{ inputs.run_semgrep }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max Semgrep Findings | ${{ needs.lint.outputs.eff_max_semgrep_findings }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            FINDINGS="${{ steps.semgrep.outputs.findings || 0 }}"
            MAX_FINDINGS="${{ needs.lint.outputs.eff_max_semgrep_findings || 0 }}"
            if [ "${FINDINGS:-0}" -le "${MAX_FINDINGS:-0}" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| Semgrep | $STATUS | findings: ${FINDINGS:-0} (max ${MAX_FINDINGS:-0}) |"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Semgrep Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}semgrep-report
          path: semgrep-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Semgrep Threshold
        run: |
          FINDINGS=${{ steps.semgrep.outputs.findings || 0 }}
          MAX_FINDINGS=${{ needs.lint.outputs.eff_max_semgrep_findings || 0 }}
          if [ "$FINDINGS" -gt "$MAX_FINDINGS" ]; then
            echo "::error::Semgrep reported $FINDINGS findings (max: $MAX_FINDINGS)"
            exit 1
          fi

  # ============================================================================
  # Trivy Container Scan
  # ============================================================================
  trivy:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: always() && inputs.run_trivy
    outputs:
      critical: ${{ steps.trivy-parse.outputs.critical }}
      high: ${{ steps.trivy-parse.outputs.high }}
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for Dockerfile
        id: check-dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No Dockerfile found - skipping Trivy container scan"
          fi

      - name: Run Trivy Scan
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: ${{ inputs.workdir }}
          format: 'json'
          output: 'trivy-report.json'
        continue-on-error: true

      - name: Parse Trivy Results
        if: steps.check-dockerfile.outputs.exists == 'true'
        id: trivy-parse
        run: |
          CRITICAL=0
          HIGH=0
          # trivy-action outputs to workspace root, not working-directory
          REPORT="${{ github.workspace }}/trivy-report.json"
          if [ -f "$REPORT" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$REPORT" 2>/dev/null || echo 0)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$REPORT" 2>/dev/null || echo 0)
          fi
          echo "critical=$CRITICAL" >> "$GITHUB_OUTPUT"
          echo "high=$HIGH" >> "$GITHUB_OUTPUT"
          echo "Trivy: $CRITICAL critical, $HIGH high"

      - name: Trivy Summary
        if: always()
        run: |
          {
            echo "## Trivy Container Scan Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | Trivy | ${{ inputs.run_trivy }} |"
            echo ""
            echo "### Thresholds (effective)"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Max Critical Vulns | ${{ needs.lint.outputs.eff_max_critical_vulns }} |"
            echo "| Max High Vulns | ${{ needs.lint.outputs.eff_max_high_vulns }} |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ "${{ steps.check-dockerfile.outputs.exists }}" != "true" ]; then
              echo "| Trivy | SKIP | No Dockerfile found |"
            else
              CRIT="${{ steps.trivy-parse.outputs.critical || 0 }}"
              HIGH="${{ steps.trivy-parse.outputs.high || 0 }}"
              MAX_CRIT="${{ needs.lint.outputs.eff_max_critical_vulns || 0 }}"
              MAX_HIGH="${{ needs.lint.outputs.eff_max_high_vulns || 0 }}"
              if [ "${CRIT:-0}" -le "${MAX_CRIT:-0}" ] && [ "${HIGH:-0}" -le "${MAX_HIGH:-0}" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Trivy | $STATUS | critical: ${CRIT:-0} (max ${MAX_CRIT:-0}), high: ${HIGH:-0} (max ${MAX_HIGH:-0}) |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Trivy Report
        if: always() && steps.check-dockerfile.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}trivy-report
          path: ${{ github.workspace }}/trivy-report.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: ignore

      - name: Enforce Trivy Thresholds
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          CRIT="${{ steps.trivy-parse.outputs.critical || 0 }}"
          HIGH="${{ steps.trivy-parse.outputs.high || 0 }}"
          MAX_CRITICAL="${{ needs.lint.outputs.eff_max_critical_vulns || 0 }}"
          MAX_HIGH="${{ needs.lint.outputs.eff_max_high_vulns || 0 }}"
          if [ "$CRIT" -gt "$MAX_CRITICAL" ]; then
            echo "::error::Trivy critical findings ($CRIT) exceed max_critical_vulns $MAX_CRITICAL"
            exit 1
          fi
          if [ "$HIGH" -gt "$MAX_HIGH" ]; then
            echo "::error::Trivy high findings ($HIGH) exceed max_high_vulns $MAX_HIGH"
            exit 1
          fi

          # CVSS-based enforcement (parity with Java OWASP)
          CVSS_THRESHOLD="${{ needs.lint.outputs.eff_owasp_cvss_fail }}"
          REPORT="${{ github.workspace }}/trivy-report.json"
          if [ -f "$REPORT" ]; then
            MAX_CVSS=$(jq '
              [.Results[]?.Vulnerabilities[]?.CVSS | to_entries[]?.value |
               (.V3Score // .V2Score // 0)] | max // 0
            ' "$REPORT" 2>/dev/null || echo 0)

            # Default to 0 if empty to avoid awk errors
            MAX_CVSS="${MAX_CVSS:-0}"

            if awk "BEGIN {exit !($MAX_CVSS >= $CVSS_THRESHOLD)}"; then
              echo "::error::Trivy found vulnerability with CVSS $MAX_CVSS >= threshold $CVSS_THRESHOLD"
              exit 1
            fi
          fi

  # ============================================================================
  # Docker Build & Test
  # ============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    if: always() && inputs.run_docker
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        id: docker-build
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t ${{ github.repository }}:ci-test .
          fi

      - name: Test Docker Image
        id: docker-test
        run: |
          if [ -f "Dockerfile" ]; then
            echo "Docker image built successfully"
            docker images | grep ci-test
          fi

      - name: Docker Summary
        if: always()
        run: |
          {
            echo "## Docker Build Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Container | Docker | ${{ inputs.run_docker }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"

            if [ ! -f "Dockerfile" ]; then
              echo "| Docker | SKIP | No Dockerfile found |"
            else
              BUILD_STATUS="${{ steps.docker-build.outcome }}"
              TEST_STATUS="${{ steps.docker-test.outcome }}"
              if [ "$BUILD_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ]; then
                STATUS="PASS"
              else
                STATUS="FAIL"
              fi
              echo "| Docker | $STATUS | build: ${BUILD_STATUS:-unknown}, test: ${TEST_STATUS:-unknown} |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # CodeQL
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: inputs.run_codeql
    permissions:
      security-events: write
    defaults:
      run:
        working-directory: ${{ inputs.workdir }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7
        with:
          languages: python
          # Scope analysis to workdir only
          source-root: ${{ inputs.workdir }}

      - name: Perform CodeQL Analysis
        id: codeql-analyze
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7

      - name: CodeQL Summary
        if: always()
        run: |
          {
            echo "## CodeQL Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Security | CodeQL | ${{ inputs.run_codeql }} |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            OUTCOME="${{ steps.codeql-analyze.outcome }}"
            if [ "$OUTCOME" = "success" ]; then
              STATUS="PASS"
            else
              STATUS="FAIL"
            fi
            echo "| CodeQL | $STATUS | outcome: ${OUTCOME:-unknown} (see Security tab) |"
          } >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Generate Report
  # ============================================================================
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [lint, test, security, typecheck, mutation-test, semgrep, trivy]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        if: always()
        continue-on-error: true
        with:
          path: all-reports/

      - name: Generate Combined Report
        run: |
          # Extract vulnerability counts from pip-audit report
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MEDIUM_VULNS=0
          PIP_AUDIT_VULNS=0

          PIP_AUDIT_REPORT=$(find all-reports -name "pip-audit-report.json" 2>/dev/null | head -1)
          if [ -n "$PIP_AUDIT_REPORT" ] && [ -f "$PIP_AUDIT_REPORT" ]; then
            # pip-audit uses "vulnerabilities" array with "id" and "fix_versions"
            # Count vulnerabilities - pip-audit doesn't provide severity in older versions
            PIP_AUDIT_VULNS=$(jq '[.dependencies[]?.vulnerabilities[]?] | length' "$PIP_AUDIT_REPORT" 2>/dev/null || echo 0)
            # For now, treat all pip-audit findings as HIGH since severity not always present
            HIGH_VULNS=$PIP_AUDIT_VULNS
          fi

          # Extract Trivy vulnerability counts if available
          TRIVY_REPORT=$(find all-reports -name "trivy-report.json" 2>/dev/null | head -1)
          if [ -n "$TRIVY_REPORT" ] && [ -f "$TRIVY_REPORT" ]; then
            TRIVY_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            TRIVY_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' "$TRIVY_REPORT" 2>/dev/null || echo 0)
            # Add Trivy counts to totals
            CRITICAL_VULNS=$((CRITICAL_VULNS + TRIVY_CRITICAL))
            HIGH_VULNS=$((HIGH_VULNS + TRIVY_HIGH))
            MEDIUM_VULNS=$((MEDIUM_VULNS + TRIVY_MEDIUM))
          fi

          cat > report.json << EOF
          {
            "schema_version": "2.0",
            "metadata": {
              "workflow_version": "v1.0.0",
              "workflow_ref": "${{ github.repository }}/.github/workflows/python-ci.yml@${{ github.ref_name }}",
              "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            },
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "hub_correlation_id": "${{ inputs.hub_correlation_id }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "python_version": "${{ inputs.python_version }}",
            "results": {
              "test": "${{ needs.test.outputs.status }}",
              "coverage": ${{ needs.test.outputs.coverage || 0 }},
              "mutation_score": ${{ needs.mutation-test.outputs.score || 0 }},
              "tests_passed": ${{ needs.test.outputs.tests_passed || 0 }},
              "tests_failed": ${{ needs.test.outputs.tests_failed || 0 }},
              "critical_vulns": ${CRITICAL_VULNS},
              "high_vulns": ${HIGH_VULNS},
              "medium_vulns": ${MEDIUM_VULNS}
            },
            "tool_metrics": {
              "ruff_errors": ${{ needs.lint.outputs.ruff_errors || 0 }},
              "mypy_errors": ${{ needs.typecheck.outputs.errors || 0 }},
              "bandit_high": ${{ needs.lint.outputs.bandit_high || 0 }},
              "bandit_medium": ${{ needs.lint.outputs.bandit_medium || 0 }},
              "black_issues": ${{ needs.lint.outputs.black_issues || 0 }},
              "isort_issues": ${{ needs.lint.outputs.isort_issues || 0 }},
              "pip_audit_vulns": ${PIP_AUDIT_VULNS},
              "semgrep_findings": ${{ needs.semgrep.outputs.findings || 0 }},
              "trivy_critical": ${{ needs.trivy.outputs.critical || 0 }},
              "trivy_high": ${{ needs.trivy.outputs.high || 0 }}
            },
            "tools_configured": {
              "pytest": ${{ inputs.run_pytest }},
              "ruff": ${{ inputs.run_ruff }},
              "bandit": ${{ inputs.run_bandit }},
              "pip_audit": ${{ inputs.run_pip_audit }},
              "mypy": ${{ inputs.run_mypy }},
              "hypothesis": ${{ inputs.run_hypothesis }},
              "black": ${{ inputs.run_black }},
              "isort": ${{ inputs.run_isort }},
              "mutmut": ${{ inputs.run_mutmut }},
              "semgrep": ${{ inputs.run_semgrep }},
              "trivy": ${{ inputs.run_trivy }},
              "docker": ${{ inputs.run_docker }},
              "codeql": ${{ inputs.run_codeql }}
            },
            "tools_ran": {
              "pytest": ${{ inputs.run_pytest == true && needs.test.result != 'skipped' }},
              "ruff": ${{ inputs.run_ruff == true && needs.lint.result != 'skipped' }},
              "bandit": ${{ inputs.run_bandit == true && needs.security.result != 'skipped' }},
              "pip_audit": ${{ inputs.run_pip_audit == true && needs.security.result != 'skipped' }},
              "mypy": ${{ inputs.run_mypy == true && needs.typecheck.result != 'skipped' }},
              "hypothesis": ${{ inputs.run_hypothesis == true && needs.test.result != 'skipped' }},
              "black": ${{ inputs.run_black == true && needs.lint.result != 'skipped' }},
              "isort": ${{ inputs.run_isort == true && needs.lint.result != 'skipped' }},
              "mutmut": ${{ inputs.run_mutmut == true && needs.mutation-test.result != 'skipped' }},
              "semgrep": ${{ inputs.run_semgrep == true && needs.semgrep.result != 'skipped' }},
              "trivy": ${{ inputs.run_trivy == true && needs.trivy.result != 'skipped' }},
              "docker": ${{ inputs.run_docker == true }},
              "codeql": ${{ inputs.run_codeql == true }}
            },
            "tools_success": {
              "pytest": ${{ inputs.run_pytest == true && needs.test.result == 'success' }},
              "ruff": ${{ inputs.run_ruff == true && needs.lint.result == 'success' }},
              "bandit": ${{ inputs.run_bandit == true && needs.security.result == 'success' }},
              "pip_audit": ${{ inputs.run_pip_audit == true && needs.security.result == 'success' }},
              "mypy": ${{ inputs.run_mypy == true && needs.typecheck.result == 'success' }},
              "hypothesis": ${{ inputs.run_hypothesis == true && needs.test.result == 'success' }},
              "black": ${{ inputs.run_black == true && needs.lint.result == 'success' }},
              "isort": ${{ inputs.run_isort == true && needs.lint.result == 'success' }},
              "mutmut": ${{ inputs.run_mutmut == true && needs.mutation-test.result == 'success' }},
              "semgrep": ${{ inputs.run_semgrep == true && needs.semgrep.result == 'success' }},
              "trivy": ${{ inputs.run_trivy == true && needs.trivy.result == 'success' }},
              "docker": ${{ inputs.run_docker == true }},
              "codeql": ${{ inputs.run_codeql == true }}
            }
          }
          EOF

          cat report.json

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: report.json
          retention-days: ${{ inputs.retention_days }}

      - name: Report Summary
        if: always()
        run: |
          {
            echo "## Report Summary"
            echo ""
            echo "### Configuration"
            echo "| Category | Tool | Enabled |"
            echo "|----------|------|---------|"
            echo "| Reporting | ci-report | true |"
            echo ""
            echo "### Thresholds"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| N/A | N/A |"
            echo ""
            echo "### Environment"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| Python Version | ${{ inputs.python_version }} |"
            WORKDIR="${{ inputs.workdir }}"
            if [ "$WORKDIR" = "." ] || [ -z "$WORKDIR" ]; then
              echo "| Working Directory | \`.\` (repo root) |"
            else
              echo "| Working Directory | \`$WORKDIR\` |"
            fi
            echo "| Artifact Retention | ${{ inputs.retention_days }} days |"
            PREFIX="${{ inputs.artifact_prefix }}"
            if [ -n "$PREFIX" ]; then
              echo "| Artifact Prefix | \`$PREFIX\` |"
            fi
            echo ""
            echo "### Results"
            echo "| Tool | Status | Details |"
            echo "|------|--------|---------|"
            if [ -f "report.json" ]; then
              STATUS="PASS"
              DETAILS="report.json generated"
            else
              STATUS="FAIL"
              DETAILS="report.json missing"
            fi
            echo "| ci-report | $STATUS | $DETAILS |"
          } >> "$GITHUB_STEP_SUMMARY"
