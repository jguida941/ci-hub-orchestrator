# ============================================================================
# CI/CD Hub - Reusable Python CI Workflow (CLI-driven)
# ============================================================================
# Call this workflow from any Python repository to run the full CI pipeline.
# It installs cihub from the hub repo and executes `cihub ci`.
#
# Usage in your repo's workflow:
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@main
#       with:
#         python_version: '3.12'
#       secrets: inherit
# ============================================================================

name: Python CI Pipeline

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # ---- Python Settings ----
      python_version:
        description: 'Python version'
        type: string
        default: '3.12'

      # ---- Tool Toggles ----
      run_pytest:
        description: 'Run pytest with coverage'
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit security scanner'
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit dependency check'
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy type checker'
        type: boolean
        default: false
      run_black:
        description: 'Run Black format checker'
        type: boolean
        default: true
      run_isort:
        description: 'Run isort import checker'
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        type: boolean
        default: true
      run_hypothesis:
        description: 'Run Hypothesis property-based testing'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      owasp_cvss_fail:
        description: 'CVSS score to fail on for Trivy (default: 7)'
        type: number
        default: 7
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_black_issues:
        description: 'Maximum allowed Black formatting issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_isort_issues:
        description: 'Maximum allowed isort import issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_ruff_errors:
        description: 'Maximum allowed Ruff errors (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''

    secrets:
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.ci.outputs.build_status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.ci.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.ci.outputs.mutation_score }}

jobs:
  ci:
    name: Python CI (cihub)
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.report.outputs.build_status }}
      coverage: ${{ steps.report.outputs.coverage }}
      mutation_score: ${{ steps.report.outputs.mutation_score }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Resolve hub ref
        id: hub-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          repo="${GITHUB_WORKFLOW_REF%%/.github/*}"
          if [ -z "$repo" ] || [ "$repo" = "$GITHUB_WORKFLOW_REF" ]; then
            repo="jguida941/ci-cd-hub"
          fi
          if [ -z "$ref" ] || [ "$ref" = "$GITHUB_WORKFLOW_REF" ]; then
            ref="main"
          fi
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout hub repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ steps.hub-ref.outputs.repo }}
          ref: ${{ steps.hub-ref.outputs.ref }}
          path: hub
          persist-credentials: false

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install cihub + tools
        run: |
          python -m pip install --upgrade pip
          pip install -e "hub[ci]"

      - name: Install project dependencies
        run: |
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "requirements-dev.txt" ]; then pip install -r requirements-dev.txt; fi
          if [ -f "pyproject.toml" ]; then
            pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true
          fi

      - name: Run cihub ci
        run: |
          cihub ci \
            --workdir "${{ inputs.workdir }}" \
            --correlation-id "${{ inputs.hub_correlation_id }}" \
            --output-dir .cihub

      - name: Read report outputs
        id: report
        run: |
          python << 'PY'
          import json
          import os

          report = json.load(open(".cihub/report.json", encoding="utf-8"))
          results = report.get("results", {})
          tools = report.get("tools_configured", {})
          tests_failed = int(results.get("tests_failed", 0))

          if tools.get("pytest"):
              status = "success" if tests_failed == 0 else "failure"
          else:
              status = "skipped"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"build_status={status}\n")
              handle.write(f"coverage={results.get('coverage', 0)}\n")
              handle.write(f"mutation_score={results.get('mutation_score', 0)}\n")
          PY

      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/tool-outputs/*.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: warn
