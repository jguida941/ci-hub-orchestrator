# ============================================================================
# CI/CD Hub - Python CI Workflow
# ============================================================================
#
# Reusable workflow with boolean toggles for Python linting, testing, and
# security scanning. Configure tools via .ci-hub.yml, run via `cihub ci`.
#
# HOW IT WORKS:
#   1. Your repo calls this workflow via `uses:`
#   2. This workflow installs and runs `cihub ci`
#   3. cihub reads YOUR .ci-hub.yml config file
#   4. Tools execute based on YOUR enabled: true/false toggles
#   5. Report + summary written to .cihub/ directory
#
# CONFIGURATION:
#   - Tool toggles and thresholds live in .ci-hub.yml.
#   - See docs/reference/CONFIG.md for the generated, authoritative fields.
#
# QUICK START WITH PROFILES (hub-side config):
#   Use a pre-built profile to generate hub configs:
#     cihub new myrepo --profile python-minimal   # pytest + ruff only (~2-5 min)
#     cihub new myrepo --profile python-quality   # All core tools (~15-30 min)
#     cihub new myrepo --profile python-security  # + semgrep, trivy, codeql
#
# THRESHOLDS:
#   - Defined in .ci-hub.yml under thresholds; see CONFIG.md for details.
#
# CALLER EXAMPLE (minimal - config lives in .ci-hub.yml):
#   # .github/workflows/hub-ci.yml
#   jobs:
#     ci:
#       uses: jguida941/ci-cd-hub/.github/workflows/python-ci.yml@v1
#       secrets: inherit
#
# INSTALL: Tools are installed from the hub repo via `pip install -e "hub[ci]"`
#          (PyPI distribution is planned; see ADR-0033).
#
# ============================================================================

name: Python CI Pipeline

permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      # ---- Python Settings ----
      python_version:
        description: 'Python version'
        type: string
        default: '3.12'

      # ---- Tool Toggles ----
      run_pytest:
        description: 'Run pytest with coverage'
        type: boolean
        default: true
      run_ruff:
        description: 'Run Ruff linter'
        type: boolean
        default: true
      run_bandit:
        description: 'Run Bandit security scanner'
        type: boolean
        default: true
      run_pip_audit:
        description: 'Run pip-audit dependency check'
        type: boolean
        default: true
      run_mypy:
        description: 'Run mypy type checker'
        type: boolean
        default: false
      run_black:
        description: 'Run Black format checker'
        type: boolean
        default: true
      run_isort:
        description: 'Run isort import checker'
        type: boolean
        default: true
      run_mutmut:
        description: 'Run mutmut mutation testing'
        type: boolean
        default: true
      run_hypothesis:
        description: 'Run Hypothesis property-based testing'
        type: boolean
        default: true
      run_semgrep:
        description: 'Run Semgrep SAST (expensive)'
        type: boolean
        default: false
      run_sbom:
        description: 'Generate SBOM (expensive)'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan (expensive)'
        type: boolean
        default: false
      run_docker:
        description: 'Build and test Docker'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis (expensive)'
        type: boolean
        default: false
      workdir:
        description: 'Working directory (monorepo subfolder, default repo root)'
        type: string
        default: '.'

      # ---- Thresholds ----
      coverage_min:
        description: 'Minimum coverage percentage'
        type: number
        default: 70
      mutation_score_min:
        description: 'Minimum mutation score'
        type: number
        default: 70
      max_critical_vulns:
        description: 'Maximum allowed critical vulnerabilities across scanners'
        type: number
        default: 0
      max_high_vulns:
        description: 'Maximum allowed high vulnerabilities across scanners'
        type: number
        default: 0
      trivy_cvss_fail:
        description: 'CVSS score to fail on for Trivy (default: 7)'
        type: number
        default: 7
      owasp_cvss_fail:
        description: 'Legacy alias for trivy_cvss_fail (default: 7)'
        type: number
        default: 7
      max_semgrep_findings:
        description: 'Maximum allowed Semgrep findings (default: 0 = fail on any)'
        type: number
        default: 0
      max_black_issues:
        description: 'Maximum allowed Black formatting issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_isort_issues:
        description: 'Maximum allowed isort import issues (default: 0 = fail on any)'
        type: number
        default: 0
      max_ruff_errors:
        description: 'Maximum allowed Ruff errors (default: 0 = fail on any)'
        type: number
        default: 0

      # ---- Reports ----
      retention_days:
        description: 'Artifact retention days'
        type: number
        default: 30
      artifact_prefix:
        description: 'Prefix for artifact names (use when calling multiple times in same workflow)'
        type: string
        default: ''
      hub_correlation_id:
        description: 'Correlation ID from hub orchestrator for run matching'
        type: string
        default: ''
      hub_repo:
        description: 'Override hub repo (owner/name) for installing cihub'
        type: string
        default: ''
      hub_ref:
        description: 'Override hub ref (tag/sha/branch) for installing cihub'
        type: string
        default: ''
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        type: boolean
        default: true

    secrets:
      CODECOV_TOKEN:
        required: false

    outputs:
      build_status:
        description: 'Build result'
        value: ${{ jobs.ci.outputs.build_status }}
      coverage:
        description: 'Coverage percentage'
        value: ${{ jobs.ci.outputs.coverage }}
      mutation_score:
        description: 'Mutation score'
        value: ${{ jobs.ci.outputs.mutation_score }}

jobs:
  ci:
    name: Python CI (cihub)
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.report.outputs.build_status }}
      coverage: ${{ steps.report.outputs.coverage }}
      mutation_score: ${{ steps.report.outputs.mutation_score }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Checkout hub repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.hub_repo }}
          ref: ${{ inputs.hub_ref }}
          path: hub
          persist-credentials: false

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install cihub + tools
        run: pip install -e "hub[ci]"

      - name: Install Trivy
        if: ${{ inputs.run_trivy }}
        run: cihub hub-ci trivy-install --dest .cihub/tools --github-path

      - name: Initialize CodeQL
        if: ${{ inputs.run_codeql }}
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          languages: python
          source-root: ${{ inputs.workdir }}

      - name: Analyze CodeQL
        if: ${{ inputs.run_codeql }}
        id: codeql_analyze
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          category: "/language:python"

      - name: Run cihub ci
        env:
          WORKDIR: ${{ inputs.workdir }}
          CORRELATION_ID: ${{ inputs.hub_correlation_id }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary }}
          CIHUB_RUN_PYTEST: ${{ inputs.run_pytest }}
          CIHUB_RUN_RUFF: ${{ inputs.run_ruff }}
          CIHUB_RUN_BANDIT: ${{ inputs.run_bandit }}
          CIHUB_RUN_PIP_AUDIT: ${{ inputs.run_pip_audit }}
          CIHUB_RUN_MYPY: ${{ inputs.run_mypy }}
          CIHUB_RUN_BLACK: ${{ inputs.run_black }}
          CIHUB_RUN_ISORT: ${{ inputs.run_isort }}
          CIHUB_RUN_MUTMUT: ${{ inputs.run_mutmut }}
          CIHUB_RUN_HYPOTHESIS: ${{ inputs.run_hypothesis }}
          CIHUB_RUN_SEMGREP: ${{ inputs.run_semgrep }}
          CIHUB_RUN_SBOM: ${{ inputs.run_sbom }}
          CIHUB_RUN_TRIVY: ${{ inputs.run_trivy }}
          CIHUB_RUN_CODEQL: ${{ inputs.run_codeql }}
          CIHUB_RUN_DOCKER: ${{ inputs.run_docker }}
          CIHUB_CODEQL_RAN: ${{ inputs.run_codeql }}
          CIHUB_CODEQL_SUCCESS: ${{ steps.codeql_analyze.outcome == 'success' }}
        run: cihub ci --workdir "$WORKDIR" --correlation-id "$CORRELATION_ID" --output-dir .cihub --install-deps

      - name: Read report outputs
        id: report
        run: cihub report outputs --report .cihub/report.json

      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ inputs.artifact_prefix }}ci-report
          path: |
            .cihub/report.json
            .cihub/summary.md
            .cihub/sbom*.json
            .cihub/tool-outputs/*.json
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: warn
