{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/jguida941/ci-cd-hub/schema/ci-hub-config.schema.json",
  "title": "CI/CD Hub Repository Configuration",
  "description": "Schema for .ci-hub.yml files in connected repositories",
  "type": "object",
  "additionalProperties": false,
  "required": ["repo", "language"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Config schema version",
      "default": "1.0"
    },
    "extra_tests": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "name": { "type": "string" },
          "command": { "type": "string" }
        },
        "required": ["name", "command"]
      }
    },
    "repo": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "owner": { "type": "string" },
        "name": { "type": "string" },
        "language": { "type": "string" },
        "default_branch": { "type": "string", "default": "main" },
        "subdir": { "type": "string", "description": "Optional subdirectory within the repo", "pattern": "^(?!/)(?!.*\\.\\.).+$" },
        "dispatch_enabled": { "type": "boolean", "description": "Allow orchestrator dispatch (default true)", "default": true },
        "dispatch_workflow": { "type": "string", "description": "Workflow file to dispatch to (e.g., java-ci-dispatch.yml)", "default": "" },
        "run_group": { "type": "string", "description": "Grouping label for selective runs (e.g., full, fixtures, smoke)", "default": "full", "enum": ["full", "fixtures", "smoke", "security", "compliance"] }
      },
      "required": ["owner", "name"]
    },
    "language": {
      "type": "string",
      "enum": ["java", "python", "node", "go"],
      "description": "Primary language of the repository"
    },
    "java": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "version": {
          "type": "string",
          "default": "21"
        },
        "distribution": {
          "type": "string",
          "enum": ["temurin", "corretto", "zulu", "microsoft"],
          "default": "temurin"
        },
        "build_tool": {
          "type": "string",
          "enum": ["maven", "gradle"],
          "default": "maven"
        },
        "tools": {
          "$ref": "#/definitions/javaTools"
        }
      }
    },
    "python": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "version": {
          "type": "string",
          "default": "3.12"
        },
        "tools": {
          "$ref": "#/definitions/pythonTools"
        }
      }
    },
    "thresholds": {
      "$ref": "#/definitions/thresholds"
    },
    "reports": {
      "$ref": "#/definitions/reports"
    },
    "notifications": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "slack": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "on_failure": { "type": "boolean", "default": true },
            "on_success": { "type": "boolean", "default": false }
          }
        },
        "email": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false }
          }
        }
      }
    },
    "cache_sentinel": { "type": "object", "additionalProperties": true },
    "canary": { "type": "object", "additionalProperties": true },
    "chaos": { "type": "object", "additionalProperties": true },
    "dr_drill": { "type": "object", "additionalProperties": true },
    "runner_isolation": { "type": "object", "additionalProperties": true },
    "supply_chain": { "type": "object", "additionalProperties": true },
    "egress_control": { "type": "object", "additionalProperties": true },
    "telemetry": { "type": "object", "additionalProperties": true },
    "kyverno": { "type": "object", "additionalProperties": true }
  },
  "allOf": [
    {
      "if": { "properties": { "language": { "const": "java" } } },
      "then": { "required": ["java"] }
    },
    {
      "if": { "properties": { "language": { "const": "python" } } },
      "then": { "required": ["python"] }
    }
  ],
  "definitions": {
    "javaTools": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "jacoco": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "min_coverage": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 }
          }
        },
        "checkstyle": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_violation": { "type": "boolean", "default": true },
            "config_file": { "type": ["string", "null"] }
          }
        },
        "spotbugs": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_error": { "type": "boolean", "default": true },
            "effort": { "type": "string", "enum": ["min", "default", "max"], "default": "max" },
            "threshold": { "type": "string", "enum": ["low", "medium", "high"], "default": "medium" }
          }
        },
        "owasp": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_cvss": { "type": "integer", "minimum": 0, "maximum": 10, "default": 7 },
            "nvd_api_key_required": { "type": "boolean", "default": false }
          }
        },
        "pitest": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "min_mutation_score": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 },
            "threads": { "type": "integer", "default": 4 },
            "timeout_multiplier": { "type": "integer", "default": 2 }
          }
        },
        "pmd": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_violation": { "type": "boolean", "default": false }
          }
        },
        "semgrep": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "fail_on_findings": { "type": "boolean", "default": false }
          }
        },
        "trivy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "fail_on_critical": { "type": "boolean", "default": false },
            "fail_on_high": { "type": "boolean", "default": false }
          }
        },
        "codeql": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "languages": { "type": "array", "items": { "type": "string" }, "default": ["java"] }
          }
        },
        "docker": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "compose_file": { "type": "string", "default": "docker-compose.yml" },
            "dockerfile": { "type": "string", "default": "Dockerfile" },
            "health_endpoint": { "type": "string", "default": "/actuator/health" },
            "health_timeout": { "type": "integer", "default": 300 }
          }
        }
      }
    },
    "pythonTools": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pytest": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "min_coverage": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 },
            "fail_fast": { "type": "boolean", "default": false }
          }
        },
        "ruff": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_error": { "type": "boolean", "default": true }
          }
        },
        "bandit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_high": { "type": "boolean", "default": true }
          }
        },
        "pip_audit": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_vuln": { "type": "boolean", "default": true }
          }
        },
        "mypy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false }
          }
        },
        "black": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_format_issues": { "type": "boolean", "default": false }
          }
        },
        "isort": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_on_issues": { "type": "boolean", "default": false }
          }
        },
        "mutmut": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "min_mutation_score": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 },
            "timeout_minutes": { "type": "integer", "default": 15 },
            "min_score": { "type": "integer", "minimum": 0, "maximum": 100, "default": 0 }
          }
        },
        "sbom": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "format": { "type": "string", "default": "cyclonedx" }
          }
        },
        "hypothesis": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true }
          }
        },
        "semgrep": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "fail_on_findings": { "type": "boolean", "default": false }
          }
        },
        "trivy": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "fail_on_critical": { "type": "boolean", "default": false },
            "fail_on_high": { "type": "boolean", "default": false }
          }
        },
        "codeql": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false },
            "languages": { "type": "array", "items": { "type": "string" }, "default": ["python"] }
          }
        },
        "docker": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": false }
          }
        }
      }
    },
    "thresholds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "coverage_min": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 },
        "mutation_score_min": { "type": "integer", "minimum": 0, "maximum": 100, "default": 70 },
        "max_critical_vulns": { "type": "integer", "minimum": 0, "maximum": 1000, "default": 0 },
        "max_high_vulns": { "type": "integer", "minimum": 0, "maximum": 1000, "default": 0 }
      }
    },
    "reports": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "retention_days": { "type": "integer", "minimum": 1, "maximum": 365, "default": 30 },
        "badges": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "branch": { "type": "string", "default": "main" }
          }
        },
        "codecov": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "fail_ci_on_error": { "type": "boolean", "default": false }
          }
        },
        "github_summary": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "include_metrics": { "type": "boolean", "default": true }
          }
        }
      }
    }
  }
}
