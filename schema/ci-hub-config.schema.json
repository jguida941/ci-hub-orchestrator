{
  "$id": "https://github.com/jguida941/ci-cd-hub/schema/ci-hub-config.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": {
          "language": {
            "const": "java"
          }
        }
      },
      "then": {
        "required": [
          "java"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "language": {
            "const": "python"
          }
        }
      },
      "then": {
        "required": [
          "python"
        ]
      }
    }
  ],
  "definitions": {
    "hubCi": {
      "additionalProperties": false,
      "description": "Configuration for hub's own CI pipeline (hub-production-ci.yml)",
      "properties": {
        "enabled": {
          "default": true,
          "type": "boolean"
        },
        "thresholds": {
          "additionalProperties": false,
          "description": "Quality gate thresholds for hub CI",
          "properties": {
            "coverage_min": {
              "default": 70,
              "maximum": 100,
              "minimum": 0,
              "type": "integer"
            },
            "mutation_score_min": {
              "default": 70,
              "maximum": 100,
              "minimum": 0,
              "type": "integer"
            }
          },
          "type": "object"
        },
        "tools": {
          "additionalProperties": false,
          "description": "Tools enabled for hub-production-ci.yml",
          "properties": {
            "actionlint": {
              "default": true,
              "type": "boolean"
            },
            "bandit": {
              "default": true,
              "type": "boolean"
            },
            "dependency_review": {
              "default": true,
              "type": "boolean"
            },
            "gitleaks": {
              "default": true,
              "type": "boolean"
            },
            "license_check": {
              "default": true,
              "type": "boolean"
            },
            "mutmut": {
              "default": true,
              "type": "boolean"
            },
            "mypy": {
              "default": true,
              "type": "boolean"
            },
            "pip_audit": {
              "default": true,
              "type": "boolean"
            },
            "pytest": {
              "default": true,
              "type": "boolean"
            },
            "ruff": {
              "default": true,
              "type": "boolean"
            },
            "scorecard": {
              "default": true,
              "type": "boolean"
            },
            "syntax": {
              "default": true,
              "type": "boolean"
            },
            "trivy": {
              "default": true,
              "type": "boolean"
            },
            "validate_configs": {
              "default": true,
              "type": "boolean"
            },
            "validate_templates": {
              "default": true,
              "type": "boolean"
            },
            "verify_matrix_keys": {
              "default": true,
              "type": "boolean"
            },
            "yamllint": {
              "default": true,
              "type": "boolean"
            },
            "zizmor": {
              "default": true,
              "type": "boolean"
            }
          },
          "type": "object"
        }
      },
      "type": "object"
    },
    "javaTools": {
      "additionalProperties": false,
      "properties": {
        "checkstyle": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "config_file": { "type": ["string", "null"] },
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_violation": { "default": true, "type": "boolean" },
                "max_errors": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "codeql": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "languages": { "default": ["java"], "items": { "type": "string" }, "type": "array" }
              },
              "type": "object"
            }
          ]
        },
        "docker": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "compose_file": { "default": "docker-compose.yml", "type": "string" },
                "dockerfile": { "default": "Dockerfile", "type": "string" },
                "enabled": { "default": false, "type": "boolean" },
                "health_endpoint": { "default": "/actuator/health", "type": "string" },
                "health_timeout": { "default": 300, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "jacoco": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "min_coverage": { "default": 70, "maximum": 100, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "jqwik": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "owasp": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_cvss": { "default": 7, "maximum": 10, "minimum": 0, "type": "integer" },
                "use_nvd_api_key": { "default": true, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "pitest": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "min_mutation_score": { "default": 70, "maximum": 100, "minimum": 0, "type": "integer" },
                "threads": { "default": 4, "type": "integer" },
                "timeout_multiplier": { "default": 2, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "pmd": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_violation": { "default": false, "type": "boolean" },
                "max_violations": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "semgrep": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "fail_on_findings": { "default": false, "type": "boolean" },
                "max_findings": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "sbom": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "format": { "default": "cyclonedx", "type": "string" }
              },
              "type": "object"
            }
          ]
        },
        "spotbugs": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "effort": { "default": "max", "enum": ["min", "default", "max"], "type": "string" },
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_error": { "default": true, "type": "boolean" },
                "max_bugs": { "default": 0, "minimum": 0, "type": "integer" },
                "threshold": { "default": "medium", "enum": ["low", "medium", "high"], "type": "string" }
              },
              "type": "object"
            }
          ]
        },
        "trivy": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "fail_on_critical": { "default": false, "type": "boolean" },
                "fail_on_high": { "default": false, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        }
      },
      "type": "object"
    },
    "pythonTools": {
      "additionalProperties": false,
      "properties": {
        "bandit": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "default": true,
                  "type": "boolean"
                },
                "fail_on_high": {
                  "default": true,
                  "type": "boolean"
                }
              },
              "type": "object"
            }
          ]
        },
        "black": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "default": true,
                  "type": "boolean"
                },
                "fail_on_format_issues": {
                  "default": false,
                  "type": "boolean"
                },
                "max_issues": {
                  "default": 0,
                  "minimum": 0,
                  "type": "integer"
                }
              },
              "type": "object"
            }
          ]
        },
        "codeql": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "default": false,
                  "type": "boolean"
                },
                "languages": {
                  "default": ["python"],
                  "items": { "type": "string" },
                  "type": "array"
                }
              },
              "type": "object"
            }
          ]
        },
        "docker": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "hypothesis": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "isort": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_issues": { "default": false, "type": "boolean" },
                "max_issues": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "mutmut": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "min_mutation_score": { "default": 70, "maximum": 100, "minimum": 0, "type": "integer" },
                "min_score": { "default": 0, "maximum": 100, "minimum": 0, "type": "integer" },
                "timeout_minutes": { "default": 15, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "mypy": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "pip_audit": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_vuln": { "default": true, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        },
        "pytest": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_fast": { "default": false, "type": "boolean" },
                "min_coverage": { "default": 70, "maximum": 100, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "ruff": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": true, "type": "boolean" },
                "fail_on_error": { "default": true, "type": "boolean" },
                "max_errors": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "sbom": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "format": { "default": "cyclonedx", "type": "string" }
              },
              "type": "object"
            }
          ]
        },
        "semgrep": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "fail_on_findings": { "default": false, "type": "boolean" },
                "max_findings": { "default": 0, "minimum": 0, "type": "integer" }
              },
              "type": "object"
            }
          ]
        },
        "trivy": {
          "oneOf": [
            { "type": "boolean" },
            {
              "additionalProperties": false,
              "properties": {
                "enabled": { "default": false, "type": "boolean" },
                "fail_on_critical": { "default": false, "type": "boolean" },
                "fail_on_high": { "default": false, "type": "boolean" }
              },
              "type": "object"
            }
          ]
        }
      },
      "type": "object"
    },
    "reports": {
      "additionalProperties": false,
      "properties": {
        "badges": {
          "additionalProperties": false,
          "properties": {
            "branch": {
              "default": "main",
              "type": "string"
            },
            "enabled": {
              "default": true,
              "type": "boolean"
            }
          },
          "type": "object"
        },
        "codecov": {
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "default": true,
              "type": "boolean"
            },
            "fail_ci_on_error": {
              "default": false,
              "type": "boolean"
            }
          },
          "type": "object"
        },
        "github_summary": {
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "default": true,
              "type": "boolean"
            },
            "include_metrics": {
              "default": true,
              "type": "boolean"
            }
          },
          "type": "object"
        },
        "retention_days": {
          "default": 30,
          "maximum": 365,
          "minimum": 1,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "thresholds": {
      "additionalProperties": false,
      "properties": {
        "coverage_min": {
          "default": 70,
          "maximum": 100,
          "minimum": 0,
          "type": "integer"
        },
        "max_black_issues": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_checkstyle_errors": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_critical_vulns": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_high_vulns": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_isort_issues": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_pip_audit_vulns": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_pmd_violations": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_ruff_errors": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_semgrep_findings": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "max_spotbugs_bugs": {
          "default": 0,
          "maximum": 1000,
          "minimum": 0,
          "type": "integer"
        },
        "mutation_score_min": {
          "default": 70,
          "maximum": 100,
          "minimum": 0,
          "type": "integer"
        }
      },
      "type": "object"
    }
  },
  "description": "Schema for .ci-hub.yml files in connected repositories",
  "properties": {
    "cache_sentinel": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "canary": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "chaos": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "dr_drill": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "egress_control": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "extra_tests": {
      "items": {
        "additionalProperties": false,
        "properties": {
          "command": {
            "type": "string"
          },
          "name": {
            "type": "string"
          }
        },
        "required": [
          "name",
          "command"
        ],
        "type": "object"
      },
      "type": "array"
    },
    "hub_ci": {
      "$ref": "#/definitions/hubCi"
    },
    "java": {
      "additionalProperties": false,
      "properties": {
        "build_tool": {
          "default": "maven",
          "enum": [
            "maven",
            "gradle"
          ],
          "type": "string"
        },
        "distribution": {
          "default": "temurin",
          "enum": [
            "temurin",
            "corretto",
            "zulu",
            "microsoft"
          ],
          "type": "string"
        },
        "tools": {
          "$ref": "#/definitions/javaTools"
        },
        "version": {
          "default": "21",
          "type": "string"
        }
      },
      "type": "object"
    },
    "kyverno": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "language": {
      "description": "Primary language of the repository",
      "enum": [
        "java",
        "python",
        "node",
        "go"
      ],
      "type": "string"
    },
    "notifications": {
      "additionalProperties": false,
      "properties": {
        "email": {
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "default": false,
              "type": "boolean"
            },
            "recipients_env": {
              "default": "CIHUB_EMAIL_TO",
              "type": "string"
            },
            "smtp_from_env": {
              "default": "SMTP_FROM",
              "type": "string"
            },
            "smtp_host_env": {
              "default": "SMTP_HOST",
              "type": "string"
            },
            "smtp_password_env": {
              "default": "SMTP_PASSWORD",
              "type": "string"
            },
            "smtp_port_env": {
              "default": "SMTP_PORT",
              "type": "string"
            },
            "smtp_starttls_env": {
              "default": "SMTP_STARTTLS",
              "type": "string"
            },
            "smtp_user_env": {
              "default": "SMTP_USER",
              "type": "string"
            }
          },
          "type": "object"
        },
        "slack": {
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "default": false,
              "type": "boolean"
            },
            "on_failure": {
              "default": true,
              "type": "boolean"
            },
            "on_success": {
              "default": false,
              "type": "boolean"
            },
            "webhook_env": {
              "default": "CIHUB_SLACK_WEBHOOK_URL",
              "type": "string"
            }
          },
          "type": "object"
        }
      },
      "type": "object"
    },
    "python": {
      "additionalProperties": false,
      "properties": {
        "tools": {
          "$ref": "#/definitions/pythonTools"
        },
        "version": {
          "default": "3.12",
          "type": "string"
        }
      },
      "type": "object"
    },
    "repo": {
      "additionalProperties": false,
      "properties": {
        "default_branch": {
          "default": "main",
          "type": "string"
        },
        "dispatch_enabled": {
          "default": true,
          "description": "Allow orchestrator dispatch (default true)",
          "type": "boolean"
        },
        "dispatch_workflow": {
          "default": "hub-ci.yml",
          "description": "Workflow file to dispatch to (hub-ci.yml for single-language, hub-java-ci.yml or hub-python-ci.yml for monorepos)",
          "enum": [
            "hub-ci.yml",
            "hub-java-ci.yml",
            "hub-python-ci.yml",
            ""
          ],
          "type": "string"
        },
        "force_all_tools": {
          "default": false,
          "description": "Force-enable all tools for this repo (overrides tool.enabled toggles)",
          "type": "boolean"
        },
        "language": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "owner": {
          "type": "string"
        },
        "repo_side_execution": {
          "default": false,
          "description": "Enable workflow generation INTO target repos (opt-in, requires explicit --apply)",
          "type": "boolean"
        },
        "run_group": {
          "default": "full",
          "description": "Grouping label for selective runs (e.g., full, fixtures, smoke)",
          "enum": [
            "full",
            "fixtures",
            "smoke",
            "security",
            "compliance"
          ],
          "type": "string"
        },
        "subdir": {
          "description": "Optional subdirectory within the repo",
          "pattern": "^(?!/)(?!.*\\.\\.).+$",
          "type": "string"
        },
        "use_central_runner": {
          "default": true,
          "description": "Use central runner mode (hub clones and executes) vs distributed mode (dispatch to target repo workflow)",
          "type": "boolean"
        }
      },
      "required": [
        "owner",
        "name"
      ],
      "type": "object"
    },
    "reports": {
      "$ref": "#/definitions/reports"
    },
    "runner_isolation": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "supply_chain": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "telemetry": {
      "additionalProperties": true,
      "properties": {
        "enabled": {
          "default": false,
          "type": "boolean"
        }
      },
      "type": "object"
    },
    "thresholds": {
      "$ref": "#/definitions/thresholds"
    },
    "version": {
      "default": "1.0",
      "description": "Config schema version",
      "type": "string"
    }
  },
  "required": [
    "repo",
    "language"
  ],
  "title": "CI/CD Hub Repository Configuration",
  "type": "object"
}
